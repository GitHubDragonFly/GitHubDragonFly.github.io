<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="encoding" content="utf-8" charset="utf-8">
    <meta name="description" content="Quick O3DV based viewer">
    <meta name="viewport" content="width=device-width, user-scalable=no">
    <link rel="shortcut icon" href="../../images/favicon.ico" type="image/x-icon"/>

    <script src="https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/build/o3dv.min.js"></script>
    <script>
      // Set the external libraries location
      OV.SetExternalLibLocation( 'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/libs' );

      // Init all the 3d viewer elements.
      OV.Init3DViewerElements();
    </script>

    <style>
      body, html {
        position: relative;
        display: block;
        width: 100%;
        min-height: 100vh;
        background-color: black;
        border: none;
        padding: 0;
        margin: 0;
        overflow: hidden;
      }

      button {
        background-color: #d1cefc;
        border: 1px solid blue;
        -webkit-border-radius: 2px;
        border-radius: 2px;
        margin: 2px 2px 2px 0;
        min-width: 22px;
        height: 22px;
        padding: 1px;
        vertical-align: middle;
      }

      label { vertical-align: middle; height: 22px; margin: 2px 3px 2px 0; }

      input[type=file] {
        vertical-align: middle;
        margin: 2px 3px 2px 0;
        max-width: 175px;
      }

      input[type=text] { vertical-align: middle; margin: 2px 2px 2px 0; }

      p.full_screen {
        text-align: center;
        content: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABgAAAAYCAYAAADgdz34AAAACXBIWXMAAA7DAAAOwwHHb6hkAAAAf0lEQVRIie1VQQ6AMAjb/x9M4IRePICoK7GLB5eQbElpCTAY7j6YRiUPAvvxbNMkN76XIDhSRKCdjhmB494hzzwngcoBIa/eASgisMgTBo4ODqCTAiSFrW6Biv8LfL/I1DbtfDRV9VLgjVFhZp59A4g+7JaM6yULh7IyWUYX2AAPDxz26GjX+gAAAABJRU5ErkJggg==);
        margin: 1px 1px 1px 2px;
        padding: 0;
        width: 15px;
        height: 15px;
      }

      .fm { color: navy; width: 99.25%; border: 1px solid navy; -webkit-border-radius: 2px; border-radius: 2px; padding: 4px; margin: 1px; }

      .fixed-menu {
        position: fixed;
        z-index: 99999;
        display: inline-block;
        background-color: whitesmoke;
        margin: 0px;
        padding: 1px;
        width: 100%;
      }

      div.online_3d_viewer {
        z-index: 1;
        width: 100%;
        border: 1px solid blue;
      }
    </style>

    <!-- Using Online 3D Viewer as a base: https://github.com/kovacsv/Online3DViewer -->

    <title>Quick Viewer (O3DV)</title>
  </head>
  <body onload="reset();" onresize="resize();">
    <div id="fixed_menu" class="fixed-menu">
      <div class="fm">
        <label for="file" title="3DM, 3DS, 3MF, BIM, BREP, BRP, DAE, FBX, FCSTD, GLB, GLTF, IFC, IGES, IGS, OBJ + MTL, OFF, PLY, STL, STEP, STP, WRL" style="color: #553801; margin-left: 3px;">Model</label>
        <button id="btn_url" onclick="show_url()" style="background-color: transparent; min-width: 34px;">URL</button>
        <label for="file_input" title="File Input"></label>
        <input type="file" id="file_input" name="file" onchange="init()" accept=".3dm, .3ds, .3mf, .bim, .brep, .brp, .dae, .fbx, .fcstd, .glb, .gltf, .ifc, .iges, .igs, .mtl, .obj, .off, .ply, .stl, .step, .stp, .wrl, image/png, image/jpeg, image/bmp, image/gif" multiple />
        <button id="btn_full_screen" title="Full Screen" onclick="full_screen()" style="float: right; background-color: transparent; min-width: 24px;"><p class="full_screen"></p></button>
      </div>
      <div class="fm" id="url" style="display: none;">
        <label for="url_entry">URL:</label>
        <input type="text" id="url_entry" name="url_entry" value="" style="width: 85%;" />
        <button onclick="load_url_file()" style="width: 50px;">Load</button>
        <button onclick="clear_url()" style="width: 50px;">Clear</button>
      </div>
      <div class="online_3d_viewer" id="o3dv_element" style="width: 99.75%; height: 95vh;"
        model="https://raw.githubusercontent.com/GitHubDragonFly/GitHubDragonFly.github.io/main/viewers/examples/legobrick.dae"
        environmentmap="
        https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/posx.jpg,
        https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/negx.jpg,
        https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/posy.jpg,
        https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/negy.jpg,
        https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/posz.jpg,
        https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/negz.jpg">
      </div>
    </div>

    <script>
      const model_extensions = [ '.3DM', '.3DS', '.3MF', '.BIM', '.BREP', '.BRP', '.DAE', '.FBX', '.FCSTD', '.GLB', '.GLTF', '.IFC', '.IGES', '.IGS', '.MTL', '.OBJ', '.OFF', '.PLY', '.STL', '.STEP', '.STP', '.WRL' ];
      const image_extensions = [ '.PNG', '.JPEG', '.JPG', '.JFIF', '.PJPEG', '.PJP', '.BMP', '.GIF' ];
      const textureNames = [
        'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/posx.jpg',
        'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/negx.jpg',
        'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/posy.jpg',
        'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/negy.jpg',
        'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/posz.jpg',
        'https://cdn.jsdelivr.net/npm/online-3d-viewer@0.8.22/website/assets/envmaps/fishermans_bastion/negz.jpg'
      ];
      const backgroundIsEnvMap = false;

      function show_url() {
        if (url_displayed === true) {
          document.getElementById('url').style.display = 'none';
          url_displayed = false;
        } else {
          document.getElementById('url').style.display = 'block';
          url_displayed = true;
        }
      }

      function load_url_file() {
        let url = document.getElementById('url_entry').value.trim();
        if (url !== '') {
          selected_url_file = url;
          url_loading = true;
          init();
        }
      }

      function clear_url() { document.getElementById('url_entry').value = ''; }

      function reset() { document.getElementById('file_input').value = ''; document.getElementById('url_entry').value = ''; }

      function resize() {
        if (window.fullScreen || document.fullscreenElement || document.mozFullScreenElement || document.msFullscreenElement || document.webkitFullscreenElement) {
          document.getElementById('btn_full_screen').style.backgroundColor = '#FFFF00';
        } else {
          document.getElementById('btn_full_screen').style.backgroundColor = 'transparent';
        }
      }

      function full_screen() {
        if (document.fullscreenEnabled) {
          document.fullscreenElement ? document.exitFullscreen() : document.body.requestFullscreen();
        } else if (document.mozFullScreenEnabled) {
          document.mozFullScreenElement ? document.mozCancelFullScreen() : document.body.mozRequestFullScreen();
        } else if (document.msFullscreenEnabled) {
          document.msFullscreenElement ? document.msExitFullscreen() : document.body.msRequestFullscreen();
        } else if (document.webkitFullscreenEnabled) {
          document.webkitFullscreenElement ? document.webkitExitFullscreen() : document.body.webkitRequestFullscreen();
        } else if (window.fullScreen) {
          // Do nothing. This fullscreen mode was triggered with F11 key press and requires the same again.
        }
      }
    </script>

    <script>
      var local_files, url_files, selected_model_file, selected_url_file = '', selected_url_model_file, url_displayed = false, url_loading = false;

      function init() {
        if (url_loading === false) {
          selected_model_file = null;
          selected_url_file = '';
          local_files = [];

          // Loaded files
          var fi = document.getElementById('file_input');

          for (let i = 0; i < fi.files.length; i++) {
            if (fi.files[ i ].type !== '' && fi.files[ i ].type.startsWith('image/')) {
              local_files.push( fi.files[ i ] );
            } else if (fi.files[ i ].name.indexOf( '.' ) > -1 && model_extensions.includes( fi.files[ i ].name.toUpperCase().substring( fi.files[ i ].name.lastIndexOf( '.' ) ))) {
              selected_model_file = fi.files[ i ];
              local_files.push( fi.files[ i ] );
            }
          };

          if (selected_model_file === null) {
            console.log( 'No valid model file selected!' );
            return;
          }
        } else {
          selected_url_model_file = null;
          selected_model_file = null;
          url_loading = false;
          url_files = [];

          // Reset the file input
          document.getElementById('file_input').value = '';
        }

        // Load the model
        selected_model_file !== null ? loadFile() : loadURLFile();
      }

      function loadFile() {
        let element = document.getElementById('o3dv_element');
        element.innerHTML = '';
        let o3dv_embedded_viewer = new OV.EmbeddedViewer( element, { environmentSettings: new OV.EnvironmentSettings( textureNames, backgroundIsEnvMap ) } );
        o3dv_embedded_viewer.LoadModelFromFileList( local_files );
      }

      function loadURLFile() {
        if (selected_url_file !== '') {
          if (selected_url_file.indexOf( ',' ) > -1) {
            let urls = selected_url_file.split( ',' );

            for (let i = 0; i < urls.length; i++) {
              let url = urls[ i ].trim();

              if (url.indexOf( '.' ) > -1 && image_extensions.includes( url.toUpperCase().substring( url.lastIndexOf( '.' ) ))) {
                url_files.push( url );
              } else if (url.indexOf( '.' ) > -1 && model_extensions.includes( url.toUpperCase().substring( url.lastIndexOf( '.' ) ))) {
                url_files.push( url );
                selected_url_model_file = url;
              }
            }

            if (selected_url_model_file === null) {
              console.log( 'No valid URL model file selected!' );
              return;
            }
          } else {
            if (selected_url_file.indexOf( '.' ) > -1 && model_extensions.includes( selected_url_file.toUpperCase().substring( selected_url_file.lastIndexOf( '.' ) ))) {
              url_files.push( selected_url_file );
            } else {
              console.log( 'No valid URL model file selected!' );
            }
          }

          if (url_files.length > 0) {
            let element = document.getElementById('o3dv_element');
            element.innerHTML = '';
            let o3dv_embedded_viewer = new OV.EmbeddedViewer( element, { environmentSettings: new OV.EnvironmentSettings( textureNames, backgroundIsEnvMap ) } );
            o3dv_embedded_viewer.LoadModelFromUrlList( url_files );
          }
        }
      }
    </script>
  </body>
</html>
