import{BufferAttribute,BufferGeometry,DefaultLoadingManager,Matrix3,Points,Vector3}from"three";import*as compressor from"https://esm.sh/lzfjs@1.0.1";const _tempVec=new Vector3;class PCDExporter{constructor(e){this.manager=e||DefaultLoadingManager}parse(e,t,n,o={}){this.parseAsync(e,t,n,o)}async parseAsync(e,t,n,o={}){const r=this;o=Object.assign({binary:!1,binaryCompressed:!1,includeNormals:!0,includeIntensity:!0,includeClassification:!0,includeAlpha:!1,includeColors:!0,colorUnsigned:!1},o),e.updateMatrixWorld(!0,!0);let i=[],s=0;const a=[];let c;const l=new Float32Array(1),u=new Uint32Array(l.buffer);function p(e,t,n,o,r,i){const s=i?(255&o)<<24|(255&e)<<16|(255&t)<<8|255&n:(255&e)<<16|(255&t)<<8|255&n;return r?s:(u[0]=4278190079&s,l[0])}if(function(){if(e.traverse((function(e){e.isPoints&&e.geometry&&(i.push(e),s+=e.geometry.attributes.position.count)})),i.length>1){const e=i.map((e=>{const t=e.geometry.clone();return t.applyMatrix4(e.matrixWorld),t})),t=r._mergeGeometries(e),n=i[0].material.clone();i=[new Points(t,n)]}const t=o.includeColors&&i.some((e=>e.geometry.attributes.color)),n=o.includeNormals&&i.some((e=>e.geometry.attributes.normal)),l=o.includeIntensity&&i.some((e=>e.geometry.attributes.intensity)),u=o.includeClassification&&i.some((e=>e.geometry.attributes.classification)),f=["x","y","z"],m=[4,4,4],y=["F","F","F"],g=[1,1,1];a.push({name:"x",type:"F",size:4}),a.push({name:"y",type:"F",size:4}),a.push({name:"z",type:"F",size:4}),n&&(a.push({name:"normal_x",type:"F",size:4}),a.push({name:"normal_y",type:"F",size:4}),a.push({name:"normal_z",type:"F",size:4}),f.push("normal_x","normal_y","normal_z"),m.push(4,4,4),y.push("F","F","F"),g.push(1,1,1)),l&&(a.push({name:"intensity",type:"F",size:4}),f.push("intensity"),m.push(4),y.push("F"),g.push(1)),u&&(a.push({name:"classification",type:"U",size:4}),f.push("classification"),m.push(4),y.push("U"),g.push(1)),t&&(a.push({name:o.includeAlpha?"rgba":"rgb",type:o.colorUnsigned?"U":"F",size:4}),f.push(o.includeAlpha?"rgba":"rgb"),m.push(4),y.push(o.colorUnsigned?"U":"F"),g.push(1));let h=`# Created by the custom PCD Exporter\n# .PCD v0.7 - Point Cloud Data file format\nVERSION 0.7\nFIELDS ${f.join(" ")}\nSIZE ${m.join(" ")}\nTYPE ${y.join(" ")}\nCOUNT ${g.join(" ")}\nWIDTH ${s}\nHEIGHT 1\nVIEWPOINT 0 0 0 0.9999996192 0.0008726646 0 0\nPOINTS ${s}\nDATA ${o.binaryCompressed?"binary_compressed":o.binary?"binary":"ascii"}\n`;const b=[];let d,A,w,_,z="";(o.binary||o.binaryCompressed)&&(d=12+(n?12:0)+(l?4:0)+(u?4:0)+(t?4:0),A=new ArrayBuffer(d*s),w=new DataView(A),_=0);for(const e of i){const i=e.geometry.attributes.position,s=e.geometry.getAttribute("alpha"),a=r._normalize(e.geometry.attributes.color),c=e.geometry.attributes.normal,f=e.geometry.attributes.intensity,m=e.geometry.attributes.classification,y=e.matrixWorld,g=(new Matrix3).getNormalMatrix(y);for(let r=0;r<i.count;r++){_tempVec.fromBufferAttribute(i,r),_tempVec.applyMatrix4(y);const h=_tempVec.x,d=_tempVec.y,A=_tempVec.z;if(o.binary||o.binaryCompressed){if(w.setFloat32(_,h,!0),_+=4,w.setFloat32(_,d,!0),_+=4,w.setFloat32(_,A,!0),_+=4,n){_tempVec.fromBufferAttribute(c,r),_tempVec.applyMatrix3(g).normalize();const e=_tempVec.x,t=_tempVec.y,n=_tempVec.z;w.setFloat32(_,e,!0),_+=4,w.setFloat32(_,t,!0),_+=4,w.setFloat32(_,n,!0),_+=4}if(l){const e=f?f.getX(r):1;w.setFloat32(_,e,!0),_+=4}if(u){const e=m?m.getX(r):0;w.setUint32(_,e,!0),_+=4}if(t){const t=a?255*a.getX(r):255,n=a?255*a.getY(r):255,i=a?255*a.getZ(r):255;if(o.includeAlpha){const a=p(t,n,i,Math.min(255,Math.max(0,s?255*s.getX(r):255*e.material.opacity)),o.colorUnsigned,!0);o.colorUnsigned?w.setUint32(_,a,!0):w.setFloat32(_,a,!0)}else{const e=p(t,n,i,255,o.colorUnsigned,!1);o.colorUnsigned?w.setUint32(_,e,!0):w.setFloat32(_,e,!0)}_+=4}}else{if(z+=`${h} ${d} ${A}`,n){_tempVec.fromBufferAttribute(c,r),_tempVec.applyMatrix3(g).normalize();z+=` ${_tempVec.x} ${_tempVec.y} ${_tempVec.z}`}if(l){z+=` ${f?f.getX(r):1}`}if(u){z+=` ${m?m.getX(r):0}`}if(t){const t=a?255*a.getX(r):255,n=a?255*a.getY(r):255,i=a?255*a.getZ(r):255;if(o.includeAlpha){z+=` ${p(t,n,i,Math.min(255,Math.max(0,s?255*s.getX(r):255*e.material.opacity)),o.colorUnsigned,!0)}`}else{z+=` ${p(t,n,i,255,o.colorUnsigned,!1)}`}}z+="\n",b.push(z),z=""}}}if(o.binary||o.binaryCompressed){h.endsWith("\n")||(h+="\n");const e=(new TextEncoder).encode(h);if(o.binaryCompressed){f.length;const t=r._buildSoA(A,s,a),n=compressor.compress(t),o=n.length,i=t.byteLength,l=new Uint8Array(8);new DataView(l.buffer).setUint32(0,o,!0),new DataView(l.buffer).setUint32(4,i,!0),c=new Uint8Array(e.length+l.length+o),c.set(e,0),c.set(l,e.length),c.set(n,e.length+l.length)}else c=new Uint8Array(e.length+A.byteLength),c.set(e,0),c.set(new Uint8Array(A),e.length)}else c=h+b.join("")}(),0===s){if("function"==typeof n)return n("THREE.PCDExporter: No qualifying objects found!"),null;throw new Error("THREE.PCDExporter: No qualifying objects found!")}if("function"!=typeof t)return c;t(c)}_normalize(e){if(!e)return null;if(0===e.count||0===e.itemSize)return null;const t=e.count,n=e.itemSize,o=new Float32Array(t*n),r=new Array(n).fill(1/0),i=new Array(n).fill(-1/0);for(let o=0;o<t;o++)for(let t=0;t<n;t++){const n=e.getComponent(o,t);n<r[t]&&(r[t]=n),n>i[t]&&(i[t]=n)}for(let s=0;s<t;s++)for(let t=0;t<n;t++){const a=e.getComponent(s,t),c=i[t]-r[t]||1;o[s*n+t]=(a-r[t])/c}return new BufferAttribute(o,n)}_concatTyped(e,t){let n=0;for(const t of e)n+=t.length;const o=new t(n);let r=0;for(const t of e)o.set(t,r),r+=t.length;return o}_mergeGeometries(e){const t=new Set;for(const n of e)for(const e of Object.keys(n.attributes))t.add(e);if(!t.has("position"))throw new Error("All geometries must contain a position attribute");const n={};for(const o of t)for(const t of e){const e=t.getAttribute(o);if(e){n[o]={itemSize:e.itemSize,arrayType:e.array.constructor};break}}const o={};for(const e of t)o[e]=[];for(const r of e){const e=r.getAttribute("position").count;for(const i of t){const t=r.getAttribute(i);if(t)o[i].push(t.array);else{const{itemSize:t,arrayType:r}=n[i],s=new r(e*t);"color"===i||"intensity"===i?s.fill(1):"classification"===i?s.fill(0):"alpha"===i?s.fill(1):s.fill(0),o[i].push(s)}}}const r=new BufferGeometry;for(const e of t){const{itemSize:t,arrayType:i}=n[e],s=this._concatTyped(o[e],i);r.setAttribute(e,new BufferAttribute(s,t))}return r.computeBoundingBox(),r.computeBoundingSphere(),r}_buildSoA(e,t,n){const o=n.reduce(((e,t)=>e+t.size),0),r=new Uint8Array(t*o),i=new DataView(e);let s=0,a=0;for(let e=0;e<n.length;e++){const c=n[e].size;for(let e=0;e<t;e++){const t=e*o+a;for(let e=0;e<c;e++)r[s++]=i.getUint8(t+e)}a+=c}return r}}export{PCDExporter};