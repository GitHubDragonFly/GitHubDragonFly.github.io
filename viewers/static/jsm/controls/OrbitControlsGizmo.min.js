import{Vector2,Vector3,Matrix4}from"three";class OrbitControlsGizmo{constructor(e,t){t=Object.assign({size:90,padding:8,bubbleSizePrimary:8,bubbleSizeSecondary:6,lineWidth:2,fontSize:"12px",fontFamily:"arial",fontWeight:"bold",fontColor:"#222222",className:"obit-controls-gizmo",colors:{x:["#f73c3c","#942424"],y:["#6ccb26","#417a17"],z:["#178cf0","#0e5490"]}},t),this.lock=!1,this.lockX=!1,this.lockY=!1,this.update=()=>{if(!this.lock){o.updateMatrix(),r.extractRotation(o.matrix).invert();for(let e=0,t=m.length;e<t;e++)F(m[e]);m.sort(((e,t)=>e.position.z>t.position.z?1:-1)),V(!0)}},this.dispose=()=>{i.removeEventListener("change",this.update),i.removeEventListener("start",(()=>this.domElement.classList.add("inactive"))),i.removeEventListener("end",(()=>this.domElement.classList.remove("inactive"))),this.domElement.removeEventListener("pointerdown",E,!1),this.domElement.removeEventListener("pointerenter",y,!1),this.domElement.removeEventListener("pointermove",z,!1),this.domElement.removeEventListener("click",b,!1),window.removeEventListener("pointermove",x,!1),window.removeEventListener("pointerup",w,!1),this.domElement.remove()};const n=this,i=e,o=e.object,r=new Matrix4,s=new Vector3,l=new Vector2,c=new Vector2,a=new Vector2,d=new Vector3(t.size/2,t.size/2,0),m=function(){const e=t.colors,n=t.lineWidth,i={primary:t.bubbleSizePrimary,secondary:t.bubbleSizeSecondary};return[{axis:"x",direction:new Vector3(1,0,0),size:i.primary,color:e.x,line:n,label:"X",position:new Vector3(0,0,0)},{axis:"y",direction:new Vector3(0,1,0),size:i.primary,color:e.y,line:n,label:"Y",position:new Vector3(0,0,0)},{axis:"z",direction:new Vector3(0,0,1),size:i.primary,color:e.z,line:n,label:"Z",position:new Vector3(0,0,0)},{axis:"-x",direction:new Vector3(-1,0,0),size:i.secondary,color:e.x,position:new Vector3(0,0,0)},{axis:"-y",direction:new Vector3(0,-1,0),size:i.secondary,color:e.y,position:new Vector3(0,0,0)},{axis:"-z",direction:new Vector3(0,0,-1),size:i.secondary,color:e.z,position:new Vector3(0,0,0)}]}();let p,h,v,u=null,f=!1;function E(e){l.set(e.clientX,e.clientY),v=i.enabled,i.enabled=!1,window.addEventListener("pointermove",x,!1),window.addEventListener("pointerup",w,!1)}function w(){setTimeout((()=>f=!1),0),n.domElement.classList.remove("dragging"),i.enabled=v,window.removeEventListener("pointermove",x,!1),window.removeEventListener("pointerup",w,!1)}function y(){h=n.domElement.getBoundingClientRect()}function z(e){if(f||n.lock)return;const t=u;u=null,e&&s.set(e.clientX-h.left,e.clientY-h.top,0);for(let e=0,t=m.length;e<t;e++){s.distanceTo(m[e].position)<m[e].size&&(u=m[e])}t!==u&&V()}function x(e){n.lock||(f||n.domElement.classList.add("dragging"),f=!0,u=null,c.set(e.clientX,e.clientY),a.subVectors(c,l).multiplyScalar(.5),n.lockX||i.rotateLeft(2*Math.PI*a.x/n.domElement.height),n.lockY||i.rotateUp(2*Math.PI*a.y/n.domElement.height),l.copy(c),i.update())}function b(){if(f||!u)return;const e=u.direction.clone(),t=o.position.distanceTo(i.target);e.multiplyScalar(t);const n=performance.now();!function t(){const r=performance.now()-n,s=Math.min(r/400,1);if(o.position.lerp(e,s),i.update(),1!==s)return requestAnimationFrame(t);z()}(),u=null}function g(e,t=10,n="#FF0000"){p.beginPath(),p.arc(e.x,e.y,t,0,2*Math.PI,!1),p.fillStyle=n,p.fill(),p.closePath()}function L(e,t,n=1,i="#FF0000"){p.beginPath(),p.moveTo(e.x,e.y),p.lineTo(t.x,t.y),p.lineWidth=n,p.strokeStyle=i,p.stroke(),p.closePath()}function V(e){e&&p.clearRect(0,0,n.domElement.width,n.domElement.height);for(let e=0,n=m.length;e<n;e++){const n=m[e],i=u===n,o=n.position.z>=-.01?n.color[0]:n.color[1];n.line&&L(d,n.position,n.line,o),g(n.position,n.size,i?"#FFFFFF":o),n.label&&(p.font=[t.fontWeight,t.fontSize,t.fontFamily].join(" "),p.fillStyle=t.fontColor,p.textBaseline="middle",p.textAlign="center",p.fillText(n.label,n.position.x,n.position.y))}}function F(e){const n=e.direction.clone().applyMatrix4(r),i=e.size;e.position.set(n.x*(d.x-i/2-t.padding)+d.x,d.y-n.y*(d.y-i/2-t.padding),n.z)}i.addEventListener("change",this.update),i.addEventListener("start",(()=>this.domElement.classList.add("inactive"))),i.addEventListener("end",(()=>this.domElement.classList.remove("inactive"))),this.domElement=function(){const e=document.createElement("canvas");return e.width=t.size,e.height=t.size,e.classList.add(t.className),e.addEventListener("pointerdown",E,!1),e.addEventListener("pointerenter",y,!1),e.addEventListener("pointermove",z,!1),e.addEventListener("click",b,!1),p=e.getContext("2d"),e}(),this.update()}}export{OrbitControlsGizmo};