import{AdditiveBlending,BufferGeometry,Color,DoubleSide,FileLoader,Float32BufferAttribute,Group,LinearSRGBColorSpace,Loader,LoaderUtils,Matrix4,Mesh,MeshPhysicalMaterial,TextureLoader,SRGBColorSpace}from"three";var localPath="",urlPath="";const default_texture=(new TextureLoader).load("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAQAAAAECAYAAACp8Z5+AAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsIAAA7CARUoSoAAAAAzSURBVBhXFYrJDQAxDAIHl5tG9pWOI8/aICGunO9qP0JRNZqwltgspltKdtmfihNMoc0PFNkQjHSfyTIAAAAASUVORK5CYII=");class TDSLoader extends Loader{constructor(e){super(e),this.debug=!1,this.group=null,this.position=0,this.materials=[],this.meshes=[]}load(e,t,s,i,r,a){const o=this,n=""===this.path?LoaderUtils.extractUrlBase(e):this.path,h=new FileLoader(this.manager);""!==t&&(localPath=t),""!==s&&(urlPath=s),h.setPath(this.path),h.setResponseType("arraybuffer"),h.setRequestHeader(this.requestHeader),h.setWithCredentials(this.withCredentials),h.load(e,(function(t){try{i(o.parse(t,n))}catch(t){a&&a(t),o.manager.itemError(e)}}),r,a)}parse(e,t){this.group=new Group,this.position=0,this.materials=[],this.meshes=[],this.readFile(e,t);for(let e=0;e<this.meshes.length;e++)this.group.add(this.meshes[e]);return this.group}readFile(e,t){const s=new DataView(e),i=this.readChunk(s);if(i.id===MLIBMAGIC||i.id===CMAGIC||i.id===M3DMAGIC){let e=this.nextChunk(s,i);for(;0!==e;){if(e===M3D_VERSION){const e=this.readDWord(s);this.debugMessage("3DS file version: "+e)}else e===MDATA?(this.resetPosition(s),this.readMeshData(s,t)):this.debugMessage("Unknown main chunk: "+e.toString(16));e=this.nextChunk(s,i)}}this.debugMessage("Parsed "+this.meshes.length+" meshes")}readMeshData(e,t){const s=this.readChunk(e);let i=this.nextChunk(e,s);for(;0!==i;){if(i===MESH_VERSION){const t=+this.readDWord(e);this.debugMessage("Mesh Version: "+t)}else if(i===MASTER_SCALE){const t=this.readFloat(e);this.debugMessage("Master scale: "+t),this.group.scale.set(t,t,t)}else i===NAMED_OBJECT?(this.debugMessage("Named Object"),this.resetPosition(e),this.readNamedObject(e)):i===MAT_ENTRY?(this.debugMessage("Material"),this.resetPosition(e),this.readMaterialEntry(e,t)):this.debugMessage("Unknown MDATA chunk: "+i.toString(16));i=this.nextChunk(e,s)}}readNamedObject(e){const t=this.readChunk(e),s=this.readString(e,64);t.cur=this.position;let i=this.nextChunk(e,t);for(;0!==i;){if(i===N_TRI_OBJECT){this.resetPosition(e);const t=this.readMesh(e);t.name=s,this.meshes.push(t)}else this.debugMessage("Unknown named object chunk: "+i.toString(16));i=this.nextChunk(e,t)}this.endChunk(t)}readMaterialEntry(e,t){const s=this.readChunk(e);let i=this.nextChunk(e,s),r=!1;const a=new MeshPhysicalMaterial({metalness:.6,roughness:.5});for(;0!==i;){if(i===MAT_NAME)a.name=this.readString(e,64),this.debugMessage("   Name: "+a.name);else if(i===MAT_WIRE)a.wireframe=!0,this.debugMessage("   Wireframe");else if(i===MAT_WIRE_SIZE){const t=this.readByte(e);a.wireframeLinewidth=t,this.debugMessage("   Wireframe Thickness: "+t)}else if(i===MAT_TWO_SIDE)a.side=DoubleSide,this.debugMessage("   DoubleSided");else if(i===MAT_ADDITIVE)a.blending=AdditiveBlending,this.debugMessage("   Additive Blending");else if(i===MAT_DIFFUSE)a.color=this.readColor(e),this.debugMessage("   Diffuse THREE.Color");else if(i===MAT_SPECULAR)r=!0,a.specularColor=this.readColor(e),this.debugMessage("   Specular THREE.Color");else if(i===MAT_AMBIENT)a.color=this.readColor(e),this.debugMessage("   Ambient color");else if(i===MAT_SHININESS){const t=this.readPercentage(e);a.shininess=100*t,this.debugMessage("   Shininess : "+t)}else if(i===MAT_TRANSPARENCY){const t=this.readPercentage(e);a.opacity=1-t,a.transparent=a.opacity<1,this.debugMessage("  Transparency : "+t)}else i===MAT_TEXMAP?(this.resetPosition(e),a.map=this.readMap(e,t),a.map.colorSpace=SRGBColorSpace,this.debugMessage("   ColorMap")):i===MAT_BUMPMAP?(this.resetPosition(e),a.bumpMap=this.readMap(e,t),a.bumpMap.colorSpace=LinearSRGBColorSpace,this.debugMessage("   BumpMap")):i===MAT_OPACMAP?(this.resetPosition(e),a.alphaMap=this.readMap(e,t),a.alphaMap.colorSpace=LinearSRGBColorSpace,this.debugMessage("   OpacityMap")):i===MAT_SPECMAP?(r=!0,this.resetPosition(e),a.specularColorMap=this.readMap(e,t),a.specularColorMap.colorSpace=SRGBColorSpace,this.debugMessage("   SpecularMap")):this.debugMessage("   Unknown material chunk: "+i.toString(16));i=this.nextChunk(e,s)}!0===r&&(a.metalness=.475,a.roughness=.725),this.endChunk(s),this.materials[a.name]=a}readMesh(e){const t=this.readChunk(e);let s=this.nextChunk(e,t);const i=new BufferGeometry,r=new MeshPhysicalMaterial({metalness:.6,roughness:.5}),a=new Mesh(i,r);for(a.name="mesh";0!==s;){if(s===POINT_ARRAY){const t=this.readWord(e);this.debugMessage("   Vertex: "+t);const s=[];for(let i=0;i<t;i++)s.push(this.readFloat(e)),s.push(this.readFloat(e)),s.push(this.readFloat(e));i.setAttribute("position",new Float32BufferAttribute(s,3))}else if(s===FACE_ARRAY)this.resetPosition(e),this.readFaceArray(e,a);else if(s===TEX_VERTS){const t=this.readWord(e);this.debugMessage("   UV: "+t);const s=[];for(let i=0;i<t;i++)s.push(this.readFloat(e)),s.push(this.readFloat(e));i.setAttribute("uv",new Float32BufferAttribute(s,2))}else if(s===MESH_MATRIX){this.debugMessage("   Tranformation Matrix (TODO)");const t=[];for(let s=0;s<12;s++)t[s]=this.readFloat(e);const s=new Matrix4;s.elements[0]=t[0],s.elements[1]=t[6],s.elements[2]=t[3],s.elements[3]=t[9],s.elements[4]=t[2],s.elements[5]=t[8],s.elements[6]=t[5],s.elements[7]=t[11],s.elements[8]=t[1],s.elements[9]=t[7],s.elements[10]=t[4],s.elements[11]=t[10],s.transpose();const r=new Matrix4;r.copy(s).invert(),i.applyMatrix4(r),s.decompose(a.position,a.quaternion,a.scale)}else this.debugMessage("   Unknown mesh chunk: "+s.toString(16));s=this.nextChunk(e,t)}return this.endChunk(t),i.computeVertexNormals(),a}readFaceArray(e,t){const s=this.readChunk(e),i=this.readWord(e);this.debugMessage("   Faces: "+i);const r=[];for(let t=0;t<i;++t)r.push(this.readWord(e),this.readWord(e),this.readWord(e)),this.readWord(e);t.geometry.setIndex(r);let a=0,o=0;for(;this.position<s.end;){const s=this.readChunk(e);if(s.id===MSH_MAT_GROUP){this.debugMessage("      Material THREE.Group"),this.resetPosition(e);const s=this.readMaterialGroup(e),i=3*s.index.length;t.geometry.addGroup(o,i,a),o+=i,a++;const r=this.materials[s.name];!1===Array.isArray(t.material)&&(t.material=[]),void 0!==r&&t.material.push(r)}else this.debugMessage("      Unknown face array chunk: "+s.toString(16));this.endChunk(s)}1===t.material.length&&(t.material=t.material[0]),this.endChunk(s)}readMap(e,t){const s=this.readChunk(e);let i,r,a,o,n=this.nextChunk(e,s),h={};for(;0!==n;){if(n===MAT_MAPNAME){const s=this.readString(e,128);if(h=default_texture,s.toLowerCase().endsWith(".dds")||s.toLowerCase().endsWith(".tga")?(r=s.toLowerCase().endsWith(".dds")?".dds":".tga",i=this.manager.getHandler(r)):i=new TextureLoader(this.manager),""!==localPath?i.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin):""!==urlPath?i.setCrossOrigin(this.crossOrigin):i.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin),""!==localPath){let e,t,r=localPath.split(",");r.forEach(((i,o)=>{i.length>12&&(e=i.substring(0,12),t=i.substring(0,8)+i.slice(-4)),(s.toUpperCase()===i.toUpperCase()||e&&s.toUpperCase()===e.toUpperCase()||t&&s.toUpperCase()===t.toUpperCase())&&(a=r[o+1].substring(r[o+1].lastIndexOf("/")+1))})),a&&(h=i.load(a))}else if(""!==urlPath){let e,t,r=urlPath.split(",");r.forEach(((i,a)=>{i.length>12&&(e=i.substring(0,12),t=i.substring(0,8)+i.slice(-4)),(s.toUpperCase()===i.toUpperCase()||e&&s.toUpperCase()===e.toUpperCase()||t&&s.toUpperCase()===t.toUpperCase())&&(o=r[a+1])})),o&&(h=i.load(o))}else h=i.load(s);s.toLowerCase().endsWith(".tga")?(h.generateMipmaps=!0,h.flipY=!0):s.toLowerCase().endsWith(".dds")&&(h.repeat.y=-1),this.debugMessage("      File: "+t+s)}else n===MAT_MAP_UOFFSET?(h.offset.x=this.readFloat(e),this.debugMessage("      OffsetX: "+h.offset.x)):n===MAT_MAP_VOFFSET?(h.offset.y=this.readFloat(e),this.debugMessage("      OffsetY: "+h.offset.y)):n===MAT_MAP_USCALE?(h.repeat.x=this.readFloat(e),this.debugMessage("      RepeatX: "+h.repeat.x)):n===MAT_MAP_VSCALE?(h.repeat.y=this.readFloat(e),this.debugMessage("      RepeatY: "+h.repeat.y)):n===MAT_MAP_ANG?(h.rotation=this.readFloat(e),this.debugMessage("      Rotation: "+h.rotation)):this.debugMessage("      Unknown map chunk: "+n.toString(16));n=this.nextChunk(e,s)}return this.endChunk(s),h}readMaterialGroup(e){this.readChunk(e);const t=this.readString(e,64),s=this.readWord(e);this.debugMessage("         Name: "+t),this.debugMessage("         Faces: "+s);const i=[];for(let t=0;t<s;++t)i.push(this.readWord(e));return{name:t,index:i}}readColor(e){const t=this.readChunk(e),s=new Color;if(t.id===COLOR_24||t.id===LIN_COLOR_24){const t=this.readByte(e),i=this.readByte(e),r=this.readByte(e);s.setRGB(t/255,i/255,r/255,LinearSRGBColorSpace),this.debugMessage("      THREE.Color: "+s.r+", "+s.g+", "+s.b)}else if(t.id===COLOR_F||t.id===LIN_COLOR_F){const t=this.readFloat(e),i=this.readFloat(e),r=this.readFloat(e);s.setRGB(t,i,r,LinearSRGBColorSpace),this.debugMessage("      THREE.Color: "+s.r+", "+s.g+", "+s.b)}else this.debugMessage("      Unknown color chunk: "+t.toString(16));return this.endChunk(t),s}readChunk(e){const t={};return t.cur=this.position,t.id=this.readWord(e),t.size=this.readDWord(e),t.end=t.cur+t.size,t.cur+=6,t}endChunk(e){this.position=e.end}nextChunk(e,t){if(t.cur>=t.end)return 0;this.position=t.cur;try{const s=this.readChunk(e);return t.cur+=s.size,s.id}catch(e){return this.debugMessage("Unable to read chunk at "+this.position),0}}resetPosition(){this.position-=6}readByte(e){const t=e.getUint8(this.position,!0);return this.position+=1,t}readFloat(e){try{const t=e.getFloat32(this.position,!0);return this.position+=4,t}catch(t){this.debugMessage(t+" "+this.position+" "+e.byteLength)}}readInt(e){const t=e.getInt32(this.position,!0);return this.position+=4,t}readShort(e){const t=e.getInt16(this.position,!0);return this.position+=2,t}readDWord(e){const t=e.getUint32(this.position,!0);return this.position+=4,t}readWord(e){const t=e.getUint16(this.position,!0);return this.position+=2,t}readString(e,t){let s="";for(let i=0;i<t;i++){const t=this.readByte(e);if(!t)break;s+=String.fromCharCode(t)}return s}readPercentage(e){const t=this.readChunk(e);let s;switch(t.id){case INT_PERCENTAGE:s=this.readShort(e)/100;break;case FLOAT_PERCENTAGE:s=this.readFloat(e);break;default:this.debugMessage("      Unknown percentage chunk: "+t.toString(16))}return this.endChunk(t),s}debugMessage(e){this.debug}}const M3DMAGIC=19789,MLIBMAGIC=15786,CMAGIC=49725,M3D_VERSION=2,COLOR_F=16,COLOR_24=17,LIN_COLOR_24=18,LIN_COLOR_F=19,INT_PERCENTAGE=48,FLOAT_PERCENTAGE=49,MDATA=15677,MESH_VERSION=15678,MASTER_SCALE=256,MAT_ENTRY=45055,MAT_NAME=40960,MAT_AMBIENT=40976,MAT_DIFFUSE=40992,MAT_SPECULAR=41008,MAT_SHININESS=41024,MAT_TRANSPARENCY=41040,MAT_TWO_SIDE=41089,MAT_ADDITIVE=41091,MAT_WIRE=41093,MAT_WIRE_SIZE=41095,MAT_TEXMAP=41472,MAT_OPACMAP=41488,MAT_BUMPMAP=41520,MAT_SPECMAP=41476,MAT_MAPNAME=41728,MAT_MAP_USCALE=41812,MAT_MAP_VSCALE=41814,MAT_MAP_UOFFSET=41816,MAT_MAP_VOFFSET=41818,MAT_MAP_ANG=41820,NAMED_OBJECT=16384,N_TRI_OBJECT=16640,POINT_ARRAY=16656,FACE_ARRAY=16672,MSH_MAT_GROUP=16688,TEX_VERTS=16704,MESH_MATRIX=16736;export{TDSLoader};