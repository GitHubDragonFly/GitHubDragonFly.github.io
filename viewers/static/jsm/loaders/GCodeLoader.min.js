import{BufferGeometry,Euler,FileLoader,Float32BufferAttribute,Group,LineBasicMaterial,LineSegments,Line,Loader,SplineCurve,Vector2}from"three";class GCodeLoader extends Loader{constructor(e){super(e),this.splitLayer=!1}load(e,t,r,o){const n=this,i=new FileLoader(n.manager);i.setPath(n.path),i.setRequestHeader(n.requestHeader),i.setWithCredentials(n.withCredentials),i.load(e,function(r){try{const i=r.replace(/;.+/g,"").split("\n"),s=n.parse(i);t(s)}catch(t){o?o(t):console.error(t),n.manager.itemError(e)}},r,o)}parse(e){let t,r={x:0,y:0,z:0,e:0,f:0,i:0,j:0,extruding:!1,relative:!1};const o=[];let n=void 0;const i=new LineBasicMaterial({color:10818837});i.name="path";const s=new LineBasicMaterial({color:1418517});s.name="extruded";const a=new Group;function l(e){n={vertex:[],pathVertex:[],z:e.z},o.push(n)}function d(e,t){void 0===n&&l(e),r.extruding?(n.vertex.push(e.x,e.y,e.z),n.vertex.push(t.x,t.y,t.z)):(n.pathVertex.push(e.x,e.y,e.z),n.pathVertex.push(t.x,t.y,t.z))}function c(e,t){return r.relative?t:t-e}function f(e,t){return r.relative?e+t:t}a.name="gcode";const u=/(([XxYyZz]) *(-?\d+.?\d*)) *(([XxYyZz]) *(-?\d+.?\d*))? *(([XxYyZz]) *(-?\d+.?\d*))?/g;for(const o of e){const e=o.split(" ");t=e[0].toUpperCase();const i={};if(e.splice(0).forEach(function(e){if(void 0!==e[0]){const t=e[0].toLowerCase(),r=parseFloat(e.substring(1));i[t]=r}}),"G00"===t||"G0"===t||"G01"===t||"G1"===t||u.test(t)){const e={x:void 0!==i.x?f(r.x,i.x):r.x,y:void 0!==i.y?f(r.y,i.y):r.y,z:void 0!==i.z?f(r.z,i.z):r.z,e:void 0!==i.e?f(r.e,i.e):r.e,f:void 0!==i.f?f(r.f,i.f):r.f};c(r.e,e.e)>0&&(r.extruding=!0,null!=n&&e.z==n.z||l(e)),d(r,e),r=e}else if("G02"===t||"G2"===t||"G03"===t||"G3"===t){const e={x:void 0!==i.x?f(r.x,i.x):r.x,y:void 0!==i.y?f(r.y,i.y):r.y,z:void 0!==i.z?f(r.z,i.z):r.z,i:void 0!==i.i?f(r.i,i.i):r.i,j:void 0!==i.j?f(r.j,i.j):r.j,e:void 0!==i.e?f(r.e,i.e):r.e,f:void 0!==i.f?f(r.f,i.f):r.f};c(r.e,e.e)>0&&(r.extruding=!0,null!=n&&e.z==n.z||l(e)),d(r,e),r=e}else if("G90"===t)r.relative=!1;else if("G91"===t)r.relative=!0;else if("G92"===t){const e=r;e.x=void 0!==i.x?i.x:e.x,e.y=void 0!==i.y?i.y:e.y,e.z=void 0!==i.z?i.z:e.z,e.e=void 0!==i.e?i.e:e.e,r=e}}function x(e,t,o,n){if("G02"!=n||"G03"!=n||"G2"!=n||"G3"!=n){const r=new BufferGeometry;r.setAttribute("position",new Float32BufferAttribute(e,3));const n=new LineSegments(r,t?s:i);n.name="layer"+o,a.add(n)}else{const e=new SplineCurve([new Vector2(r.x,r.y),new Vector2(args.x,args.y)]).getPoints(50),n=(new BufferGeometry).setFromPoints(e),l=new Line(n,t?s:i);l.name="layer"+o,a.add(l)}}if(this.splitLayer)for(let e=0;e<o.length;e++){const r=o[e];x(r.vertex,!0,e,t),x(r.pathVertex,!1,e,t)}else{const e=[],r=[];for(const t of o){const o=t.vertex,n=t.pathVertex;for(let t=0;t<o.length;t++)e.push(o[t]);for(let e=0;e<n.length;e++)r.push(n[e])}x(e,!0,o.length,t),x(r,!1,o.length,t)}return a.quaternion.setFromEuler(new Euler(-Math.PI/2,0,0)),a}}export{GCodeLoader};