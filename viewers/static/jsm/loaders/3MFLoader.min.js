import{BufferAttribute,BufferGeometry,ClampToEdgeWrapping,Color,FileLoader,Float32BufferAttribute,Group,LinearFilter,LinearMipmapLinearFilter,Loader,Matrix4,Mesh,MeshPhongMaterial,MeshStandardMaterial,MirroredRepeatWrapping,NearestFilter,RepeatWrapping,TextureLoader,SRGBColorSpace}from"three";import*as fflate from"three/addons/libs/fflate.module.js";const COLOR_SPACE_3MF=SRGBColorSpace;class ThreeMFLoader extends Loader{constructor(e){super(e),this.availableExtensions=[]}load(e,t,r,n){const o=this,s=new FileLoader(o.manager);s.setPath(o.path),s.setResponseType("arraybuffer"),s.setRequestHeader(o.requestHeader),s.setWithCredentials(o.withCredentials),s.load(e,(function(r){try{t(o.parse(r))}catch(t){n&&n(t),o.manager.itemError(e)}}),r,n)}parse(e){const t=this,r=new TextureLoader(this.manager);function n(e){const t=[],r=(new DOMParser).parseFromString(e,"application/xml").querySelectorAll("Relationship");for(let e=0;e<r.length;e++){const n=r[e],o={target:n.getAttribute("Target"),id:n.getAttribute("Id"),type:n.getAttribute("Type")};t.push(o)}return t}function o(e){const t={id:e.getAttribute("id"),basematerials:[]},r=e.querySelectorAll("base");for(let e=0;e<r.length;e++){const n=c(r[e]);n.index=e,t.basematerials.push(n)}return t}function s(e){const t={id:e.getAttribute("id"),texid:e.getAttribute("texid"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("tex2coord"),n=[];for(let e=0;e<r.length;e++){const t=r[e],o=t.getAttribute("u"),s=t.getAttribute("v");n.push(parseFloat(o),parseFloat(s))}return t.uvs=new Float32Array(n),t}function i(e){const t={id:e.getAttribute("id"),displaypropertiesid:e.getAttribute("displaypropertiesid")},r=e.querySelectorAll("color"),n=[],o=new Color;for(let e=0;e<r.length;e++){const t=r[e].getAttribute("color");o.setStyle(t.substring(0,7),COLOR_SPACE_3MF),n.push(o.r,o.g,o.b)}return t.colors=new Float32Array(n),t}function l(e){const t=e.children,r={};for(let e=0;e<t.length;e++){const n={type:t[e].nodeName.substring(2)};for(let r=0;r<t[e].attributes.length;r++){const o=t[e].attributes[r];o.specified&&(n[o.name]=o.value)}r[t[e].getAttribute("identifier")]=n}return r}function a(e){const t={id:e.getAttribute("id"),displayname:e.getAttribute("displayname")},r=e.children,n={};for(let e=0;e<r.length;e++){const t=r[e];if("i:in"===t.nodeName||"i:out"===t.nodeName)n["i:in"===t.nodeName?"inputs":"outputs"]=l(t);else{const e=t.children,r={op:t.nodeName.substring(2),identifier:t.getAttribute("identifier")};for(let t=0;t<e.length;t++)r[e[t].nodeName.substring(2)]=l(e[t]);n[r.identifier]=r}}return t.operations=n,t}function u(e){const t={id:e.getAttribute("id")},r=e.querySelectorAll("pbmetallic"),n=[];for(let e=0;e<r.length;e++){const t=r[e];n.push({name:t.getAttribute("name"),metallicness:parseFloat(t.getAttribute("metallicness")),roughness:parseFloat(t.getAttribute("roughness"))})}return t.data=n,t}function c(e){const t={};return t.name=e.getAttribute("name"),t.displaycolor=e.getAttribute("displaycolor"),t.displaypropertiesid=e.getAttribute("displaypropertiesid"),t}function p(e){const t={};t.objectId=e.getAttribute("objectid");const r=e.getAttribute("transform");return r&&(t.transform=d(r)),t}function d(e){const t=[];e.split(" ").forEach((function(e){t.push(parseFloat(e))}));const r=new Matrix4;return r.set(t[0],t[3],t[6],t[9],t[1],t[4],t[7],t[10],t[2],t[5],t[8],t[11],0,0,0,1),r}function h(e){const t={type:e.getAttribute("type")},r=e.getAttribute("id");r&&(t.id=r);const n=e.getAttribute("pid");n&&(t.pid=n);const o=e.getAttribute("pindex");o&&(t.pindex=o);const s=e.getAttribute("thumbnail");s&&(t.thumbnail=s);const i=e.getAttribute("partnumber");i&&(t.partnumber=i);const l=e.getAttribute("name");l&&(t.name=l);const a=e.querySelector("mesh");a&&(t.mesh=function(e){const t={},r=[],n=e.querySelectorAll("vertices vertex");for(let e=0;e<n.length;e++){const t=n[e],o=t.getAttribute("x"),s=t.getAttribute("y"),i=t.getAttribute("z");r.push(parseFloat(o),parseFloat(s),parseFloat(i))}t.vertices=new Float32Array(r);const o=[],s=[],i=e.querySelectorAll("triangles triangle");for(let e=0;e<i.length;e++){const t=i[e],r=t.getAttribute("v1"),n=t.getAttribute("v2"),l=t.getAttribute("v3"),a=t.getAttribute("p1"),u=t.getAttribute("p2"),c=t.getAttribute("p3"),p=t.getAttribute("pid"),d={};d.v1=parseInt(r,10),d.v2=parseInt(n,10),d.v3=parseInt(l,10),s.push(d.v1,d.v2,d.v3),a&&(d.p1=parseInt(a,10)),u&&(d.p2=parseInt(u,10)),c&&(d.p3=parseInt(c,10)),p&&(d.pid=p),0<Object.keys(d).length&&o.push(d)}return t.triangleProperties=o,t.triangles=new Uint32Array(s),t}(a));const u=e.querySelector("components");return u&&(t.components=function(e){const t=[],r=e.querySelectorAll("component");for(let e=0;e<r.length;e++){const n=p(r[e]);t.push(n)}return t}(u)),t}function g(e){const t={unit:e.getAttribute("unit")||"millimeter"},r=e.querySelectorAll("metadata");r&&(t.metadata=function(e){const t={};for(let r=0;r<e.length;r++){const n=e[r],o=n.getAttribute("name");0<=["Title","Designer","Description","Copyright","LicenseTerms","Rating","CreationDate","ModificationDate"].indexOf(o)&&(t[o]=n.textContent)}return t}(r));const n=e.querySelector("resources");n&&(t.resources=function(e){const t={basematerials:{}},r=e.querySelectorAll("basematerials");for(let e=0;e<r.length;e++){const n=o(r[e]);t.basematerials[n.id]=n}t.texture2d={};const n=e.querySelectorAll("texture2d");for(let e=0;e<n.length;e++){const r={id:(l=n[e]).getAttribute("id"),path:l.getAttribute("path"),contenttype:l.getAttribute("contenttype"),tilestyleu:l.getAttribute("tilestyleu"),tilestylev:l.getAttribute("tilestylev"),filter:l.getAttribute("filter")};t.texture2d[r.id]=r}var l;t.colorgroup={};const c=e.querySelectorAll("colorgroup");for(let e=0;e<c.length;e++){const r=i(c[e]);t.colorgroup[r.id]=r}const p=e.querySelectorAll("implicitfunction");p.length>0&&(t.implicitfunction={});for(let e=0;e<p.length;e++){const r=a(p[e]);t.implicitfunction[r.id]=r}t.pbmetallicdisplayproperties={};const d=e.querySelectorAll("pbmetallicdisplayproperties");for(let e=0;e<d.length;e++){const r=u(d[e]);t.pbmetallicdisplayproperties[r.id]=r}t.texture2dgroup={};const g=e.querySelectorAll("texture2dgroup");for(let e=0;e<g.length;e++){const r=s(g[e]);t.texture2dgroup[r.id]=r}t.object={};const f=e.querySelectorAll("object");for(let e=0;e<f.length;e++){const r=h(f[e]);t.object[r.id]=r}return t}(n));const l=e.querySelector("build");return l&&(t.build=function(e){const t=[],r=e.querySelectorAll("item");for(let e=0;e<r.length;e++){const n=r[e],o={objectId:n.getAttribute("objectid")},s=n.getAttribute("transform");s&&(o.transform=d(s)),t.push(o)}return t}(l)),t}function f(e,t,n,o){const s=e.texid,i=n.resources.texture2d[s];if(i){const e=o[i.path],t=i.contenttype,n=new Blob([e],{type:t}),s=URL.createObjectURL(n),l=r.load(s,(function(){URL.revokeObjectURL(s)}));switch(l.colorSpace=COLOR_SPACE_3MF,i.tilestyleu){case"wrap":l.wrapS=RepeatWrapping;break;case"mirror":l.wrapS=MirroredRepeatWrapping;break;case"none":case"clamp":l.wrapS=ClampToEdgeWrapping;break;default:l.wrapS=RepeatWrapping}switch(i.tilestylev){case"wrap":l.wrapT=RepeatWrapping;break;case"mirror":l.wrapT=MirroredRepeatWrapping;break;case"none":case"clamp":l.wrapT=ClampToEdgeWrapping;break;default:l.wrapT=RepeatWrapping}switch(i.filter){case"auto":l.magFilter=LinearFilter,l.minFilter=LinearMipmapLinearFilter;break;case"linear":l.magFilter=LinearFilter,l.minFilter=LinearFilter,l.generateMipmaps=!1;break;case"nearest":l.magFilter=NearestFilter,l.minFilter=NearestFilter,l.generateMipmaps=!1;break;default:l.magFilter=LinearFilter,l.minFilter=LinearMipmapLinearFilter}return l}return null}function b(e,t,r,n,o,s,i){const l=i.pindex,a={};for(let e=0,r=t.length;e<r;e++){const r=t[e],n=void 0!==r.p1?r.p1:l;void 0===a[n]&&(a[n]=[]),a[n].push(r)}const u=Object.keys(a),c=[];for(let t=0,l=u.length;t<l;t++){const l=u[t],p=a[l],d=x(e.basematerials[l],n,o,s,i,F),h=new BufferGeometry,g=[],f=r.vertices;for(let e=0,t=p.length;e<t;e++){const t=p[e];g.push(f[3*t.v1+0]),g.push(f[3*t.v1+1]),g.push(f[3*t.v1+2]),g.push(f[3*t.v2+0]),g.push(f[3*t.v2+1]),g.push(f[3*t.v2+2]),g.push(f[3*t.v3+0]),g.push(f[3*t.v3+1]),g.push(f[3*t.v3+2])}h.setAttribute("position",new Float32BufferAttribute(g,3));const b=new Mesh(h,d);c.push(b)}return c}function m(e,t,r,n,o,s,i){const l=new BufferGeometry,a=[],u=[],c=r.vertices,p=e.uvs;for(let e=0,r=t.length;e<r;e++){const r=t[e];a.push(c[3*r.v1+0]),a.push(c[3*r.v1+1]),a.push(c[3*r.v1+2]),a.push(c[3*r.v2+0]),a.push(c[3*r.v2+1]),a.push(c[3*r.v2+2]),a.push(c[3*r.v3+0]),a.push(c[3*r.v3+1]),a.push(c[3*r.v3+2]),u.push(p[2*r.p1+0]),u.push(p[2*r.p1+1]),u.push(p[2*r.p2+0]),u.push(p[2*r.p2+1]),u.push(p[2*r.p3+0]),u.push(p[2*r.p3+1])}l.setAttribute("position",new Float32BufferAttribute(a,3)),l.setAttribute("uv",new Float32BufferAttribute(u,2));const d=x(e,n,o,s,i,f),h=new MeshPhongMaterial({map:d,flatShading:!0});return new Mesh(l,h)}function A(e,t,r,n){const o=new BufferGeometry,s=[],i=[],l=r.vertices,a=e.colors;for(let e=0,r=t.length;e<r;e++){const r=t[e],o=r.v1,u=r.v2,c=r.v3;s.push(l[3*o+0]),s.push(l[3*o+1]),s.push(l[3*o+2]),s.push(l[3*u+0]),s.push(l[3*u+1]),s.push(l[3*u+2]),s.push(l[3*c+0]),s.push(l[3*c+1]),s.push(l[3*c+2]);const p=void 0!==r.p1?r.p1:n.pindex,d=void 0!==r.p2?r.p2:p,h=void 0!==r.p3?r.p3:p;i.push(a[3*p+0]),i.push(a[3*p+1]),i.push(a[3*p+2]),i.push(a[3*d+0]),i.push(a[3*d+1]),i.push(a[3*d+2]),i.push(a[3*h+0]),i.push(a[3*h+1]),i.push(a[3*h+2])}o.setAttribute("position",new Float32BufferAttribute(s,3)),o.setAttribute("color",new Float32BufferAttribute(i,3));const u=new MeshPhongMaterial({vertexColors:!0,flatShading:!0});return new Mesh(o,u)}function y(e){const t=new BufferGeometry;t.setIndex(new BufferAttribute(e.triangles,1)),t.setAttribute("position",new BufferAttribute(e.vertices,3));const r=new MeshPhongMaterial({name:Loader.DEFAULT_MATERIAL_NAME,color:16777215,flatShading:!0});return new Mesh(t,r)}function v(e,t){return void 0!==t.resources.texture2dgroup[e]?"texture":void 0!==t.resources.basematerials[e]?"material":void 0!==t.resources.colorgroup[e]?"vertexColors":"default"===e?"default":void 0}function w(e,t,r,n,o){const s=new Group,i=function(e,t){const r={},n=e.triangleProperties,o=t.pid;for(let e=0,t=n.length;e<t;e++){const t=n[e];let s=void 0!==t.pid?t.pid:o;void 0===s&&(s="default"),void 0===r[s]&&(r[s]=[]),r[s].push(t)}return r}(e,o),l=function(e,t,r,n,o,s){const i=Object.keys(e),l=[];for(let a=0,u=i.length;a<u;a++){const u=i[a],c=e[u];switch(v(u,n)){case"material":const e=b(n.resources.basematerials[u],c,t,r,n,o,s);for(let t=0,r=e.length;t<r;t++)l.push(e[t]);break;case"texture":const i=n.resources.texture2dgroup[u];l.push(m(i,c,t,r,n,o,s));break;case"vertexColors":const a=n.resources.colorgroup[u];l.push(A(a,c,t,s));break;case"default":l.push(y(t));break;default:}}if(s.name)for(let e=0;e<l.length;e++)l[e].name=s.name;return l}(i,e,t,r,n,o);for(let e=0,t=l.length;e<t;e++)s.add(l[e]);return s}function x(e,t,r,n,o,s){return void 0!==e.build||(e.build=s(e,t,r,n,o)),e.build}function F(e,t,r){let n;const o=e.displaypropertiesid,s=r.resources.pbmetallicdisplayproperties;if(null!==o&&void 0!==s[o]){const t=s[o].data[e.index];n=new MeshStandardMaterial({flatShading:!0,roughness:t.roughness,metalness:t.metallicness})}else n=new MeshPhongMaterial({flatShading:!0});n.name=e.name;const i=e.displaycolor,l=i.substring(0,7);return n.color.setStyle(l,COLOR_SPACE_3MF),9===i.length&&(n.opacity=parseInt(i.charAt(7)+i.charAt(8),16)/255,n.opacity<1&&(n.transparent=!0)),n}function S(e,t,r,n){const o=new Group;for(let s=0;s<e.length;s++){const i=e[s];let l=t[i.objectId];void 0===l&&(M(i.objectId,t,r,n),l=t[i.objectId]);const a=l.clone(),u=i.transform;u&&a.applyMatrix4(u),o.add(a)}return o}function M(e,r,n,o){const s=n.resources.object[e];if(s.mesh){const e=s.mesh;!function(e,r,n){if(!e)return;const o=[],s=Object.keys(e);for(let e=0;e<s.length;e++){const r=s[e];for(let e=0;e<t.availableExtensions.length;e++){const n=t.availableExtensions[e];n.ns===r&&o.push(n)}}for(let t=0;t<o.length;t++){const s=o[t];s.apply(n,e[s.ns],r)}}(n.extensions,e,n.xml),r[s.id]=x(e,r,n,o,s,w)}else{const e=s.components;r[s.id]=x(e,r,n,o,s,S)}s.name&&(r[s.id].name=s.name),n.resources.implicitfunction}const L=function(e){let t,r,o=null,s=null;const i=[],l=[];let a;const u={},c={},p=new TextDecoder;try{o=fflate.unzipSync(new Uint8Array(e))}catch(e){if(e instanceof ReferenceError)return null}let d=null;for(s in o)s.match(/\_rels\/.rels$/)?t=s:s.match(/3D\/_rels\/.*\.model\.rels$/)?r=s:s.match(/^3D\/[^\/]*\.model$/)?d=s:s.match(/^3D\/.*\.model$/)?i.push(s):s.match(/^3D\/Textures?.*/)&&l.push(s);if(void 0===t)throw new Error("THREE.ThreeMFLoader: Cannot find relationship file `rels` in 3MF archive.");null!==d&&i.push(d);const h=o[t],f=n(p.decode(h));if(r){const e=o[r];a=n(p.decode(e))}for(let e=0;e<i.length;e++){const t=i[e],r=o[t],n=p.decode(r),s=(new DOMParser).parseFromString(n,"application/xml");s.documentElement.nodeName.toLowerCase();const l=s.querySelector("model"),a={};for(let e=0;e<l.attributes.length;e++){const t=l.attributes[e];t.name.match(/^xmlns:(.+)$/)&&(a[t.value]=RegExp.$1)}const c=g(l);c.xml=l,0<Object.keys(a).length&&(c.extensions=a),u[t]=c}for(let e=0;e<l.length;e++){const t=l[e];c[t]=o[t].buffer}return{rels:f,modelRels:a,model:u,printTicket:{},texture:c}}(e),R=function(e){const t=e.model,r=e.modelRels,n={},o=Object.keys(t).reverse(),s={};if(r)for(let t=0,n=r.length;t<n;t++){const n=r[t],o=n.target.substring(1);e.texture[o]&&(s[n.target]=e.texture[o])}for(let e=0;e<o.length;e++){const r=t[o[e]],i=Object.keys(r.resources.object);for(let e=0;e<i.length;e++){M(i[e],n,r,s)}}return n}(L);return function(e,t){const r=new Group,n=function(e){for(let t=0;t<e.length;t++){const r=e[t];if("model"===r.target.split(".").pop().toLowerCase())return r}}(t.rels),o=t.model[n.target.substring(1)].build;for(let t=0;t<o.length;t++){const n=o[t],s=e[n.objectId].clone(),i=n.transform;i&&s.applyMatrix4(i),r.add(s)}return r}(R,L)}addExtension(e){this.availableExtensions.push(e)}}export{ThreeMFLoader};