import{BufferGeometry,FileLoader,Float32BufferAttribute,Loader}from"three";import{LASLoader as LoadersGLLASLoader}from"loaders-las";import{load as LASLoad}from"loaders-core";class LASZLoader extends Loader{load(e,t,r,o){const i=this,s=new FileLoader(i.manager);s.setPath(i.path),s.setResponseType("arraybuffer"),s.setRequestHeader(i.requestHeader),s.setWithCredentials(i.withCredentials),s.load(e,(e=>{if(e.byteLength<=150){if((new TextDecoder).decode(e).startsWith("version https://git-lfs.github.com/spec"))return alert("The selected file is stored in Git LFS!"),o?void o("The selected file is stored in Git LFS!"):void console.error("The selected file is stored in Git LFS!")}this.parse(e).then((e=>t(e))).catch((e=>{o?o(e):console.error(e)}))}),r,o)}async parse(e){const t=await LASLoad(e,LoadersGLLASLoader,{worker:!0}),r=t.attributes.POSITION?.value,o=t.attributes.COLOR_0?.value||t.attributes.color?.value||null,i=t.attributes.intensity?.value||null,s=t.attributes.classification?.value||null;if(!r)throw new Error("LAS/LAZ file missing POSITION attribute!");const a=new BufferGeometry;if(a.setAttribute("position",new Float32BufferAttribute(r,3)),o){const e=new Float32Array(o.length);let t=0;for(let e=0;e<o.length;e++)o[e]>t&&(t=o[e]);0===t&&(t=1);for(let r=0;r<o.length;r++)e[r]=o[r]/t;a.setAttribute("color",new Float32BufferAttribute(e,3))}if(i){let e=0;for(let t=0;t<i.length;t++)i[t]>e&&(e=i[t]);0===e&&(e=1);const t=new Float32Array(i.length);for(let r=0;r<i.length;r++)t[r]=i[r]/e;a.setAttribute("intensity",new Float32BufferAttribute(t,1))}return s&&a.setAttribute("classification",new Float32BufferAttribute(s,1)),a.computeBoundingBox(),a.computeBoundingSphere(),a}}export{LASZLoader};