import{Box3,Loader,MathUtils,Matrix4,Quaternion,Sphere,Vector3,WebGLRenderer}from"three";import{DRACOLoader}from"three/addons/loaders/DRACOLoader.min.js";import{KTX2Loader}from"three/addons/loaders/KTX2Loader.min.js";import{OGC3DTile,getOGC3DTilesCopyrightInfo}from"https://cdn.jsdelivr.net/npm/@jdultra/threedtiles@14.0.26/dist/threedtiles.es.min.js";class Three3DTilesLoader extends Loader{constructor(e){super(e),this._rootUrl="",this._keyAPI="",this._token="",this._v1=new Vector3,this._corner=new Vector3,this._R=6378137,this._renderer=null,this._maxCacheSize=100,this._dracoLoader=new DRACOLoader,this._dracoLoader.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/draco/"),this._dracoLoader.setDecoderConfig({type:"js"}),this._dracoLoader.preload(),this._ktx2Loader=new KTX2Loader,this._ktx2Loader.setTranscoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/basis/")}setRenderer(e){return this._renderer=e,this}setAPIKey(e){return this._keyAPI=e.toString(),this}setToken(e){return this._token=token.toString(),this}setMaxCacheSize(e){return"number"==typeof e&&Number.isFinite(e)?(this._maxCacheSize=Math.max(100,Math.min(5e3,e)),this):(console.warn(`Invalid maxCacheSize: ${e}. Using default.`),this)}_obbToBox3(e,t=new Box3){const{center:r,e1:i,e2:o,e3:n,halfSize:a}=e,s=a?a.x:1,l=a?a.y:1,c=a?a.z:1,d=Math.abs(i.x*s)+Math.abs(o.x*l)+Math.abs(n.x*c),h=Math.abs(i.y*s)+Math.abs(o.y*l)+Math.abs(n.y*c),u=Math.abs(i.z*s)+Math.abs(o.z*l)+Math.abs(n.z*c);return t.min.set(r.x-d,r.y-h,r.z-u),t.max.set(r.x+d,r.y+h,r.z+u),t}_boxFromSphere(e){const t=new Vector3(e.center.x,e.center.y,e.center.z),r=e.radius;return new Box3(new Vector3(t.x-r,t.y-r,t.z-r),new Vector3(t.x+r,t.y+r,t.z+r))}_computeBox3FromBoundingVolume(e){if(e.isSphere)return this._boxFromSphere(e);if(e.isOBB)return this._obbToBox3(e);if(e.box&&Array.isArray(e.box)){const t=e.box,r=new Box3;r.makeEmpty();for(let e=0;e<8;e++)this._corner.set(t[0],t[1],t[2]),this._corner.addScaledVector(this._v1.set(t[3],t[4],t[5]),1&e?1:-1),this._corner.addScaledVector(this._v1.set(t[6],t[7],t[8]),2&e?1:-1),this._corner.addScaledVector(this._v1.set(t[9],t[10],t[11]),4&e?1:-1),r.expandByPoint(this._corner);return r}if(e.region){const t=new Box3;t.makeEmpty();const[r,i,o,n,a,s]=e.region,l=[r,o],c=[i,n],d=[a,s];for(let e=0;e<2;e++)for(let r=0;r<2;r++)for(let i=0;i<2;i++){const o=l[e],n=c[r],a=d[i],s=Math.cos(n),h=(this._R+a)*s*Math.cos(o),u=(this._R+a)*Math.sin(n),m=(this._R+a)*s*Math.sin(o);t.expandByPoint(this._v1.set(h,u,m))}return t}return console.warn("Unsupported boundingVolume type, falling back to identity Box3."),new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1))}_interleaveBits3D(e){return e=2396745&((e=798915&((e=61455&(e|e<<8))|e<<4))|e<<2)}_morton3D(e,t,r){return this._interleaveBits3D(e)|this._interleaveBits3D(t)<<1|this._interleaveBits3D(r)<<2}_deinterleaveBits3D(e){return e=255&((e=61455&((e=798915&((e&=2396745)|e>>2))|e>>4))|e>>8)}_decodeMorton3D(e){return[this._deinterleaveBits3D(e),this._deinterleaveBits3D(e>>1),this._deinterleaveBits3D(e>>2)]}_interleaveBits2D(e){return e=21845&((e=13107&((e=3855&(e|e<<4))|e<<2))|e<<1)}_morton2D(e,t){return this._interleaveBits2D(e)|this._interleaveBits2D(t)<<1}_decodeMorton2D(e){return[1&e,e>>1&1,0]}_computeMortonIndex(e,t,r,i,o,n=!1){const a=e-o,s=(1<<a)-1,l=t&s,c=r&s;if(n){const e=this._morton2D(l,c);return(Math.pow(4,a)-1)/3+e}{const e=i&s,t=this._morton3D(l,c,e);return(Math.pow(8,a)-1)/7+t}}_replaceTemplate(e,t,r,i,o){return e.replace("{level}",t).replace("{x}",r).replace("{y}",i).replace("{z}",o)}_computeChildBox(e,t,r,i,o=!1){const n=new Array(12);for(let t=3;t<9;t++)n[t]=.5*e[t];o?(n[9]=e[9],n[10]=e[10],n[11]=e[11]):(n[9]=.5*e[9],n[10]=.5*e[10],n[11]=.5*e[11]);const a=t?.5:-.5,s=r?.5:-.5,l=o?0:i?.5:-.5;return n[0]=e[0]+e[3]*a+e[6]*s+e[9]*l,n[1]=e[1]+e[4]*a+e[7]*s+e[10]*l,n[2]=e[2]+e[5]*a+e[8]*s+e[11]*l,n}_computeChildRegion(e,t,r,i,o=!1){const[n,a,s,l,c,d]=e,h=.5*(s-n),u=.5*(d-c);return[n+t*h,a+r*h,n+(t+1)*h,a+(r+1)*(.5*(l-a)),o?c:c+i*u,o?d:c+(i+1)*u]}_computeChildBoundingVolume(e,t,r,i,o=!1){return e.box?{box:this._computeChildBox(e.box,t,r,i,o)}:e.region?{region:this._computeChildRegion(e.region,t,r,i,o)}:e}_decodeBitstream(e,t,r){const i=e.bufferViews[r],o=i.byteOffset||0,n=o+i.byteLength,a=t.subarray(o,n),s=new Uint8Array(8*a.length);for(let e=0;e<a.length;e++){const t=a[e];for(let r=0;r<8;r++)s[8*e+r]=t>>r&1}return s}_checkAvailability(e,t,r,i){if(!e)return!1;if(void 0!==e.constant)return 1===e.constant;if(void 0!==e.bitstream){const o=e.bitstream,n=i.bufferViews[o].byteOffset||0,a=t%8,s=Math.floor(t/8);return 1==(r.getUint8(n+s)>>a&1)}return!1}_getAvailability(e,t,r){if(!t)return{0:0};if(void 0!==t.constant){const e=t.constant;return new Proxy({},{get:(t,r)=>"length"===r?1e6:e})}return e&&void 0!==t.bitstream?this._decodeBitstream(e,r,t.bitstream):{0:0}}_parseSubtree(e){const t=new DataView(e);if("subt"!==String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3)))throw new Error("Invalid subtree magic");t.getUint32(4,!0);const r=Number(t.getBigUint64(8,!0)),i=Number(t.getBigUint64(16,!0)),o=new Uint8Array(e,24,r),n=(new TextDecoder).decode(o),a=24+r;return{subtreeJson:JSON.parse(n),binary:new Uint8Array(e,a,i),binaryView:new DataView(e,a,i)}}async _resolveImplicit(e,t,r=0,i=0,o=0,n=0){const a=e.root?.implicitTiling||e.implicitTiling;if(!a)return e;const s="QUADTREE"===a.subdivisionScheme,l=s?4:8,c=a.subtreeLevels,d=Math.floor(r/c)*c,h=t.substring(0,t.lastIndexOf("/")+1),u=h+this._replaceTemplate(a.subtrees.uri,d,i>>r-d,o>>r-d,s?0:n>>r-d),m=await fetch(u).then((e=>e.arrayBuffer())),{subtreeJson:_,binary:p,binaryView:y}=this._parseSubtree(m),g=this._getAvailability(_,_.tileAvailability,p),b=this._getAvailability(_,_.contentAvailability[0],p),f=(this._getAvailability(_,_.childSubtreeAvailability,p),async(r,i,o,n)=>{const u=this._computeMortonIndex(r,i,o,n||0,d,s);if(1!==g[u])return null;if(!this._checkAvailability(_.tileAvailability,u,y,_))return null;this._checkAvailability(_.contentAvailability[0],u,y,_);const m={boundingVolume:this._computeChildBoundingVolume(e.root.boundingVolume,i,o,n,s),geometricError:e.root.geometricError/Math.pow(2,r),refine:e.root.refine||"REPLACE",content:1===b[u]?{uri:h+this._replaceTemplate(e.root.content.uri,r,i,o,s?0:n)}:void 0,children:[]},p=(r+1)%c==0,x=r+1;if(x<a.availableLevels)for(let r=0;r<l;r++){const[a,l,c]=s?this._decodeMorton2D(r):this._decodeMorton3D(r),h=2*i+a,u=2*o+l,g=s?0:2*n+c;if(p){const r=(1<<x-d)-1,i=h&r,o=u&r,n=g&r,a=s?this._morton2D(i,o):this._morton3D(i,o,n);if(this._checkAvailability(_.childSubtreeAvailability,a,y,_)){const r=await this._resolveImplicit(e,t,x,h,u,g);m.children.push(r.root)}}else{const e=await f(x,h,u,g);e&&m.children.push(e)}}return m}),x=await f(r,i,o,n);return{asset:e.asset,root:x}}load(e,t,r,i){this.loadAsync(e).then((e=>(t&&t(e),e))).catch((e=>(i?i(e):console.error(e),null)))}async loadAsync(e){const t=this;t._rootUrl=e;const r=e.substring(0,e.lastIndexOf("/")+1);try{t._renderer||(t._renderer=new WebGLRenderer({antialias:!1})),t._ktx2Loader.detectSupport(t._renderer);let i=await fetch(e).then((e=>e.json()));const o=i.asset?.version||null;i=await t._resolveImplicit(i,e);const n=await new Promise((o=>{o(new OGC3DTile({url:e,json:i,centerModel:!0,rootPath:r,displayErrors:!0,loadOutsideView:!0,renderer:t._renderer,loadingStrategy:"PERLEVEL",geometricErrorMultiplier:.5,ktx2Loader:t._ktx2Loader,dracoLoader:t._dracoLoader,maxCacheSize:t._maxCacheSize,queryParams:""!==t._keyAPI?{key:t._keyAPI}:void 0,headers:t._token?{Authorization:`Bearer ${t._token}`}:void 0,meshCallback:e=>{e.material.wireframe=this._wireframeMode||!1},pointsCallback:e=>{e.material.size=this._pointTargetSize||1}}))})),a=n.boundingVolume,s=(new Matrix4).fromArray(n.matrix.elements),l=new Vector3,c=new Quaternion,d=new Vector3;let h;s.decompose(l,c,d);let u=!1;const m=0===c.x&&0===c.y&&0===c.z&&1===c.w,_=new Vector3(a.center.x,a.center.y,a.center.z),p=n.tileLoader.zUpToYUpMatrix,y=_.clone().normalize(),g=new Vector3(0,1,0),b=y.angleTo(g),f=_.length()>1e6;if(f&&MathUtils.radToDeg(b)>.1){const e=(new Quaternion).setFromUnitVectors(y,g);n.quaternion.copy(e),u=!0}else f||m?f&&(h=(new Matrix4).makeRotationX(MathUtils.degToRad(90)),n.quaternion.setFromRotationMatrix(h),u=!0):(h=(new Matrix4).makeRotationX(MathUtils.degToRad(-90)),n.quaternion.setFromRotationMatrix(h),u=!0);(1!==n.scale.x||1!==n.scale.y||1!==n.scale.z)&&n.scale.set(1,1,1);const x=t._computeBox3FromBoundingVolume(a);if(u)if(h)x.applyMatrix4(h);else{const e=n.quaternion,t=(new Matrix4).makeRotationFromQuaternion(e);x.applyMatrix4(t)}else"1.0"===o&&x.applyMatrix4(p);const w=x.getBoundingSphere(new Sphere).center.clone();n.position.copy(w).multiplyScalar(-1),x.translate(w.clone().multiplyScalar(-1)),n.boundingBox=x,n._wireframeMode=!1,n.setWireframe=e=>{n._wireframeMode=!!e},n._pointTargetSize=1,n.setPointSize=e=>{n._pointTargetSize=e},n._syncMaterials=()=>{n.traverse((e=>{if(e.isMesh){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{e&&e.wireframe!==n._wireframeMode&&(e.wireframe=n._wireframeMode)}))}else e.isPoints&&e.material&&e.material.size!==n._pointTargetSize&&(e.material.size=n._pointTargetSize,e.material.needsUpdate=!0)}))};const M=n.update.bind(n);n.update=function(e){M(e),this._syncMaterials()},n.frameCamera=function(e){n.updateMatrixWorld(!0);const t=n.boundingBox,r=t.getSize(new Vector3),i=t.getCenter(new Vector3),o=MathUtils.degToRad(e.fov),a=Math.max(r.x,r.y,r.z)/2/Math.tan(o/2);e.position.set(i.x,i.y,i.z+a+30),e.lookAt(i),e.updateProjectionMatrix()},n._cleanupRegister=e=>{for(const t in e.register){const r=e.register[t],i=null===r||0===Object.keys(r).length,o=!!e.cache.get(t);(i||o)&&delete e.register[t]}},n.getStreamingInfo=()=>{const e=n.tileLoader,t=(window.concurrentDownloads??0)>0,r=Object.values(e.register).some((e=>Object.keys(e).length>0)),i=e.downloads.length>0||e.ready.length>0;return i||n._cleanupRegister(e),t||r||i};const v=n.dispose.bind(n);n.dispose=function(){return n.parent&&n.parent.remove(n),n.traverse((e=>{if((e.isMesh||e.isPoints)&&(e.geometry&&(e.geometry.dispose(),e.geometry=null),e.material)){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{for(const t in e)e[t]&&e[t].isTexture&&(e[t].dispose(),e[t]=null);e.dispose()})),e.material=null}})),"function"==typeof v&&v(),console.log("OGC3DTileset and GPU resources disposed."),!0};const B=getOGC3DTilesCopyrightInfo();return B.length>0&&console.log("Copyright Info: ",B),n}catch(e){throw console.error(e),e}}}export{Three3DTilesLoader};