import{Box3,Loader,MathUtils,Matrix4,Quaternion,Sphere,Vector3,WebGLRenderer}from"three";import{DRACOLoader}from"three/addons/loaders/DRACOLoader.min.js";import{KTX2Loader}from"three/addons/loaders/KTX2Loader.min.js";import*as OGC3D from"https://cdn.jsdelivr.net/npm/@jdultra/threedtiles@14.0.26/dist/threedtiles.es.min.js";class Three3DTilesLoader extends Loader{constructor(e){super(e),this._rootUrl="",this._keyAPI="",this._token="",this._variantLookup=new Map,this._v1=new Vector3,this._corner=new Vector3,this._R=6378137,this._renderer=null,this._maxCacheSize=100,this._dracoLoader=new DRACOLoader,this._dracoLoader.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/draco/"),this._dracoLoader.setDecoderConfig({type:"js"}),this._dracoLoader.preload(),this._ktx2Loader=new KTX2Loader,this._ktx2Loader.setTranscoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/basis/")}setRenderer(e){return this._renderer=e,this}setAPIKey(e){return this._keyAPI=e.toString(),this}setToken(e){return this._token=token.toString(),this}setMaxCacheSize(e){return"number"==typeof e&&Number.isFinite(e)?(this._maxCacheSize=Math.max(100,Math.min(5e3,e)),this):(console.warn(`Invalid maxCacheSize: ${e}. Using default.`),this)}_obbToBox3(e,t=new Box3){const{center:r,e1:i,e2:n,e3:o,halfSize:a}=e,s=a?a.x:1,l=a?a.y:1,c=a?a.z:1,h=Math.abs(i.x*s)+Math.abs(n.x*l)+Math.abs(o.x*c),d=Math.abs(i.y*s)+Math.abs(n.y*l)+Math.abs(o.y*c),u=Math.abs(i.z*s)+Math.abs(n.z*l)+Math.abs(o.z*c);return t.min.set(r.x-h,r.y-d,r.z-u),t.max.set(r.x+h,r.y+d,r.z+u),t}_boxFromSphere(e){const t=new Vector3(e.center.x,e.center.y,e.center.z),r=e.radius;return new Box3(new Vector3(t.x-r,t.y-r,t.z-r),new Vector3(t.x+r,t.y+r,t.z+r))}_computeBox3FromBoundingVolume(e){if(e.isSphere)return this._boxFromSphere(e);if(e.isOBB)return this._obbToBox3(e);if(e.box&&Array.isArray(e.box)){const t=e.box,r=new Box3;r.makeEmpty();for(let e=0;e<8;e++)this._corner.set(t[0],t[1],t[2]),this._corner.addScaledVector(this._v1.set(t[3],t[4],t[5]),1&e?1:-1),this._corner.addScaledVector(this._v1.set(t[6],t[7],t[8]),2&e?1:-1),this._corner.addScaledVector(this._v1.set(t[9],t[10],t[11]),4&e?1:-1),r.expandByPoint(this._corner);return r}if(e.region){const t=new Box3;t.makeEmpty();const[r,i,n,o,a,s]=e.region,l=[r,n],c=[i,o],h=[a,s];for(let e=0;e<2;e++)for(let r=0;r<2;r++)for(let i=0;i<2;i++){const n=l[e],o=c[r],a=h[i],s=Math.cos(o),d=(this._R+a)*s*Math.cos(n),u=(this._R+a)*Math.sin(o),m=(this._R+a)*s*Math.sin(n);t.expandByPoint(this._v1.set(d,u,m))}return t}return console.warn("Unsupported boundingVolume type, falling back to identity Box3."),new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1))}_interleaveBits3D(e){return e=2396745&((e=798915&((e=61455&(e|e<<8))|e<<4))|e<<2)}_morton3D(e,t,r){return this._interleaveBits3D(e)|this._interleaveBits3D(t)<<1|this._interleaveBits3D(r)<<2}_deinterleaveBits3D(e){return e=255&((e=61455&((e=798915&((e&=2396745)|e>>2))|e>>4))|e>>8)}_decodeMorton3D(e){return[this._deinterleaveBits3D(e),this._deinterleaveBits3D(e>>1),this._deinterleaveBits3D(e>>2)]}_interleaveBits2D(e){return e=21845&((e=13107&((e=3855&(e|e<<4))|e<<2))|e<<1)}_morton2D(e,t){return this._interleaveBits2D(e)|this._interleaveBits2D(t)<<1}_decodeMorton2D(e){return[1&e,e>>1&1,0]}_computeMortonIndex(e,t,r,i,n,o=!1){const a=e-n,s=(1<<a)-1,l=t&s,c=r&s;if(o){const e=this._morton2D(l,c);return(Math.pow(4,a)-1)/3+e}{const e=i&s,t=this._morton3D(l,c,e);return(Math.pow(8,a)-1)/7+t}}_replaceTemplate(e,t,r,i,n){let o=e.replace("{level}",t).replace("{x}",r).replace("{y}",i).replace("{z}",n);return o.startsWith("/")&&(o=o.substring(1)),o}_computeChildBox(e,t,r,i,n=!1){const o=new Array(12);for(let t=3;t<9;t++)o[t]=.5*e[t];n?(o[9]=e[9],o[10]=e[10],o[11]=e[11]):(o[9]=.5*e[9],o[10]=.5*e[10],o[11]=.5*e[11]);const a=t?.5:-.5,s=r?.5:-.5,l=n?0:i?.5:-.5;return o[0]=e[0]+e[3]*a+e[6]*s+e[9]*l,o[1]=e[1]+e[4]*a+e[7]*s+e[10]*l,o[2]=e[2]+e[5]*a+e[8]*s+e[11]*l,o}_computeChildRegion(e,t,r,i,n=!1){const[o,a,s,l,c,h]=e,d=.5*(s-o),u=.5*(h-c);return[o+t*d,a+r*d,o+(t+1)*d,a+(r+1)*(.5*(l-a)),n?c:c+i*u,n?h:c+(i+1)*u]}_computeChildBoundingVolume(e,t,r,i,n=!1){return e.box?{box:this._computeChildBox(e.box,t,r,i,n)}:e.region?{region:this._computeChildRegion(e.region,t,r,i,n)}:e}_decodeBitstream(e,t,r){const i=e.bufferViews[r],n=i.byteOffset||0,o=n+i.byteLength,a=t.subarray(n,o),s=new Uint8Array(8*a.length);for(let e=0;e<a.length;e++){const t=a[e];for(let r=0;r<8;r++)s[8*e+r]=t>>r&1}return s}_checkAvailability(e,t,r,i){if(!e)return!1;if(void 0!==e.constant)return 1===e.constant;if(void 0!==e.bitstream){const n=e.bitstream,o=i.bufferViews[n].byteOffset||0,a=t%8,s=Math.floor(t/8);return 1==(r.getUint8(o+s)>>a&1)}return!1}_getAvailability(e,t,r){if(!t)return{0:0};if(void 0!==t.constant){const e=t.constant;return new Proxy({},{get:(t,r)=>"length"===r?1e6:e})}return e&&void 0!==t.bitstream?this._decodeBitstream(e,r,t.bitstream):{0:0}}_parseSubtree(e){const t=new DataView(e);if("subt"!==String.fromCharCode(t.getUint8(0),t.getUint8(1),t.getUint8(2),t.getUint8(3)))throw new Error("Invalid subtree magic");t.getUint32(4,!0);const r=Number(t.getBigUint64(8,!0)),i=Number(t.getBigUint64(16,!0)),n=new Uint8Array(e,24,r),o=(new TextDecoder).decode(n),a=24+r;return{subtreeJson:JSON.parse(o),binary:new Uint8Array(e,a,i),binaryView:new DataView(e,a,i)}}async _flattenExplicitContents(e){if(e.contents&&Array.isArray(e.contents)){if(e.contents.length>1){e.children||(e.children=[]);for(let t=0;t<e.contents.length;t++){let r=e.contents[t].uri;r.startsWith("/")&&(r=r.substring(1)),this._variantLookup.set(r,t),e.children.push({content:e.contents[t],boundingVolume:e.boundingVolume,geometricError:0,refine:"ADD"})}}delete e.contents}if(e.children)for(const t of e.children)await this._flattenExplicitContents(t)}async _resolveImplicit(e,t,r=0,i=0,n=0,o=0){const a=e.root,s=a?.implicitTiling||e.implicitTiling;if(!s)return e;const l="QUADTREE"===s.subdivisionScheme,c=l?4:8,h=s.subtreeLevels,d=Math.floor(r/h)*h,u=t+this._replaceTemplate(s.subtrees.uri,d,i>>r-d,n>>r-d,l?0:o>>r-d),m=await fetch(u).then((e=>e.arrayBuffer())),{subtreeJson:p,binary:_,binaryView:g}=this._parseSubtree(m),f=this._getAvailability(p,p.tileAvailability,_),y=p.contentAvailability.map((e=>this._getAvailability(p,e,_))),b=a.contents||(a.content?[a.content]:[]),x=async(r,i,n,o)=>{const u=this._computeMortonIndex(r,i,n,o||0,d,l);if(1!==f[u])return null;const m=[];b.forEach(((e,a)=>{const s=y[a];if(s&&1===s[u]){const s=this._replaceTemplate(e.uri,r,i,n,l?0:o),c=t+s;s.startsWith("/")&&(s=s.substring(1)),this._variantLookup.set(s,a),m.push({uri:c})}}));const _={boundingVolume:this._computeChildBoundingVolume(a.boundingVolume,i,n,o,l),geometricError:a.geometricError/Math.pow(2,r),refine:a.refine||"REPLACE",children:[]};if(m.length>0&&(_.content=m[0],m.length>1))for(let e=1;e<m.length;e++)_.children.push({content:m[e],boundingVolume:_.boundingVolume,geometricError:0,refine:"ADD"});const w=(r+1)%h==0,M=r+1;if(M<s.availableLevels)for(let r=0;r<c;r++){const[a,s,c]=l?this._decodeMorton2D(r):this._decodeMorton3D(r),h=2*i+a,u=2*n+s,m=l?0:2*o+c;if(w){const r=(1<<M-d)-1,i=l?this._morton2D(h&r,u&r):this._morton3D(h&r,u&r,m&r);if(this._checkAvailability(p.childSubtreeAvailability,i,g,p)){const r=await this._resolveImplicit(e,t,M,h,u,m);_.children.push(r.root)}}else{const e=await x(M,h,u,m);e&&_.children.push(e)}}return _},w=await x(r,i,n,o);return{asset:e.asset,root:w}}load(e,t,r,i){this.loadAsync(e).then((e=>(t&&t(e),e))).catch((e=>(i?i(e):console.error(e),null)))}async loadAsync(e){const t=this;t._rootUrl=e;const r=e.substring(0,e.lastIndexOf("/")+1);try{t._renderer||(t._renderer=new WebGLRenderer({antialias:!1})),t._ktx2Loader.detectSupport(t._renderer);let i=await fetch(e).then((e=>e.json()));const n=i.asset?.version||null,o=i.root.contents?.length>1,a=i.root.implicitTiling&&i.root.implicitTiling.contentAvailability?.length>1,s=o||a;i=await t._resolveImplicit(i,r),await t._flattenExplicitContents(i.root);const l=await new Promise((n=>{new OGC3D.OGC3DTile({url:e,json:i,centerModel:!0,rootPath:r,displayErrors:!0,loadOutsideView:!0,renderer:t._renderer,loadingStrategy:"PERLEVEL",geometricErrorMultiplier:.5,ktx2Loader:t._ktx2Loader,dracoLoader:t._dracoLoader,maxCacheSize:t._maxCacheSize,queryParams:""!==t._keyAPI?{key:t._keyAPI}:void 0,headers:t._token?{Authorization:`Bearer ${t._token}`}:void 0,meshCallback:e=>{e.material.wireframe=this._wireframeMode||!1},pointsCallback:e=>{e.material.size=this._pointTargetSize||1},onLoadCallback:e=>n(e)})})),c=l.boundingVolume,h=(new Matrix4).fromArray(l.matrix.elements),d=new Vector3,u=new Quaternion,m=new Vector3;let p;h.decompose(d,u,m);let _=!1;const g=0===u.x&&0===u.y&&0===u.z&&1===u.w,f=new Vector3(c.center.x,c.center.y,c.center.z),y=l.tileLoader.zUpToYUpMatrix,b=f.clone().normalize(),x=new Vector3(0,1,0),w=b.angleTo(x),M=f.length()>1e6;if(M&&MathUtils.radToDeg(w)>.1){const e=(new Quaternion).setFromUnitVectors(b,x);l.quaternion.copy(e),_=!0}else M||g?M&&(p=(new Matrix4).makeRotationX(MathUtils.degToRad(90)),l.quaternion.setFromRotationMatrix(p),_=!0):(p=(new Matrix4).makeRotationX(MathUtils.degToRad(-90)),l.quaternion.setFromRotationMatrix(p),_=!0);(1!==l.scale.x||1!==l.scale.y||1!==l.scale.z)&&l.scale.set(1,1,1);const v=t._computeBox3FromBoundingVolume(c);if(_)if(p)v.applyMatrix4(p);else{const e=l.quaternion,t=(new Matrix4).makeRotationFromQuaternion(e);v.applyMatrix4(t)}else"1.0"===n&&v.applyMatrix4(y);const D=v.getBoundingSphere(new Sphere).center.clone();l.position.copy(D).multiplyScalar(-1),v.translate(D.clone().multiplyScalar(-1)),l.boundingBox=v,s&&(l.userData.rootPath=r,l.userData.hasMultipleContents=!0,l.userData.variantLookup=this._variantLookup),l._wireframeMode=!1,l.setWireframe=e=>{l._wireframeMode=!!e},l._pointTargetSize=1,l.setPointSize=e=>{l._pointTargetSize=e},l._syncMaterials=()=>{l.traverse((e=>{if(e.isMesh){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{e&&e.wireframe!==l._wireframeMode&&(e.wireframe=l._wireframeMode)}))}else e.isPoints&&e.material&&e.material.size!==l._pointTargetSize&&(e.material.size=l._pointTargetSize,e.material.needsUpdate=!0)}))};const B=l.update.bind(l);l.update=function(e){B(e),this._syncMaterials()},l.frameCamera=function(e){l.updateMatrixWorld(!0);const t=l.boundingBox,r=t.getSize(new Vector3),i=t.getCenter(new Vector3),n=MathUtils.degToRad(e.fov),o=Math.max(r.x,r.y,r.z)/2/Math.tan(n/2);e.position.set(i.x,i.y,i.z+o+30),e.lookAt(i),e.updateProjectionMatrix()},l._cleanupRegister=e=>{for(const t in e.register){const r=e.register[t],i=null===r||0===Object.keys(r).length,n=!!e.cache.get(t);(i||n)&&delete e.register[t]}},l.getStreamingInfo=()=>{const e=l.tileLoader,t=(window.concurrentDownloads??0)>0,r=Object.values(e.register).some((e=>Object.keys(e).length>0)),i=e.downloads.length>0||e.ready.length>0;return i||l._cleanupRegister(e),t||r||i};const V=l.dispose.bind(l);l.dispose=function(){return l.parent&&l.parent.remove(l),l.traverse((e=>{if((e.isMesh||e.isPoints)&&(e.geometry&&(e.geometry.dispose(),e.geometry=null),e.material)){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{for(const t in e)e[t]&&e[t].isTexture&&(e[t].dispose(),e[t]=null);e.dispose()})),e.material=null}})),"function"==typeof V&&V(),console.log("OGC3DTileset and GPU resources disposed."),!0};return OGC3D.getOGC3DTilesCopyrightInfo().length>0&&(l.showCopyright(),l.copyrightVisible=!0),l}catch(e){throw console.error(e),e}}}export{Three3DTilesLoader};