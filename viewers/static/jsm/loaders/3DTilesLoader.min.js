import{Box3,Loader,MathUtils,Matrix4,Quaternion,Sphere,Vector3,WebGLRenderer}from"three";import{DRACOLoader}from"three/addons/loaders/DRACOLoader.min.js";import{KTX2Loader}from"three/addons/loaders/KTX2Loader.min.js";import{OGC3DTile,getOGC3DTilesCopyrightInfo}from"https://cdn.jsdelivr.net/npm/@jdultra/threedtiles@14.0.26/dist/threedtiles.es.min.js";class Three3DTilesLoader extends Loader{constructor(e){super(e),this._keyAPI="",this._token="",this._v1=new Vector3,this._corner=new Vector3,this._R=6378137,this._renderer=null,this._maxCacheSize=100,this._dracoLoader=new DRACOLoader,this._dracoLoader.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/draco/"),this._dracoLoader.setDecoderConfig({type:"js"}),this._dracoLoader.preload(),this._ktx2Loader=new KTX2Loader,this._ktx2Loader.setTranscoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/basis/")}setRenderer(e){return this._renderer=e,this}setAPIKey(e){return this._keyAPI=e.toString(),this}setToken(e){return this._token=token.toString(),this}setMaxCacheSize(e){return"number"==typeof e&&Number.isFinite(e)?(this._maxCacheSize=Math.max(100,Math.min(5e3,e)),this):(console.warn(`Invalid maxCacheSize: ${e}. Using default.`),this)}_obbToBox3(e,t=new Box3){const{center:r,e1:o,e2:a,e3:n,halfSize:i}=e,s=i?i.x:1,l=i?i.y:1,c=i?i.z:1,d=Math.abs(o.x*s)+Math.abs(a.x*l)+Math.abs(n.x*c),h=Math.abs(o.y*s)+Math.abs(a.y*l)+Math.abs(n.y*c),m=Math.abs(o.z*s)+Math.abs(a.z*l)+Math.abs(n.z*c);return t.min.set(r.x-d,r.y-h,r.z-m),t.max.set(r.x+d,r.y+h,r.z+m),t}_boxFromSphere(e){const t=new Vector3(e.center.x,e.center.y,e.center.z),r=e.radius;return new Box3(new Vector3(t.x-r,t.y-r,t.z-r),new Vector3(t.x+r,t.y+r,t.z+r))}_computeBox3FromBoundingVolume(e,t){if(e.isSphere)return this._boxFromSphere(e);if(e.isOBB)return this._obbToBox3(e);if(e.box&&Array.isArray(e.box)){const r=e.box,o=new Box3;o.makeEmpty();for(let e=0;e<8;e++)this._corner.set(r[0],r[1],r[2]),this._corner.addScaledVector(this._v1.set(r[3],r[4],r[5]),1&e?1:-1),this._corner.addScaledVector(this._v1.set(r[6],r[7],r[8]),2&e?1:-1),this._corner.addScaledVector(this._v1.set(r[9],r[10],r[11]),4&e?1:-1),o.expandByPoint(this._corner);return o.min.multiply(t),o.max.multiply(t),o}if(e.region){const e=new Box3;e.makeEmpty();const[t,r,o,a,n,i]=region,s=[t,o],l=[r,a],c=[n,i];for(let t=0;t<2;t++)for(let r=0;r<2;r++)for(let o=0;o<2;o++){const a=s[t],n=l[r],i=c[o],d=Math.cos(n),h=(this._R+i)*d*Math.cos(a),m=(this._R+i)*Math.sin(n),p=(this._R+i)*d*Math.sin(a);e.expandByPoint(this._v1.set(h,m,p))}return e}return console.warn("Unsupported boundingVolume type, falling back to identity Box3."),new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1))}load(e,t,r,o){this.loadAsync(e).then((e=>(t&&t(e),e))).catch((e=>(o?o(e):console.error(e),null)))}async loadAsync(e){const t=this;try{t._renderer||(t._renderer=new WebGLRenderer({antialias:!1})),t._ktx2Loader.detectSupport(t._renderer);const r=await fetch(e).then((e=>e.json())),o=r.asset?.version||null,a=await new Promise((r=>{const o=new OGC3DTile({url:e,centerModel:!0,displayErrors:!0,loadOutsideView:!0,renderer:t._renderer,loadingStrategy:"PERLEVEL",geometricErrorMultiplier:.5,ktx2Loader:t._ktx2Loader,dracoLoader:t._dracoLoader,maxCacheSize:t._maxCacheSize,queryParams:""!==t._keyAPI?{key:t._keyAPI}:void 0,headers:t._token?{Authorization:`Bearer ${t._token}`}:void 0,meshCallback:e=>{e.material.wireframe=this._wireframeMode||!1},pointsCallback:e=>{e.material.size=this._pointTargetSize||1},onLoadCallback:()=>r(o)})})),n=a.boundingVolume,i=(new Matrix4).fromArray(a.matrix.elements),s=new Vector3,l=new Quaternion,c=new Vector3;let d;i.decompose(s,l,c);let h=!1;const m=0===l.x&&0===l.y&&0===l.z&&1===l.w,p=new Vector3(n.center.x,n.center.y,n.center.z),u=a.tileLoader.zUpToYUpMatrix,x=p.clone().normalize(),y=new Vector3(0,1,0),_=x.angleTo(y),g=p.length()>1e6;if(g&&MathUtils.radToDeg(_)>.1){const e=(new Quaternion).setFromUnitVectors(x,y);a.quaternion.copy(e),h=!0}else g||m?g&&(d=(new Matrix4).makeRotationX(MathUtils.degToRad(90)),a.quaternion.setFromRotationMatrix(d),h=!0):(d=(new Matrix4).makeRotationX(MathUtils.degToRad(-90)),a.quaternion.setFromRotationMatrix(d),h=!0);let w=new Vector3(a.scale.x,a.scale.y,a.scale.z);(1!==w.x||1!==w.y||1!==w.z)&&a.scale.set(1,1,1);const f=t._computeBox3FromBoundingVolume(n,w);if(h)if(d)f.applyMatrix4(d);else{const e=a.quaternion,t=(new Matrix4).makeRotationFromQuaternion(e);f.applyMatrix4(t)}else"1.0"===o&&f.applyMatrix4(u);const M=f.getBoundingSphere(new Sphere).center.clone();a.position.copy(M).multiplyScalar(-1),f.translate(M.clone().multiplyScalar(-1)),a.boundingBox=f,a._wireframeMode=!1,a.setWireframe=e=>{a._wireframeMode=!!e},a._pointTargetSize=1,a.setPointSize=e=>{a._pointTargetSize=e},a._syncMaterials=()=>{a.traverse((e=>{if(e.isMesh){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{e&&e.wireframe!==a._wireframeMode&&(e.wireframe=a._wireframeMode)}))}else e.isPoints&&e.material&&e.material.size!==a._pointTargetSize&&(e.material.size=a._pointTargetSize,e.material.needsUpdate=!0)}))};const b=a.update.bind(a);a.update=function(e){b(e),this._syncMaterials()},a.frameCamera=function(e){a.updateMatrixWorld(!0);const t=a.boundingBox,r=t.getSize(new Vector3),o=t.getCenter(new Vector3),n=MathUtils.degToRad(e.fov),i=Math.max(r.x,r.y,r.z)/2/Math.tan(n/2);e.position.set(o.x,o.y,o.z+i+30),e.lookAt(o),e.updateProjectionMatrix()},a._cleanupRegister=e=>{for(const t in e.register){e.cache.get(t)&&delete e.register[t]}},a.getStreamingInfo=()=>{const e=a.tileLoader,t=(window.concurrentDownloads??0)>0,r=Object.values(e.register).some((e=>Object.keys(e).length>0)),o=e.downloads.length>0||e.ready.length>0;return o||a._cleanupRegister(e),t||r||o};const z=a.dispose.bind(a);a.dispose=function(){return a.parent&&a.parent.remove(a),a.traverse((e=>{if((e.isMesh||e.isPoints)&&(e.geometry&&(e.geometry.dispose(),e.geometry=null),e.material)){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{for(const t in e)e[t]&&e[t].isTexture&&(e[t].dispose(),e[t]=null);e.dispose()})),e.material=null}})),"function"==typeof z&&z(),console.log("OGC3DTileset and GPU resources disposed."),!0};const S=getOGC3DTilesCopyrightInfo();return S.length>0&&console.log("Copyright Info: ",S),a}catch(e){throw console.error(e),e}}}export{Three3DTilesLoader};