import{Box3,Loader,MathUtils,Matrix4,Quaternion,Sphere,Vector3,WebGLRenderer}from"three";import{DRACOLoader}from"three/addons/loaders/DRACOLoader.min.js";import{KTX2Loader}from"three/addons/loaders/KTX2Loader.min.js";import{OGC3DTile}from"https://cdn.jsdelivr.net/npm/@jdultra/threedtiles@14.0.26/dist/threedtiles.es.min.js";class Three3DTilesLoader extends Loader{constructor(e){super(e),this._pointTargetSize=.01,this._v1=new Vector3,this._corner=new Vector3,this._R=6378137,this._renderer=null,this._maxCacheSize=100,this._geometricErrorMultiplier=1,this._dracoLoader=new DRACOLoader,this._dracoLoader.setDecoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/draco/"),this._dracoLoader.setDecoderConfig({type:"js"}),this._dracoLoader.preload(),this._ktx2Loader=new KTX2Loader,this._ktx2Loader.setTranscoderPath("https://cdn.jsdelivr.net/npm/three@0.182.0/examples/jsm/libs/basis/")}setRenderer(e){return this._renderer=e,this}setMaxPointSize(e){return"number"==typeof e&&Number.isFinite(e)?(this._pointTargetSize=Math.max(.01,Math.min(3,e)),this):(console.warn(`Invalid maxPointSize: ${e}. Using default.`),this)}setMaxCacheSize(e){return"number"==typeof e&&Number.isFinite(e)?(this._maxCacheSize=Math.max(100,Math.min(5e3,e)),this):(console.warn(`Invalid maxCacheSize: ${e}. Using default.`),this)}setGeometricErrorMultiplier(e){return"number"==typeof e&&Number.isFinite(e)?(this._geometricErrorMultiplier=Math.max(.1,Math.min(5,e)),this):(console.warn(`Invalid errorMultiplier: ${e}. Using default.`),this)}_obbToBox3(e,t=new Box3){const{center:r,e1:i,e2:o,e3:a,halfSize:n}=e,s=n?n.x:1,l=n?n.y:1,c=n?n.z:1,h=Math.abs(i.x*s)+Math.abs(o.x*l)+Math.abs(a.x*c),d=Math.abs(i.y*s)+Math.abs(o.y*l)+Math.abs(a.y*c),m=Math.abs(i.z*s)+Math.abs(o.z*l)+Math.abs(a.z*c);return t.min.set(r.x-h,r.y-d,r.z-m),t.max.set(r.x+h,r.y+d,r.z+m),t}_boxFromSphere(e){const t=new Vector3(e.center.x,e.center.y,e.center.z),r=e.radius;return new Box3(new Vector3(t.x-r,t.y-r,t.z-r),new Vector3(t.x+r,t.y+r,t.z+r))}_computeBox3FromBoundingVolume(e,t){if(e.isSphere)return this._boxFromSphere(e);if(e.isOBB)return this._obbToBox3(e);if(e.box&&Array.isArray(e.box)){const r=e.box,i=new Box3;i.makeEmpty();for(let e=0;e<8;e++)this._corner.set(r[0],r[1],r[2]),this._corner.addScaledVector(this._v1.set(r[3],r[4],r[5]),1&e?1:-1),this._corner.addScaledVector(this._v1.set(r[6],r[7],r[8]),2&e?1:-1),this._corner.addScaledVector(this._v1.set(r[9],r[10],r[11]),4&e?1:-1),i.expandByPoint(this._corner);return i.min.multiply(t),i.max.multiply(t),i}if(e.region){const e=new Box3;e.makeEmpty();const[t,r,i,o,a,n]=region,s=[t,i],l=[r,o],c=[a,n];for(let t=0;t<2;t++)for(let r=0;r<2;r++)for(let i=0;i<2;i++){const o=s[t],a=l[r],n=c[i],h=Math.cos(a),d=(this._R+n)*h*Math.cos(o),m=(this._R+n)*Math.sin(a),p=(this._R+n)*h*Math.sin(o);e.expandByPoint(this._v1.set(d,m,p))}return e}return console.warn("Unsupported boundingVolume type, falling back to identity Box3."),new Box3(new Vector3(-1,-1,-1),new Vector3(1,1,1))}load(e,t,r,i){this.loadAsync(e).then((e=>(t&&t(e),e))).catch((e=>(i?i(e):console.error(e),null)))}async loadAsync(e){try{this._renderer||(this._renderer=new WebGLRenderer({antialias:!1})),this._ktx2Loader.detectSupport(this._renderer);const t=await fetch(e).then((e=>e.json())),r=t.asset?.version||null,i=await new Promise((t=>{const r=new OGC3DTile({url:e,centerModel:!0,renderer:this._renderer,maxCacheSize:this._maxCacheSize,geometricErrorMultiplier:this._geometricErrorMultiplier,ktx2Loader:this._ktx2Loader,dracoLoader:this._dracoLoader,onLoadCallback:()=>t(r)})}));i.displayErrors=!0;const o=i.boundingVolume,a=(new Matrix4).fromArray(i.matrix.elements),n=new Vector3,s=new Quaternion,l=new Vector3;let c;a.decompose(n,s,l);let h=!1;const d=0===s.x&&0===s.y&&0===s.z&&1===s.w,m=new Vector3(o.center.x,o.center.y,o.center.z),p=i.tileLoader.zUpToYUpMatrix,u=m.clone().normalize(),x=new Vector3(0,1,0),M=u.angleTo(x),y=m.length()>1e6;if(y&&MathUtils.radToDeg(M)>.1){const e=(new Quaternion).setFromUnitVectors(u,x);i.quaternion.copy(e),h=!0}else y||d?y&&(c=(new Matrix4).makeRotationX(MathUtils.degToRad(90)),i.quaternion.setFromRotationMatrix(c),h=!0):(c=(new Matrix4).makeRotationX(MathUtils.degToRad(-90)),i.quaternion.setFromRotationMatrix(c),h=!0);let _=new Vector3(i.scale.x,i.scale.y,i.scale.z);(1!==_.x||1!==_.y||1!==_.z)&&i.scale.set(1,1,1);const f=this._computeBox3FromBoundingVolume(o,_);if(h)if(c)f.applyMatrix4(c);else{const e=i.quaternion,t=(new Matrix4).makeRotationFromQuaternion(e);f.applyMatrix4(t)}else"1.0"===r&&f.applyMatrix4(p);const w=f.getBoundingSphere(new Sphere).center.clone();i.position.copy(w).multiplyScalar(-1),f.translate(w.clone().multiplyScalar(-1)),i.boundingBox=f,i._wireframeMode=!1,i.setWireframe=function(e){this._wireframeMode=!!e,this._syncMaterials()},i._syncMaterials=function(){this.traverse((e=>{if(e.isMesh){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{e&&e.wireframe!==this._wireframeMode&&(e.wireframe=this._wireframeMode)}))}else e.isPoints&&e.material&&e.material.size!==this._pointTargetSize&&(e.material.size=this._pointTargetSize,e.material.needsUpdate=!0)}))};const b=i.update.bind(i);i.update=function(e){b(e),this._syncMaterials()},i.frameCamera=function(e){this.updateMatrixWorld(!0);const t=this.boundingBox,r=t.getSize(new Vector3),i=t.getCenter(new Vector3),o=MathUtils.degToRad(e.fov),a=Math.max(r.x,r.y,r.z)/2/Math.tan(o/2);e.position.set(i.x,i.y,i.z+a+30),e.lookAt(i),e.updateProjectionMatrix()};const g=i.dispose.bind(i);return i.dispose=function(){this.parent&&this.parent.remove(this),this.traverse((e=>{if((e.isMesh||e.isPoints)&&(e.geometry&&(e.geometry.dispose(),e.geometry=null),e.material)){(Array.isArray(e.material)?e.material:[e.material]).forEach((e=>{for(const t in e)e[t]&&e[t].isTexture&&(e[t].dispose(),e[t]=null);e.dispose()})),e.material=null}})),"function"==typeof g&&g(),console.debug("OGC3DTileset and GPU resources disposed.")},i}catch(e){console.error(e)}}}export{Three3DTilesLoader};