import{BufferAttribute,BufferGeometry,Loader}from"three";import*as fzstd from"https://cdn.skypack.dev/fzstd?min";import{LASZLoader}from"./LASZLoader.min.js";const GIT_LFS_THRESHOLD_BYTES=150;class EPTStreamLoader extends Loader{constructor(t){super(t),this.skipPoints=1,this.lodDepthLimit=0,this.globalMinZ=null,this.globalMaxZ=null,this.localBlobs=null,this.contrastFactor=1,this.zdecompressor=fzstd,this.lasLoader=new LASZLoader(t)}setZstdDecompressor(t=null){if(!t||"function"!=typeof t.decode&&"function"!=typeof t.decompress)throw new Error("Zstd decompressor must have a decode( Uint8Array ) or decompress( Uint8Array ) function.");return this.zdecompressor=t,this}setLocalBlobMap(t){return this.localBlobs=t,this}setTileDepthLimit(t){return t=Number.isInteger(t)?Math.max(Math.min(t,8),0):0,this.lodDepthLimit=t,this}setSkipPoints(t){return t=Number.isInteger(t)?Math.max(Math.min(t,100),1):1,this.lasLoader.setSkipPoints(t),this.skipPoints=t,this}setSkipColor(t){return this.lasLoader.setSkipColor(t),this}setSkipIntensity(t){return this.lasLoader.setSkipIntensity(t),this}setSkipClassification(t){return this.lasLoader.setSkipClassification(t),this}setIntensityGammaFactor(t){return t=Number(t),(!isFinite(t)||t<=0)&&(t=1),t=Math.min(Math.max(t,.1),2),this.lasLoader.setIntensityGammaFactor(t),this.contrastFactor=t,this}setApplyIntensityToColor(t){return this.lasLoader.setApplyIntensityToColor(t),this}_getValue(t,e,s,r,i=!0){switch(s.toLowerCase()){case"int8":return t.getInt8(e);case"uint8":return t.getUint8(e);case"int16":return t.getInt16(e,i);case"uint16":return t.getUint16(e,i);case"int32":return t.getInt32(e,i);case"uint32":return t.getUint32(e,i);case"float":case"float32":return t.getFloat32(e,i);case"int64":return Number(t.getBigInt64(e,i));case"uint64":return Number(t.getBigUint64(e,i));case"double":case"float64":return t.getFloat64(e,i);case"integer":case"scaledinteger":case"signed":case"unsigned":switch(r){case 1:return"unsigned"===s?t.getUint8(e):t.getInt8(e);case 2:return"unsigned"===s?t.getUint16(e,i):t.getInt16(e,i);case 4:return"unsigned"===s?t.getUint32(e,i):t.getInt32(e,i);case 8:return Number("unsigned"===s?t.getBigUint64(e,i):t.getBigInt64(e,i));default:return console.warn("Unsupported integer size:",a.size),0}default:return console.warn("Unknown attribute type:",s),0}}_sizeOf(t){switch(t.type.toLowerCase()){case"int8":case"uint8":return 1;case"int16":case"uint16":return 2;case"int32":case"uint32":case"float":case"float32":return 4;case"int64":case"uint64":case"float64":case"double":return 8;case"signed":case"unsigned":case"integer":case"scaledinteger":return t.size;default:return console.warn("Unknown EPT attribute type:",t.type),0}}_normalizeCI(t,e){let s;return s=1===e.size?t/255:2===e.size?t<=255?t/255:t/65535:t,Math.min(1,s)}async _loadBinTile(t,e){try{const s=new DataView(t),r=e.attributes||e.schema,i=e.scale||[1,1,1],n=e.offset||[0,0,0];let a=0;const o=[];for(const t of r){const e=this._sizeOf(t),s=t.type.toLowerCase(),r=t.name.toLowerCase();o.push({name:r,type:s,size:e,byteOffset:a,raw:t}),a+=e}if(0===a)return null;const c=t.byteLength/a|0,l=this.skipPoints&&this.skipPoints>1?this.skipPoints:1,u=Math.ceil(c/l),h=new Float32Array(3*u),d=new Float32Array(3*u),p=new Float32Array(u);let f=0;for(let t=0;t<c;t+=l){const e=t*a;for(const t of o){const r=t.raw,a=this._getValue(s,e+t.byteOffset,t.type,t.size,!0);switch(t.name){case"x":h[3*f+0]=a*(i[0]??r.scale)+(n[0]??r.offset);break;case"y":h[3*f+1]=a*(i[1]??r.scale)+(n[1]??r.offset);break;case"z":h[3*f+2]=a*(i[2]??r.scale)+(n[2]??r.offset);break;case"intensity":p[f]=this._normalizeCI(a,r);break;case"red":d[3*f+0]=this._normalizeCI(a,r);break;case"green":d[3*f+1]=this._normalizeCI(a,r);break;case"blue":d[3*f+2]=this._normalizeCI(a,r)}}f++}for(let t=0;t<d.length;t++)d[t]=Math.pow(d[t],this.contrastFactor);const m=new BufferGeometry;return m.setAttribute("position",new BufferAttribute(h,3)),m.setAttribute("color",new BufferAttribute(d,3)),m.setAttribute("intensity",new BufferAttribute(p,1)),m}catch(t){return null}}_isPDAL(t){return!!t.schema&&!t.attributes}_getTileDepth(t,e){return this._isPDAL(e)?parseInt(t.split("-")[0],10):t.split("-").length-1}async _loadHierarchyForDepth(t){try{const e=await fetch(t);return e.ok?await e.json():null}catch{return null}}async _discoverHierarchy(t,e,s,r){if(this._getTileDepth(t,e)>this.lodDepthLimit)return;const i=this.localBlobs?this.localBlobs[`${t}.json`]:`${s}ept-hierarchy/${t}.json`,n=await this._loadHierarchyForDepth(i);if(n){Object.assign(r,n);for(const t of Object.keys(n)){const i=this._getTileDepth(t,e);-1===n[t]&&i<=this.lodDepthLimit&&await this._discoverHierarchy(t,e,s,r)}}}_mortonSort(t){return t.sort(((t,e)=>{const[s,r,i,n]=t.split("-").map(Number),[a,o,c,l]=e.split("-").map(Number);if(s!==a)return s-a;return(r<<40|i<<20|n)-(o<<40|c<<20|l)}))}async _mapWithConcurrency(t,e,s){console.log("Requesting tiles with concurrency limit of ",e);const r=new Array(t.length),i=t.indexOf("0-0-0-0");i>0&&([t[0],t[i]]=[t[i],t[0]]),r[0]=await s(t[0]);let n=1;const a=async()=>{for(;;){const e=n++;if(e>=t.length)break;const i=t[e];try{r[e]=await s(i)}catch(t){console.warn("Task failed for item:",i,t),r[e]=null}}},o=[],c=Math.min(e,t.length);for(let t=0;t<c;t++)o.push(a());return await Promise.all(o),r}load(t,e,s,r){try{this.parse(t,e,r)}catch(t){r?r(t):console.error(t)}}async parse(t,e,s){let r,i,n,a=!1;try{if(r=await fetch(t),!r.ok)return s&&s({type:"network",message:"Bad response for ept.json"}),!1;i=await r.json(),n=t.replace("ept.json","")}catch(t){return s?s({type:"exception",message:t.toString()}):console.error({type:"exception",message:t.toString()}),!1}if("zstandard"===i.dataType&&!this.zdecompressor)return s?s({type:"unsupported",message:"Zstandard requires a decompressor"}):console.error({type:"unsupported",message:"Zstandard requires a decompressor"}),!1;this.globalMinZ=i.bounds?.[2],this.globalMaxZ=i.bounds?.[5];let o={};await this._discoverHierarchy("0-0-0-0",i,n,o);const c=Object.keys(o);console.log("Total Tiles:",c.length);let l=c.filter((t=>this._getTileDepth(t,i)<=this.lodDepthLimit)),u=l.length;l=this._mortonSort(l),console.log("Selected Tiles:",u);const h=this.localBlobs?9:4;return await this._mapWithConcurrency(l,h,(async t=>{let s;try{const r="binary"===i.dataType?".bin":"zstandard"===i.dataType?".zst":".laz",o=`${n}ept-data/${t}${r}`,c=this.localBlobs?this.localBlobs[`${t}${r}`]:o,l=await fetch(c);if(!l.ok)return;if(s=await l.arrayBuffer(),s.byteLength<=150){if((new TextDecoder).decode(s).includes("git-lfs.github.com/spec"))return void(a=!0)}let h;if(".bin"===r)h=await this._loadBinTile(s,i);else if(".zst"===r){let t;const e=new Uint8Array(s);if(t=this.zdecompressor.decode?await this.zdecompressor.decode(e):await this.zdecompressor.decompress(e),!(t instanceof Uint8Array))throw new Error("Zstd decompressor must return a Uint8Array");const r=0===t.byteOffset&&t.byteLength===t.buffer.byteLength?t.buffer:t.buffer.slice(t.byteOffset,t.byteOffset+t.byteLength);h=await this._loadBinTile(r,i)}else h=await this.lasLoader.parse(s);h&&e&&(console.log("Tile ",t+r),e(h,u,t))}catch(e){console.warn(`Tile ${t} failed to load:`,e),u-=1}})),a&&(s?s("Files are Git LFS pointers. Data not loaded."):console.error("Files are Git LFS pointers. Data not loaded.")),!0}}export{EPTStreamLoader};