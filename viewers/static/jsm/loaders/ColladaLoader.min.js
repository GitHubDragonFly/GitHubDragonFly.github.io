import{AmbientLight,AnimationClip,Bone,BufferGeometry,ClampToEdgeWrapping,Color,DirectionalLight,DoubleSide,Euler,FileLoader,Float32BufferAttribute,FrontSide,Group,Line,LinearSRGBColorSpace,LineBasicMaterial,LineSegments,Loader,LoaderUtils,MathUtils,Matrix4,Mesh,MeshBasicMaterial,MeshLambertMaterial,MeshPhongMaterial,OrthographicCamera,PerspectiveCamera,PointLight,Points,PointsMaterial,Quaternion,QuaternionKeyframeTrack,RepeatWrapping,Scene,Skeleton,SkinnedMesh,SpotLight,SRGBColorSpace,TextureLoader,Vector2,Vector3,VectorKeyframeTrack}from"three";import{TGALoader}from"three/addons/loaders/TGALoader.min.js";import{DDSLoader}from"three/addons/loaders/DDSLoader.min.js";class ColladaLoader extends Loader{constructor(e){super(e)}load(e,t,n,s){const r=this,i=""===r.path?LoaderUtils.extractUrlBase(e):r.path,a=new FileLoader(r.manager);a.setPath(r.path),a.setRequestHeader(r.requestHeader),a.setWithCredentials(r.withCredentials),a.load(e,(function(n){try{t(r.parse(n,i))}catch(t){s&&s(t),r.manager.itemError(e)}}),n,s)}parse(e,t){function n(e,t){const n=[],s=e.childNodes;for(let e=0,r=s.length;e<r;e++){const r=s[e];r.nodeName===t&&n.push(r)}return n}function s(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,s=t.length;e<s;e++)n[e]=t[e];return n}function r(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,s=t.length;e<s;e++)n[e]=parseFloat(t[e]);return n}function i(e){if(0===e.length)return[];const t=e.trim().split(/\s+/),n=new Array(t.length);for(let e=0,s=t.length;e<s;e++)n[e]=parseInt(t[e]);return n}function a(e){return e.substring(1)}function o(e){return 0===Object.keys(e).length}function c(e){return void 0!==e&&!0===e.hasAttribute("meter")?parseFloat(e.getAttribute("meter")):1}function l(e){return void 0!==e?e.textContent:"Y_UP"}function u(e,t,s,r){const i=n(e,t)[0];if(void 0!==i){const e=n(i,s);for(let t=0;t<e.length;t++)r(e[t])}}function d(e,t){for(const n in e){e[n].build=t(e[n])}}function f(e,t){return void 0!==e.build||(e.build=t(e)),e.build}function h(e){const t={inputs:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=a(s.getAttribute("source")),n=s.getAttribute("semantic");t.inputs[n]=e;break}}return t}function m(e){const t={};let n=e.getAttribute("target").split("/");const s=n.shift();let r=n.shift();const i=-1!==r.indexOf("("),o=-1!==r.indexOf(".");if(o)n=r.split("."),r=n.shift(),t.member=n.shift();else if(i){const e=r.split("(");r=e.shift();for(let t=0;t<e.length;t++)e[t]=parseInt(e[t].replace(/\)/,""));t.indices=e}return t.id=s,t.sid=r,t.arraySyntax=i,t.memberSyntax=o,t.sampler=a(e.getAttribute("source")),t}function p(e){const t=[],n=e.channels,s=e.samplers,r=e.sources;for(const e in n)if(n.hasOwnProperty(e)){const i=n[e],a=s[i.sampler],o=a.inputs.INPUT,c=a.inputs.OUTPUT;x(g(i,r[o],r[c]),t)}return t}function b(e){return f(He.animations[e],p)}function g(e,t,n){const s=He.nodes[e.id],r=Re(s.id),i=s.transforms[e.sid],a=s.matrix.clone().transpose();let o,c,l,u,d,f;const h={};switch(i){case"matrix":for(l=0,u=t.array.length;l<u;l++)if(o=t.array[l],c=l*n.stride,void 0===h[o]&&(h[o]={}),!0===e.arraySyntax){const t=n.array[c],s=e.indices[0]+4*e.indices[1];h[o][s]=t}else for(d=0,f=n.stride;d<f;d++)h[o][d]=n.array[c+d];break;case"translate":break;case"rotate":break;case"scale":break}const m=function(e,t){const n=[];for(const t in e)n.push({time:parseFloat(t),value:e[t]});n.sort(s);for(let e=0;e<16;e++)A(n,e,t.elements[e]);return n;function s(e,t){return e.time-t.time}}(h,a);return{name:r.uuid,keyframes:m}}const y=new Vector3,k=new Vector3,N=new Quaternion;function x(e,t){const n=e.keyframes,s=e.name,r=[],i=[],a=[],o=[];for(let e=0,t=n.length;e<t;e++){const t=n[e],s=t.time,c=t.value;ve.fromArray(c).transpose(),ve.decompose(y,N,k),r.push(s),i.push(y.x,y.y,y.z),a.push(N.x,N.y,N.z,N.w),o.push(k.x,k.y,k.z)}return i.length>0&&t.push(new VectorKeyframeTrack(s+".position",r,i)),a.length>0&&t.push(new QuaternionKeyframeTrack(s+".quaternion",r,a)),o.length>0&&t.push(new VectorKeyframeTrack(s+".scale",r,o)),t}function A(e,t,n){let s,r,i,a=!0;for(r=0,i=e.length;r<i;r++)s=e[r],void 0===s.value[t]?s.value[t]=null:a=!1;if(!0===a)for(r=0,i=e.length;r<i;r++)s=e[r],s.value[t]=n;else!function(e,t){let n,s;for(let r=0,i=e.length;r<i;r++){const i=e[r];if(null===i.value[t]){if(n=w(e,r,t),s=v(e,r,t),null===n){i.value[t]=s.value[t];continue}if(null===s){i.value[t]=n.value[t];continue}T(i,n,s,t)}}}(e,t)}function w(e,t,n){for(;t>=0;){const s=e[t];if(null!==s.value[n])return s;t--}return null}function v(e,t,n){for(;t<e.length;){const s=e[t];if(null!==s.value[n])return s;t++}return null}function T(e,t,n,s){n.time-t.time!=0?e.value[s]=(e.time-t.time)*(n.value[s]-t.value[s])/(n.time-t.time)+t.value[s]:e.value[s]=t.value[s]}function C(e){const t=[],n=e.name,s=e.end-e.start||-1,r=e.animations;for(let e=0,n=r.length;e<n;e++){const n=b(r[e]);for(let e=0,s=n.length;e<s;e++)t.push(n[e])}return new AnimationClip(n,s,t)}function _(e){return f(He.clips[e],C)}function M(e){const t={sources:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"bind_shape_matrix":t.bindShapeMatrix=r(s.textContent);break;case"source":const e=s.getAttribute("id");t.sources[e]=re(s);break;case"joints":t.joints=S(s);break;case"vertex_weights":t.vertexWeights=O(s);break}}return t}function S(e){const t={inputs:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=s.getAttribute("semantic"),n=a(s.getAttribute("source"));t.inputs[e]=n;break}}return t}function O(e){const t={inputs:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=s.getAttribute("semantic"),n=a(s.getAttribute("source")),r=parseInt(s.getAttribute("offset"));t.inputs[e]={id:n,offset:r};break;case"vcount":t.vcount=i(s.textContent);break;case"v":t.v=i(s.textContent);break}}return t}function L(e){const t={id:e.id},n=He.geometries[t.id];return void 0!==e.skin&&(t.skin=function(e){const t=4,n={joints:[],indices:{array:[],stride:t},weights:{array:[],stride:t}},s=e.sources,r=e.vertexWeights,i=r.vcount,a=r.v,o=r.inputs.JOINT.offset,c=r.inputs.WEIGHT.offset,l=e.sources[e.joints.inputs.JOINT],u=e.sources[e.joints.inputs.INV_BIND_MATRIX],d=s[r.inputs.WEIGHT.id].array;let f,h,m,p=0;for(f=0,m=i.length;f<m;f++){const e=i[f],s=[];for(h=0;h<e;h++){const e=a[p+o],t=d[a[p+c]];s.push({index:e,weight:t}),p+=2}for(s.sort(b),h=0;h<t;h++){const e=s[h];void 0!==e?(n.indices.array.push(e.index),n.weights.array.push(e.weight)):(n.indices.array.push(0),n.weights.array.push(0))}}e.bindShapeMatrix?n.bindMatrix=(new Matrix4).fromArray(e.bindShapeMatrix).transpose():n.bindMatrix=(new Matrix4).identity();for(f=0,m=l.array.length;f<m;f++){const e=l.array[f],t=(new Matrix4).fromArray(u.array,f*u.stride).transpose();n.joints.push({name:e,boneInverse:t})}return n;function b(e,t){return t.weight-e.weight}}(e.skin),n.sources.skinIndices=t.skin.indices,n.sources.skinWeights=t.skin.weights),t}function j(e){return void 0!==e.build?e.build:e.init_from}function q(e){const t=He.images[e];return void 0!==t?f(t,j):null}function B(e){const t={surfaces:{},samplers:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"newparam":R(s,t);break;case"technique":t.technique=P(s);break;case"extra":t.extra=W(s);break}}return t}function R(e,t){const n=e.getAttribute("sid");for(let s=0,r=e.childNodes.length;s<r;s++){const r=e.childNodes[s];if(1===r.nodeType)switch(r.nodeName){case"surface":t.surfaces[n]=I(r);break;case"sampler2D":t.samplers[n]=E(r);break}}}function I(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"init_from":t.init_from=s.textContent;break}}return t}function E(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"source":t.source=s.textContent;break}}return t}function P(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"constant":case"lambert":case"points":case"blinn":case"phong":t.type=s.nodeName,t.parameters=F(s);break}}return t}function F(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"emission":case"diffuse":case"specular":case"bump":case"ambient":case"shininess":case"transparency":t[s.nodeName]=U(s);break;case"transparent":t[s.nodeName]={opaque:s.hasAttribute("opaque")?s.getAttribute("opaque"):"A_ONE",data:U(s)};break}}return t}function U(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"color":t[s.nodeName]=r(s.textContent);break;case"float":t[s.nodeName]=parseFloat(s.textContent);break;case"texture":t[s.nodeName]={id:s.getAttribute("texture"),extra:V(s)};break}}return t}function V(e){const t={technique:{}};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"extra":G(s,t);break}}return t}function G(e,t){for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique":D(s,t);break}}}function D(e,t){for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"repeatU":case"repeatV":case"offsetU":case"offsetV":t.technique[s.nodeName]=parseFloat(s.textContent);break;case"wrapU":case"wrapV":"TRUE"===s.textContent.toUpperCase()?t.technique[s.nodeName]=1:"FALSE"===s.textContent.toUpperCase()?t.technique[s.nodeName]=0:t.technique[s.nodeName]=parseInt(s.textContent);break}}}function W(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique":t.technique=z(s);break}}return t}function z(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"double_sided":t[s.nodeName]=parseInt(s.textContent);break}}return t}function J(e){return e}function X(e){const t=(n=e.url,f(He.effects[n],J));var n;const s=t.profile.technique,r=t.profile.extra;let i;switch(s.type){case"phong":case"blinn":i=new MeshPhongMaterial;break;case"lambert":i=new MeshLambertMaterial;break;case"points":i=new PointsMaterial;break;default:i=new MeshBasicMaterial;break}function a(e,n=null){const s=t.profile.samplers[e.id];let r=null;if(s&&0!==Object.keys(s).length){r=q(t.profile.surfaces[s.source].init_from)}else r=q(e.id);if(null!==r){const t=function(e){let t,n=e.slice(2+(e.lastIndexOf(".")-1>>>0));switch(n=n.toLowerCase(),n){case"tga":t=We,Ve=!1;break;case"dds":t=ze,Ve=!0;break;default:t=De,Ve=!1}return t}(r);if(void 0!==t){const s=t.load(r),i=e.extra;if(void 0!==i&&void 0!==i.technique&&!1===o(i.technique)){const e=i.technique;s.wrapS=e.wrapU?RepeatWrapping:ClampToEdgeWrapping,s.wrapT=e.wrapV?RepeatWrapping:ClampToEdgeWrapping,s.offset.set(e.offsetU||0,e.offsetV||0),s.repeat.set(e.repeatU||1,e.repeatV||1)}else s.wrapS=RepeatWrapping,s.wrapT=RepeatWrapping;return!0===Ve&&(s.repeat.y=-1),s.flipY=!0,null!==n&&(s.colorSpace=n),s}return null}return null}i.name=e.name||"";const c=s.parameters;for(const e in c){const t=c[e];switch(e){case"diffuse":t.color&&i.color.fromArray(t.color),t.texture&&(i.map=a(t.texture,SRGBColorSpace));break;case"specular":t.color&&i.specular&&i.specular.fromArray(t.color),t.texture&&(i.specularMap=a(t.texture,SRGBColorSpace));break;case"bump":t.texture&&(i.normalMap=a(t.texture,LinearSRGBColorSpace));break;case"ambient":t.texture&&(i.lightMap=a(t.texture,LinearSRGBColorSpace));break;case"shininess":t.float&&i.shininess&&(i.shininess=t.float);break;case"emission":t.color&&i.emissive&&i.emissive.fromArray(t.color),t.texture&&(i.emissiveMap=a(t.texture,SRGBColorSpace));break}}let l=c.transparent,u=c.transparency;if(l&&void 0===u&&(u={float:1}),void 0===l&&u&&(l={opaque:"A_ONE",data:{color:[1,1,1,1]}}),l&&u)if(l.data.texture)i.transparent=!0;else{const e=l.data.color;switch(l.opaque){case"A_ONE":i.opacity=e?e[3]*u.float:u.float;break;case"RGB_ZERO":i.opacity=e?1-e[0]*u.float:1-u.float;break;case"A_ZERO":i.opacity=e?1-e[3]*u.float:1-u.float;break;case"RGB_ONE":i.opacity=e?e[0]*u.float:u.float;break;default:}i.opacity<1&&(i.transparent=!0)}return void 0!==r&&void 0!==r.technique&&(i.side=1===r.technique.double_sided?DoubleSide:FrontSide,r.technique.bump&&r.technique.bump.texture&&(i.normalMap=a(r.technique[bump].texture),i.normalScale=new Vector2(1,1))),i}function K(e){return f(He.materials[e],X)}function H(e){for(let t=0;t<e.childNodes.length;t++){const n=e.childNodes[t];switch(n.nodeName){case"technique_common":return Q(n)}}return{}}function Q(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];switch(s.nodeName){case"perspective":case"orthographic":t.technique=s.nodeName,t.parameters=Z(s);break}}return t}function Z(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];switch(s.nodeName){case"xfov":case"yfov":case"xmag":case"ymag":case"znear":case"zfar":case"aspect_ratio":t[s.nodeName]=parseFloat(s.textContent);break}}return t}function Y(e){let t;switch(e.optics.technique){case"perspective":t=new PerspectiveCamera(e.optics.parameters.yfov,e.optics.parameters.aspect_ratio,e.optics.parameters.znear,e.optics.parameters.zfar);break;case"orthographic":let n=e.optics.parameters.ymag,s=e.optics.parameters.xmag;const r=e.optics.parameters.aspect_ratio;s=void 0===s?n*r:s,n=void 0===n?s/r:n,s*=.5,n*=.5,t=new OrthographicCamera(-s,s,n,-n,e.optics.parameters.znear,e.optics.parameters.zfar);break;default:t=new PerspectiveCamera;break}return t.name=e.name||"",t}function $(e){const t=He.cameras[e];return void 0!==t?f(t,Y):null}function ee(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"directional":case"point":case"spot":case"ambient":t.technique=s.nodeName,t.parameters=te(s)}}return t}function te(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"color":const e=r(s.textContent);t.color=(new Color).setRGB(e[0],e[1],e[2],LinearSRGBColorSpace);break;case"falloff_angle":t.falloffAngle=parseFloat(s.textContent);break;case"quadratic_attenuation":const n=parseFloat(s.textContent);t.distance=n?Math.sqrt(1/n):0;break}}return t}function ne(e){let t;switch(e.technique){case"directional":t=new DirectionalLight;break;case"point":t=new PointLight;break;case"spot":t=new SpotLight;break;case"ambient":t=new AmbientLight;break}return e.parameters.color&&t.color.copy(e.parameters.color),e.parameters.distance&&(t.distance=e.parameters.distance),t}function se(e){const t=He.lights[e];return void 0!==t?f(t,ne):null}function re(e){const t={array:[],stride:3};for(let i=0;i<e.childNodes.length;i++){const a=e.childNodes[i];if(1===a.nodeType)switch(a.nodeName){case"float_array":t.array=r(a.textContent);break;case"Name_array":t.array=s(a.textContent);break;case"technique_common":const e=n(a,"accessor")[0];void 0!==e&&(t.stride=parseInt(e.getAttribute("stride")));break}}return t}function ie(e){const t={};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];1===s.nodeType&&(t[s.getAttribute("semantic")]=a(s.getAttribute("source")))}return t}function ae(e){const t={type:e.nodeName,material:e.getAttribute("material"),count:parseInt(e.getAttribute("count")),inputs:{},stride:0,hasUV:!1};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"input":const e=a(s.getAttribute("source")),n=s.getAttribute("semantic"),r=parseInt(s.getAttribute("offset")),o=parseInt(s.getAttribute("set")),c=o>0?n+o:n;t.inputs[c]={id:e,offset:r},t.stride=Math.max(t.stride,r+1),"TEXCOORD"===n&&(t.hasUV=!0);break;case"vcount":t.vcount=i(s.textContent);break;case"p":t.p=i(s.textContent);break}}return t}function oe(e){let t=0;for(let n=0,s=e.length;n<s;n++){!0===e[n].hasUV&&t++}t>0&&t<e.length&&(e.uvsNeedsFix=!0)}function ce(e){const t={},n=e.sources,s=e.vertices,r=e.primitives;if(0===r.length)return{};const i=function(e){const t={};for(let n=0;n<e.length;n++){const s=e[n];void 0===t[s.type]&&(t[s.type]=[]),t[s.type].push(s)}return t}(r);for(const e in i){const r=i[e];oe(r),t[e]=le(r,n,s)}return t}function le(e,t,n){const s={},r={array:[],stride:0},i={array:[],stride:0},a={array:[],stride:0},o={array:[],stride:0},c={array:[],stride:0},l=[],u=4,d=[],f=4,h=new BufferGeometry,m=[];let p=0;for(let s=0;s<e.length;s++){const u=e[s],f=u.inputs;let b=0;switch(u.type){case"lines":case"linestrips":b=2*u.count;break;case"triangles":b=3*u.count;break;case"polylist":for(let e=0;e<u.count;e++){const t=u.vcount[e];switch(t){case 3:b+=3;break;case 4:b+=6;break;default:b+=3*(t-2);break}}break;default:}h.addGroup(p,b,s),p+=b,u.material&&m.push(u.material);for(const s in f){const h=f[s];switch(s){case"VERTEX":for(const s in n){const f=n[s];switch(s){case"POSITION":const n=r.array.length;if(ue(u,t[f],h.offset,r.array),r.stride=t[f].stride,t.skinWeights&&t.skinIndices&&(ue(u,t.skinIndices,h.offset,l),ue(u,t.skinWeights,h.offset,d)),!1===u.hasUV&&!0===e.uvsNeedsFix){const e=(r.array.length-n)/r.stride;for(let t=0;t<e;t++)a.array.push(0,0)}break;case"NORMAL":ue(u,t[f],h.offset,i.array),i.stride=t[f].stride;break;case"COLOR":ue(u,t[f],h.offset,c.array),c.stride=t[f].stride;break;case"TEXCOORD":ue(u,t[f],h.offset,a.array),a.stride=t[f].stride;break;case"TEXCOORD1":ue(u,t[f],h.offset,o.array),o.stride=t[f].stride;break;default:}}break;case"NORMAL":ue(u,t[h.id],h.offset,i.array),i.stride=t[h.id].stride;break;case"COLOR":ue(u,t[h.id],h.offset,c.array),c.stride=t[h.id].stride;break;case"TEXCOORD":ue(u,t[h.id],h.offset,a.array),a.stride=t[h.id].stride;break;case"TEXCOORD1":ue(u,t[h.id],h.offset,o.array),o.stride=t[h.id].stride;break}}}return r.array.length>0&&h.setAttribute("position",new Float32BufferAttribute(r.array,r.stride)),i.array.length>0&&h.setAttribute("normal",new Float32BufferAttribute(i.array,i.stride)),c.array.length>0&&h.setAttribute("color",new Float32BufferAttribute(c.array,c.stride)),a.array.length>0&&h.setAttribute("uv",new Float32BufferAttribute(a.array,a.stride)),o.array.length>0&&h.setAttribute("uv1",new Float32BufferAttribute(o.array,o.stride)),l.length>0&&h.setAttribute("skinIndex",new Float32BufferAttribute(l,u)),d.length>0&&h.setAttribute("skinWeight",new Float32BufferAttribute(d,f)),s.data=h,s.type=e[0].type,s.materialKeys=m,s}function ue(e,t,n,s){const r=e.p,i=e.stride,a=e.vcount;function o(e){let t=r[e+n]*l;const i=t+l;for(;t<i;t++)s.push(c[t])}const c=t.array,l=t.stride;if(void 0!==e.vcount){let e=0;for(let t=0,n=a.length;t<n;t++){const n=a[t];if(4===n){const t=e+1*i,n=e+2*i,s=e+3*i;o(e+0*i),o(t),o(s),o(t),o(n),o(s)}else if(3===n){const t=e+1*i,n=e+2*i;o(e+0*i),o(t),o(n)}else if(n>4)for(let t=1,s=n-2;t<=s;t++){const n=e+i*t,s=e+i*(t+1);o(e+0*i),o(n),o(s)}e+=i*n}}else for(let e=0,t=r.length;e<t;e+=i)o(e)}function de(e){return f(He.geometries[e],ce)}function fe(e){return void 0!==e.build?e.build:e}function he(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"joint":t.joints[s.getAttribute("sid")]=me(s);break;case"link":t.links.push(be(s));break}}}function me(e){let t;for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"prismatic":case"revolute":t=pe(s);break}}return t}function pe(e){const t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",axis:new Vector3,limits:{min:0,max:0},type:e.nodeName,static:!1,zeroPosition:0,middlePosition:0};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"axis":const e=r(s.textContent);t.axis.fromArray(e);break;case"limits":const n=s.getElementsByTagName("max")[0],i=s.getElementsByTagName("min")[0];t.limits.max=parseFloat(n.textContent),t.limits.min=parseFloat(i.textContent);break}}return t.limits.min>=t.limits.max&&(t.static=!0),t.middlePosition=(t.limits.min+t.limits.max)/2,t}function be(e){const t={sid:e.getAttribute("sid"),name:e.getAttribute("name")||"",attachments:[],transforms:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"attachment_full":t.attachments.push(ge(s));break;case"matrix":case"translate":case"rotate":t.transforms.push(ye(s));break}}return t}function ge(e){const t={joint:e.getAttribute("joint").split("/").pop(),transforms:[],links:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"link":t.links.push(be(s));break;case"matrix":case"translate":case"rotate":t.transforms.push(ye(s));break}}return t}function ye(e){const t={type:e.nodeName},n=r(e.textContent);switch(t.type){case"matrix":t.obj=new Matrix4,t.obj.fromArray(n).transpose();break;case"translate":t.obj=new Vector3,t.obj.fromArray(n);break;case"rotate":t.obj=new Vector3,t.obj.fromArray(n),t.angle=MathUtils.degToRad(n[3]);break}return t}function ke(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique_common":Ne(s,t);break}}}function Ne(e,t){for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"inertia":t.inertia=r(s.textContent);break;case"mass":t.mass=r(s.textContent)[0];break}}}function xe(e){const t={target:e.getAttribute("target").split("/").pop()};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"axis":const e=s.getElementsByTagName("param")[0];t.axis=e.textContent;const n=t.axis.split("inst_").pop().split("axis")[0];t.jointIndex=n.substring(0,n.length-1);break}}return t}function Ae(e){return void 0!==e.build?e.build:e}function we(e){const t=[],n=Fe.querySelector('[id="'+e.id+'"]');for(let e=0;e<n.childNodes.length;e++){const s=n.childNodes[e];if(1!==s.nodeType)continue;let i,a;switch(s.nodeName){case"matrix":i=r(s.textContent);const e=(new Matrix4).fromArray(i).transpose();t.push({sid:s.getAttribute("sid"),type:s.nodeName,obj:e});break;case"translate":case"scale":i=r(s.textContent),a=(new Vector3).fromArray(i),t.push({sid:s.getAttribute("sid"),type:s.nodeName,obj:a});break;case"rotate":i=r(s.textContent),a=(new Vector3).fromArray(i);const n=MathUtils.degToRad(i[3]);t.push({sid:s.getAttribute("sid"),type:s.nodeName,obj:a,angle:n});break}}return t}const ve=new Matrix4,Te=new Vector3;function Ce(e){const t={name:e.getAttribute("name")||"",type:e.getAttribute("type"),id:e.getAttribute("id"),sid:e.getAttribute("sid"),matrix:new Matrix4,nodes:[],instanceCameras:[],instanceControllers:[],instanceLights:[],instanceGeometries:[],instanceNodes:[],transforms:{}};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1!==s.nodeType)continue;let i;switch(s.nodeName){case"node":t.nodes.push(s.getAttribute("id")),Ce(s);break;case"instance_camera":t.instanceCameras.push(a(s.getAttribute("url")));break;case"instance_controller":t.instanceControllers.push(_e(s));break;case"instance_light":t.instanceLights.push(a(s.getAttribute("url")));break;case"instance_geometry":t.instanceGeometries.push(_e(s));break;case"instance_node":t.instanceNodes.push(a(s.getAttribute("url")));break;case"matrix":i=r(s.textContent),t.matrix.multiply(ve.fromArray(i).transpose()),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"translate":i=r(s.textContent),Te.fromArray(i),t.matrix.multiply(ve.makeTranslation(Te.x,Te.y,Te.z)),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"rotate":i=r(s.textContent);const e=MathUtils.degToRad(i[3]);t.matrix.multiply(ve.makeRotationAxis(Te.fromArray(i),e)),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"scale":i=r(s.textContent),t.matrix.scale(Te.fromArray(i)),t.transforms[s.getAttribute("sid")]=s.nodeName;break;case"extra":break;default:}}return Be(t.id)||(He.nodes[t.id]=t),t}function _e(e){const t={id:a(e.getAttribute("url")),materials:{},skeletons:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];switch(s.nodeName){case"bind_material":const e=s.getElementsByTagName("instance_material");for(let n=0;n<e.length;n++){const s=e[n],r=s.getAttribute("symbol"),i=s.getAttribute("target");t.materials[r]=a(i)}break;case"skeleton":t.skeletons.push(a(s.textContent));break;default:break}}return t}function Me(e,t){const n=[],s=[];let r,i,a;for(r=0;r<e.length;r++){const s=e[r];let i;if(Be(s))i=Re(s),Se(i,t,n);else if(o=s,void 0!==He.visualScenes[o]){const e=He.visualScenes[s].children;for(let s=0;s<e.length;s++){const r=e[s];if("JOINT"===r.type){Se(Re(r.id),t,n)}}}}var o;for(r=0;r<t.length;r++)for(i=0;i<n.length;i++)if(a=n[i],a.bone.name===t[r].name){s[r]=a,a.processed=!0;break}for(r=0;r<n.length;r++)a=n[r],!1===a.processed&&(s.push(a),a.processed=!0);const c=[],l=[];for(r=0;r<s.length;r++)a=s[r],c.push(a.bone),l.push(a.boneInverse);return new Skeleton(c,l)}function Se(e,t,n){e.traverse((function(e){if(!0===e.isBone){let s;for(let n=0;n<t.length;n++){const r=t[n];if(r.name===e.name){s=r.boneInverse;break}}void 0===s&&(s=new Matrix4),n.push({bone:e,boneInverse:s,processed:!1})}}))}function Oe(e){const t=[],n=e.matrix,s=e.nodes,r=e.type,i=e.instanceCameras,a=e.instanceControllers,o=e.instanceLights,c=e.instanceGeometries,l=e.instanceNodes;for(let e=0,n=s.length;e<n;e++)t.push(Re(s[e]));for(let e=0,n=i.length;e<n;e++){const n=$(i[e]);null!==n&&t.push(n.clone())}for(let e=0,n=a.length;e<n;e++){const n=a[e],s=(u=n.id,f(He.controllers[u],L)),r=qe(de(s.id),n.materials),i=Me(n.skeletons,s.skin.joints);for(let e=0,n=r.length;e<n;e++){const n=r[e];n.isSkinnedMesh&&(n.bind(i,s.skin.bindMatrix),n.normalizeSkinWeights()),t.push(n)}}var u;for(let e=0,n=o.length;e<n;e++){const n=se(o[e]);null!==n&&t.push(n.clone())}for(let e=0,n=c.length;e<n;e++){const n=c[e],s=qe(de(n.id),n.materials);for(let e=0,n=s.length;e<n;e++)t.push(s[e])}for(let e=0,n=l.length;e<n;e++)t.push(Re(l[e]).clone());let d;if(0===s.length&&1===t.length)d=t[0];else{d="JOINT"===r?new Bone:new Group;for(let e=0;e<t.length;e++)d.add(t[e])}return d.name="JOINT"===r?e.sid:e.name,d.matrix.copy(n),d.matrix.decompose(d.position,d.quaternion,d.scale),d}const Le=new MeshBasicMaterial({color:16711935});function je(e,t){const n=[];for(let s=0,r=e.length;s<r;s++){const r=t[e[s]];void 0===r?n.push(Le):n.push(K(r))}return n}function qe(e,t){const n=[];for(const s in e){const r=e[s],i=je(r.materialKeys,t);0===i.length&&("lines"===s||"linestrips"===s?i.push(new LineBasicMaterial):i.push(new MeshPhongMaterial));const a=void 0!==r.data.attributes.skinIndex,o=1===i.length?i[0]:i;let c;switch(s){case"lines":c=new LineSegments(r.data,o);break;case"linestrips":c=new Line(r.data,o);break;case"triangles":case"polylist":"triangles"===s&&!0===o.isPointsMaterial?(c=new Points(r.data,o),c.material.size/=20):c=a?new SkinnedMesh(r.data,o):new Mesh(r.data,o);break}n.push(c)}return n}function Be(e){return void 0!==He.nodes[e]}function Re(e){return f(He.nodes[e],Oe)}function Ie(e){const t=new Group;t.name=e.name;const n=e.children;for(let e=0;e<n.length;e++){const s=n[e];t.add(Re(s.id))}return t}function Ee(e){return f(He.visualScenes[e],Ie)}if(0===e.length)return{scene:new Scene};const Pe=(new DOMParser).parseFromString(e,"application/xml"),Fe=n(Pe,"COLLADA")[0],Ue=Pe.getElementsByTagName("parsererror")[0];if(void 0!==Ue){const e=n(Ue,"div")[0];let t;return t=e?e.textContent:function(e){let t="";const n=[e];for(;n.length;){const e=n.shift();e.nodeType===Node.TEXT_NODE?t+=e.textContent:(t+="\n",n.push.apply(n,e.childNodes))}return t.trim()}(Ue),null}let Ve=!1;Fe.getAttribute("version");const Ge=function(e){return{unit:c(n(e,"unit")[0]),upAxis:l(n(e,"up_axis")[0])}}(n(Fe,"asset")[0]),De=new TextureLoader(this.manager);De.setPath(this.resourcePath||t).setCrossOrigin(this.crossOrigin);const We=new TGALoader(this.manager);We.setPath(this.resourcePath||t);const ze=new DDSLoader(this.manager);ze.setPath(this.resourcePath||t);const Je=[];let Xe={},Ke=0;const He={animations:{},clips:{},controllers:{},images:{},effects:{},materials:{},cameras:{},lights:{},geometries:{},nodes:{},visualScenes:{},kinematicsModels:{},physicsModels:{},kinematicsScenes:{}};u(Fe,"library_animations","animation",(function e(t){const n={sources:{},samplers:{},channels:{}};let s=!1;for(let r=0,i=t.childNodes.length;r<i;r++){const i=t.childNodes[r];if(1!==i.nodeType)continue;let a;switch(i.nodeName){case"source":a=i.getAttribute("id"),n.sources[a]=re(i);break;case"sampler":a=i.getAttribute("id"),n.samplers[a]=h(i);break;case"channel":a=i.getAttribute("target"),n.channels[a]=m(i);break;case"animation":e(i),s=!0;break;default:}}!1===s&&(He.animations[t.getAttribute("id")||MathUtils.generateUUID()]=n)})),u(Fe,"library_animation_clips","animation_clip",(function(e){const t={name:e.getAttribute("id")||"default",start:parseFloat(e.getAttribute("start")||0),end:parseFloat(e.getAttribute("end")||0),animations:[]};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"instance_animation":t.animations.push(a(s.getAttribute("url")));break}}He.clips[e.getAttribute("id")]=t})),u(Fe,"library_controllers","controller",(function(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"skin":t.id=a(s.getAttribute("source")),t.skin=M(s);break;case"morph":t.id=a(s.getAttribute("source"));break}}He.controllers[e.getAttribute("id")]=t})),u(Fe,"library_images","image",(function(e){const t={init_from:n(e,"init_from")[0].textContent};He.images[e.getAttribute("id")]=t})),u(Fe,"library_effects","effect",(function(e){const t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"profile_COMMON":t.profile=B(s);break}}He.effects[e.getAttribute("id")]=t})),u(Fe,"library_materials","material",(function(e){const t={name:e.getAttribute("name")};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"instance_effect":t.url=a(s.getAttribute("url"));break}}He.materials[e.getAttribute("id")]=t})),u(Fe,"library_cameras","camera",(function(e){const t={name:e.getAttribute("name")};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"optics":t.optics=H(s);break}}He.cameras[e.getAttribute("id")]=t})),u(Fe,"library_lights","light",(function(e){let t={};for(let n=0,s=e.childNodes.length;n<s;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique_common":t=ee(s);break}}He.lights[e.getAttribute("id")]=t})),u(Fe,"library_geometries","geometry",(function(e){const t={name:e.getAttribute("name"),sources:{},vertices:{},primitives:[]},s=n(e,"mesh")[0];if(void 0!==s){for(let e=0;e<s.childNodes.length;e++){const n=s.childNodes[e];if(1!==n.nodeType)continue;const r=n.getAttribute("id");switch(n.nodeName){case"source":t.sources[r]=re(n);break;case"vertices":t.vertices=ie(n);break;case"polygons":break;case"lines":case"linestrips":case"polylist":case"triangles":t.primitives.push(ae(n));break;default:}}He.geometries[e.getAttribute("id")]=t}})),u(Fe,"library_nodes","node",Ce),u(Fe,"library_visual_scenes","visual_scene",(function(e){const t={name:e.getAttribute("name"),children:[]};!function(e){const t=e.getElementsByTagName("node");for(let e=0;e<t.length;e++){const n=t[e];!1===n.hasAttribute("id")&&n.setAttribute("id","three_default_"+Ke++)}}(e);const s=n(e,"node");for(let e=0;e<s.length;e++)t.children.push(Ce(s[e]));He.visualScenes[e.getAttribute("id")]=t})),u(Fe,"library_kinematics_models","kinematics_model",(function(e){const t={name:e.getAttribute("name")||"",joints:{},links:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"technique_common":he(s,t);break}}He.kinematicsModels[e.getAttribute("id")]=t})),u(Fe,"library_physics_models","physics_model",(function(e){const t={name:e.getAttribute("name")||"",rigidBodies:{}};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"rigid_body":t.rigidBodies[s.getAttribute("name")]={},ke(s,t.rigidBodies[s.getAttribute("name")]);break}}He.physicsModels[e.getAttribute("id")]=t})),u(Fe,"scene","instance_kinematics_scene",(function(e){const t={bindJointAxis:[]};for(let n=0;n<e.childNodes.length;n++){const s=e.childNodes[n];if(1===s.nodeType)switch(s.nodeName){case"bind_joint_axis":t.bindJointAxis.push(xe(s));break}}He.kinematicsScenes[a(e.getAttribute("url"))]=t})),d(He.animations,p),d(He.clips,C),d(He.controllers,L),d(He.images,j),d(He.effects,J),d(He.materials,X),d(He.cameras,Y),d(He.lights,ne),d(He.geometries,ce),d(He.visualScenes,Ie),function(){const e=He.clips;if(!0===o(e)){if(!1===o(He.animations)){const e=[];for(const t in He.animations){const n=b(t);for(let t=0,s=n.length;t<s;t++)e.push(n[t])}Je.push(new AnimationClip("default",-1,e))}}else for(const t in e)Je.push(_(t))}(),function(){const e=Object.keys(He.kinematicsModels)[0],t=Object.keys(He.kinematicsScenes)[0],n=Object.keys(He.visualScenes)[0];if(void 0===e||void 0===t)return;const s=(r=e,f(He.kinematicsModels[r],fe));var r;const i=function(e){return f(He.kinematicsScenes[e],Ae)}(t),a=Ee(n),o=i.bindJointAxis,c={};for(let e=0,t=o.length;e<t;e++){const t=o[e],n=Fe.querySelector('[sid="'+t.target+'"]');if(n){const e=n.parentElement;l(t.jointIndex,e)}}function l(e,t){const n=t.getAttribute("name"),r=s.joints[e];a.traverse((function(s){s.name===n&&(c[e]={object:s,transforms:we(t),joint:r,position:r.zeroPosition})}))}const u=new Matrix4;Xe={joints:s&&s.joints,getJointValue:function(e){const t=c[e];if(t)return t.position},setJointValue:function(e,t){const n=c[e];if(n){const s=n.joint;if(t>s.limits.max||t<s.limits.min);else if(s.static);else{const r=n.object,i=s.axis,a=n.transforms;ve.identity();for(let n=0;n<a.length;n++){const r=a[n];if(r.sid&&-1!==r.sid.indexOf(e))switch(s.type){case"revolute":ve.multiply(u.makeRotationAxis(i,MathUtils.degToRad(t)));break;case"prismatic":ve.multiply(u.makeTranslation(i.x*t,i.y*t,i.z*t));break;default:break}else switch(r.type){case"matrix":ve.multiply(r.obj);break;case"translate":ve.multiply(u.makeTranslation(r.obj.x,r.obj.y,r.obj.z));break;case"scale":ve.scale(r.obj);break;case"rotate":ve.multiply(u.makeRotationAxis(r.obj,r.angle));break}}r.matrix.copy(ve),r.matrix.decompose(r.position,r.quaternion,r.scale),c[e].position=t}}}}}();const Qe=function(e){return Ee(a(n(e,"instance_visual_scene")[0].getAttribute("url")))}(n(Fe,"scene")[0]);return Qe.animations=Je,"Z_UP"===Ge.upAxis&&Qe.quaternion.setFromEuler(new Euler(-Math.PI/2,0,0)),Qe.scale.multiplyScalar(Ge.unit),{get animations(){return Je},kinematics:Xe,library:He,scene:Qe}}}export{ColladaLoader};