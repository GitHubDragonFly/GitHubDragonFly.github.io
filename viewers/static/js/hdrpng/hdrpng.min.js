!function(e,t,r){"undefined"!=typeof module&&module.exports?module.exports=r():"function"==typeof define&&define.amd?define(e,r):t[e]=r()}("HDRImage",this,(function(){function e(){var e,o,h=document.createElement("canvas"),f="t",u=1,d=2.2,s=null;return h.__defineGetter__("exposure",(function(){return u})),h.__defineSetter__("exposure",(function(t){u=t,s&&(i(s,u,d,o.data),e.putImageData(o,0,0))})),h.__defineGetter__("gamma",(function(){return d})),h.__defineSetter__("gamma",(function(t){d=t,s&&(i(s,u,d,o.data),e.putImageData(o,0,0))})),h.__defineGetter__("dataFloat",(function(){return n(s)})),h.__defineGetter__("dataRGBE",(function(){return s})),h.toHDRBlob=function(e,r,a){function i(e,t,r){var a=e.createShader(r);return e.shaderSource(a,t),e.compileShader(a),a}var o=r&&r.match(/rgb9_e5/i)?new Uint8Array(t(n(s)).buffer):new Uint8Array(s.buffer),h=this.width,f=this.height;if(!(h*f*4<o.byteLength)){var u=document.createElement("canvas");u.width=h,u.height=f;var d=u.getContext("webgl",{antialias:!1,alpha:!0,premultipliedAlpha:!1,preserveDrawingBuffer:!0}),l=d.createTexture();d.activeTexture(d.TEXTURE0),d.bindTexture(d.TEXTURE_2D,l),d.pixelStorei(d.UNPACK_FLIP_Y_WEBGL,!0),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MAG_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_MIN_FILTER,d.NEAREST),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_S,d.CLAMP_TO_EDGE),d.texParameteri(d.TEXTURE_2D,d.TEXTURE_WRAP_T,d.CLAMP_TO_EDGE),d.texImage2D(d.TEXTURE_2D,0,d.RGBA,h,f,0,d.RGBA,d.UNSIGNED_BYTE,new Uint8Array(o.buffer));var E=function(e,t,r){var a,n,o=e.createProgram();return e.attachShader(o,a=i(e,t,e.VERTEX_SHADER)),e.attachShader(o,n=i(e,r,e.FRAGMENT_SHADER)),e.linkProgram(o),e.deleteShader(a),e.deleteShader(n),o}(d,"precision highp float;\nattribute vec3 position;\nvarying vec2 tex;\nvoid main() { tex = position.xy/2.0+0.5; gl_Position = vec4(position, 1.0); }","precision highp float;\nprecision highp sampler2D;\nuniform sampler2D tx;\nvarying vec2 tex;\nvoid main() { gl_FragColor = texture2D(tx,tex); }"),T=d.getUniformLocation(E,"tx"),_=new Float32Array([-1,-1,0,1,-1,0,1,1,0,1,1,0,-1,1,0,-1,-1,0]),g=d.createBuffer();return d.enableVertexAttribArray(0),d.bindBuffer(d.ARRAY_BUFFER,g),d.bufferData(d.ARRAY_BUFFER,_,d.STATIC_DRAW),d.vertexAttribPointer(0,3,d.FLOAT,!1,0,0),d.useProgram(E),d.uniform1i(T,0),d.drawArrays(d.TRIANGLES,0,6),d.deleteTexture(l),d.deleteProgram(E),e?u.toBlob(e):void 0}},h.__defineGetter__("src",(function(){return f})),h.__defineSetter__("src",(function(t){if(f=t,e&&e.clearRect(0,0,this.width,this.height),t.match(/\.hdr$/i))l=t,E=function(t,r,a){s=t,this.width=this.style.width=r,this.height=this.style.height=a,e=this.getContext("2d"),o=e.getImageData(0,0,r,a),i(t,u,d,o.data),e.putImageData(o,0,0),this.onload&&this.onload()}.bind(h),T=function(e,t){for(var r in t)e[r]=t[r];return e}(new XMLHttpRequest,{responseType:"arraybuffer"}),T.onerror=E.bind(T,!1),T.onload=function(){if(this.status>=400)return this.onerror();for(var e="",t=0,r=new Uint8Array(this.response);!e.match(/\n\n[^\n]+\n/g);)e+=String.fromCharCode(r[t++]);if("32-bit_rle_rgbe"!=e.match(/FORMAT=(.*)$/m)[1])return this.onerror();for(var a=e.split(/\n/).reverse()[1].split(" "),n=1*a[3],i=1*a[1],o=new Uint8Array(n*i*4),h=0,f=0;f<i;f++){var u=r.slice(t,t+=4),d=[];if(2!=u[0]||2!=u[1]||128&u[2]){var s=n;for(t-=4;s>0;)if(o.set(r.slice(t,t+=4),h),1==o[h]&&1==o[h+1]&&1==o[h+2])for(o[h+3];l>0;l--)o.set(o.slice(h-4,h),h),h+=4,s--;else s--,h+=4}else{if((u[2]<<8)+u[3]!=n)return this.onerror();for(var l=0;l<4;l++)for(var T,_,g=l*n,c=(l+1)*n;g<c;)if((T=r.slice(t,t+=2))[0]>128)for(_=T[0]-128;_-- >0;)d[g++]=T[1];else for(_=T[0]-1,d[g++]=T[1];_-- >0;)d[g++]=r[t++];for(l=0;l<n;l++)o[h++]=d[l],o[h++]=d[l+n],o[h++]=d[l+2*n],o[h++]=d[l+3*n]}}E&&E(o,n,i)},T.open("GET",l,!0),T.send(null);else if(t.match(/\.rgb9_e5\.png$/i)){(n=new Image).src=t,n.onload=function(){var t=document.createElement("canvas"),h=this.width=this.style.width=t.width=n.width,f=this.height=this.style.height=t.height=n.height,l=t.getContext("webgl"),E=l.createTexture();l.bindTexture(l.TEXTURE_2D,E),l.texImage2D(l.TEXTURE_2D,0,l.RGBA,l.RGBA,l.UNSIGNED_BYTE,n),fb=l.createFramebuffer(),l.bindFramebuffer(l.FRAMEBUFFER,fb),l.framebufferTexture2D(l.FRAMEBUFFER,l.COLOR_ATTACHMENT0,l.TEXTURE_2D,E,0);var T=new Uint8Array(h*f*4);l.readPixels(0,0,h,f,l.RGBA,l.UNSIGNED_BYTE,T),l.deleteTexture(E),l.deleteFramebuffer(fb),this.dataRAW=new Uint32Array(T.buffer),s=a(r(this.dataRAW)),e=this.getContext("2d"),o=e.getImageData(0,0,h,f),i(s,u,d,o.data),e.putImageData(o,0,0),this.onload&&this.onload()}.bind(h)}else if(t.match(/\.hdr\.png$|\.rgbe\.png/i)){var n;(n=new Image).src=t,n.onload=function(){var t=document.createElement("canvas"),r=this.width=this.style.width=t.width=n.width,a=this.height=this.style.height=t.height=n.height,h=t.getContext("webgl"),f=h.createTexture();h.bindTexture(h.TEXTURE_2D,f),h.texImage2D(h.TEXTURE_2D,0,h.RGBA,h.RGBA,h.UNSIGNED_BYTE,n),fb=h.createFramebuffer(),h.bindFramebuffer(h.FRAMEBUFFER,fb),h.framebufferTexture2D(h.FRAMEBUFFER,h.COLOR_ATTACHMENT0,h.TEXTURE_2D,f,0);var l=new Uint8Array(r*a*4);h.readPixels(0,0,r,a,h.RGBA,h.UNSIGNED_BYTE,l),h.deleteTexture(f),h.deleteFramebuffer(fb),s=l,e=this.getContext("2d"),o=e.getImageData(0,0,r,a),i(s,u,d,o.data),e.putImageData(o,0,0),this.onload&&this.onload()}.bind(h)}var l,E,T})),h}function t(e,t){for(var r,a,n,i,o,h,f=e.byteLength/12|0,u=(t=t||new Uint32Array(f),0);u<f;u++)r=Math.min(32768,e[3*u]),a=Math.min(32768,e[3*u+1]),n=Math.min(32768,e[3*u+2]),i=Math.max(Math.max(r,a),n),o=Math.max(-16,Math.floor(Math.log2(i)))+16,h=Math.pow(2,o-24),511==Math.floor(i/h+.5)&&(h*=2,o+=1),t[u]=(Math.floor(r/h+.5)<<23)+(Math.floor(a/h+.5)<<14)+(Math.floor(n/h+.5)<<5)+(0|o);return t}function r(e,t){for(var r,a,n=e.byteLength>>2,i=(t=t||new Float32Array(3*n),0);i<n;i++)r=e[i],a=Math.pow(2,(31&r)-24),t[3*i]=(r>>>23)*a,t[3*i+1]=(r>>>14&511)*a,t[3*i+2]=(r>>>5&511)*a;return t}function a(e,t){for(var r,a,n,i,o,h=e.byteLength/12|0,f=(t=t||new Uint8Array(4*h),0);f<h;f++)r=e[3*f],a=e[3*f+1],n=e[3*f+2],i=Math.max(Math.max(r,a),n)<=.5?-1:1,o=Math.pow(2,i-8),t[4*f]=r/o|0,t[4*f+1]=a/o|0,t[4*f+2]=n/o|0,t[4*f+3]=i+128;return t}function n(e,t){for(var r,a=e.byteLength>>2,n=(t=t||new Float32Array(3*a),0);n<a;n++)r=Math.pow(2,e[4*n+3]-136),t[3*n]=e[4*n]*r,t[3*n+1]=e[4*n+1]*r,t[3*n+2]=e[4*n+2]*r;return t}function i(e,t,r,a){t=Math.pow(2,void 0===t?1:t)/2,void 0===r&&(r=2.2);for(var n,i=1/r,o=e.byteLength>>2,h=(a=a||new Uint8ClampedArray(4*o),0);h<o;h++)n=t*Math.pow(2,e[4*h+3]-136),a[4*h]=255*Math.pow(e[4*h]*n,i),a[4*h+1]=255*Math.pow(e[4*h+1]*n,i),a[4*h+2]=255*Math.pow(e[4*h+2]*n,i),a[4*h+3]=255;return a}return e.floatToRgbe=a,e.rgbeToFloat=n,e.floatToRgb9_e5=t,e.rgb9_e5ToFloat=r,e.rgbeToLDR=i,e.floatToLDR=function(e,t,r,a){t=Math.pow(2,void 0===t?1:t)/2,void 0===r&&(r=2.2);for(var n=1/r,i=e.byteLength/12|0,o=(a=a||new Uint8ClampedArray(4*i),0);o<i;o++)a[4*o]=255*Math.pow(e[3*o]*t,n),a[4*o+1]=255*Math.pow(e[3*o+1]*t,n),a[4*o+2]=255*Math.pow(e[3*o+2]*t,n),a[4*o+3]=255;return a},e}));