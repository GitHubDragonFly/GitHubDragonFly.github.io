var scope,root,bone_id,blobs=null,bones=[],has_bones=!1,has_points_or_lines=!1,isPoints=!1,isLines=!1;THREE.AssimpJSONLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.AssimpJSONLoader.prototype={constructor:THREE.AssimpJSONLoader,texturePath:"",load:function(e,s,t,n,o){scope=this,o&&"string"==typeof o?o.includes(",")?blobs=o.split(","):scope.texturePath=o:scope.texturePath=scope.extractUrlBase(e);var r=new THREE.FileLoader(scope.manager);r.setCrossOrigin(scope.crossOrigin),r.load(e,(function(e){try{var t,o,r=JSON.parse(e)}catch(e){return void n(e)}if(r&&void 0===r.meshes)n("Unsupported file");else{if(void 0!==(o=r.__metadata__)){if("assimp2json"!==o.format)return void n("Not an assimp2json scene");if(o.version<100&&o.version>=200)return void n("Unsupported assimp2json file format version")}(t=scope.parse(r)).has_bones=has_bones,r.animations&&!0===has_bones&&(t.animations=r.animations),s(t)}}),t,n)},setCrossOrigin:function(e){this.crossOrigin=e},extractUrlBase:function(e){let s=e.split("/");return s.pop(),(s.length<1?".":s.join("/"))+"/"},parse:function(e){let s=this.parseMeshList(e,this.parseMesh),t=this.parseMaterialList(e,this.parseMaterial);return this.parseObject(e,e.rootnode,s,t)},parseMeshList:function(e,s){let t=new Array(e.meshes.length);for(let n=0;n<e.meshes.length;n++)t[n]=s.call(this,e.meshes[n],e);return t},parseMaterialList:function(e,s){let t=new Array(e.materials.length);for(let n=0;n<e.materials.length;n++)t[n]=s.call(this,e.materials[n],e.textures);return t},parseMesh:function(e,s){var t,n,o,r,i,a,l,c,p,u;for(t=new THREE.Geometry,1===e.primitivetypes?(isPoints=!0,has_points_or_lines=!0,t.isPoints=!0):2===e.primitivetypes&&(isLines=!0,has_points_or_lines=!0,t.isLines=!0),n=0,r=e.vertices.length;n<r;n+=3)t.vertices.push(new THREE.Vector3(e.vertices[n],e.vertices[n+1],e.vertices[n+2]));for(n=0,r=e.faces.length;n<r;n++)a=new THREE.Face3,l=e.faces[n],a.a=l[0],a.b=!0===isPoints?l[0]:l[1],a.c=!0===isPoints?l[0]:!0===isLines?l[1]:l[2],a.materialIndex=0,t.faces.push(a);for(e.texturecoords=e.texturecoords||[],void 0===t.faceVertexUvs&&(t.faceVertexUvs={}),n=0,r=e.texturecoords.length;n<r;n++){function m(e,s,t){for(o=0,i=s.length;o<i;o++)a=s[o],c=2*a.a,p=2*a.b,u=2*a.c,t.push([new THREE.Vector2(e[c],e[c+1]),new THREE.Vector2(e[p],e[p+1]),new THREE.Vector2(e[u],e[u+1])])}void 0===t.faceVertexUvs[n]&&(t.faceVertexUvs[n]=[]),m(e.texturecoords[n],t.faces,t.faceVertexUvs[n])}if(e.normals){!function(e,s){for(n=0,r=s.length;n<r;n++)a=s[n],c=3*a.a,p=3*a.b,u=3*a.c,a.vertexNormals=[new THREE.Vector3(e[c],e[c+1],e[c+2]),new THREE.Vector3(e[p],e[p+1],e[p+2]),new THREE.Vector3(e[u],e[u+1],e[u+2])]}(e.normals,t.faces)}if(e.colors&&e.colors[0]){!function(e,s){function t(s){let t=new THREE.Color;return t.setRGB(e[s],e[s+1],e[s+2]),t}for(n=0,r=s.length;n<r;n++)a=s[n],c=4*a.a,p=4*a.b,u=4*a.c,a.vertexColors=[t(c),t(p),t(u)]}(e.colors[0],t.faces)}return e.bones&&(this.parseBones(s.rootnode,e.bones),t.bones=bones,has_bones=!0),t.computeFaceNormals(),t.computeVertexNormals(),t.computeBoundingBox(),t.computeBoundingSphere(),isPoints=!1,isLines=!1,t},parseMaterial:function(e,s){scope=this;let t,n,o,r=null,i=[],a={color:16777215,flatShading:!1};function l(e){let s=new THREE.Color;return s.setRGB(e[0],e[1],e[2]),s}function c(){const e=new Uint8Array(65536).fill(255);let s=new THREE.DataTexture(e,128,128);return s.encoding=THREE.sRGBEncoding,s}for(t in e.properties){if(o=e.properties[t],"$tex.file"===o.key?1!==o.semantic&&2!==o.semantic&&4!==o.semantic&&5!==o.semantic&&6!==o.semantic||function(e){var t,n=new THREE.TextureLoader(scope.manager);let a;1===e?t="map":2===e?t="specularMap":4===e?t="emissiveMap":5===e?t="bumpMap":6===e&&(t="normalMap"),i.push(t);let l=o.value;if(!0===o.value.includes("/")?l=l.substring(l.lastIndexOf("/")+1):!0===l.includes("\\")&&(l=l.substring(l.lastIndexOf("\\")+1)),!0===l.includes("*"))try{let e=parseInt(l.substring(l.lastIndexOf("*")+1));s&&s[e]&&s[e].data&&(a="data:image/"+s[e].formathint+";base64,"+s[e].data)}catch(e){}else l.toLowerCase().endsWith(".dds")?THREE.DDSLoader&&(n=new THREE.DDSLoader(scope.manager)):l.toLowerCase().endsWith(".tga")&&THREE.TGALoader&&(n=new THREE.TGALoader(scope.manager));if(n.setCrossOrigin(scope.crossOrigin),null!==blobs)for(j=0,ee=blobs.length;j<ee;j+=2)blobs[j]===l&&(a=blobs[j+1]);else void 0===a&&(a=scope.texturePath+"/"+l);void 0===a||(a=a.replace(/\\/g,"/"),n.load(a,(function(e){e&&(e.wrapS=e.wrapT=THREE.RepeatWrapping,e.encoding=THREE.sRGBEncoding,e.format=THREE.RGBAFormat,r[t]=e,r.needsUpdate=!0)})))}(o.semantic):"?mat.name"===o.key?a.name=o.value:"$clr.diffuse"===o.key?a.color=l(o.value):"$clr.specular"===o.key?a.specular=l(o.value):"$clr.emissive"===o.key?a.emissive=l(o.value):"$mat.shadingm"===o.key?o.value>=1&&(a.flatShading=!0):"$mat.shininess"===o.key&&(a.roughness=o.value>0?1.5*o.value:.4,a.metalness=.6),i.length)for(t=0,n=i.length;t<n;t++)a[i[t]]=c();r=new THREE.MeshStandardMaterial(a)}return r},parseBones:function(e,s){if(s)for(bones.length=0,i=0,il=e.children.length;i<il;i++){root=new THREE.Object3D;let t=new THREE.Vector3,n=new THREE.Quaternion,o=new THREE.Vector3;(new THREE.Matrix4).fromArray(e.children[i].transformation).transpose().decompose(t,n,o),root.position.x=t.x,root.position.y=t.y,root.position.z=t.z,root.quaternion.x=n.x,root.quaternion.y=n.y,root.quaternion.z=n.z,root.quaternion.w=n.w,root.scale.x=o.x,root.scale.y=o.y,root.scale.z=o.z,bone_id=0;let r=-1;this.traverse(e.children[i].children,r,s)}},traverse:function(e,s,t){for(let n=0,o=e.length;n<o;n++){let o=new THREE.Vector3,r=new THREE.Quaternion,i=new THREE.Vector3,a=new THREE.Bone;a.name=e[n].name,a.transformation=e[n].transformation;let l=(new THREE.Matrix4).fromArray(e[n].transformation);l.getInverse(l);t.every((s=>{if(s.name===e[n].name){a.offsetMatrix=s.offsetmatrix,a.weights=s.weights;let e=(new THREE.Matrix4).fromArray(s.offsetmatrix);e.getInverse(e);return l.multiply(e).transpose().decompose(o,r,i),a.position.x=o.x,a.position.y=o.y,a.position.z=o.z,a.quaternion.x=r.x,a.quaternion.y=r.y,a.quaternion.z=r.z,a.quaternion.w=r.w,a.scale.x=i.x,a.scale.y=i.y,a.scale.z=i.z,!1}return!0})),bones.push(a),-1===s?root.add(a):bones[bone_id-s-1].add(a),bone_id+=1,s+=1,e[n].children&&e[n].children.length>0&&this.traverse(e[n].children,n,t)}},parseObject:function(e,s,t,n){let o,r,i=new THREE.Object3D;for(i.name=s.name||"",i.matrix=(new THREE.Matrix4).fromArray(s.transformation).transpose(),i.matrix.decompose(i.position,i.quaternion,i.scale),o=0;s.meshes&&o<s.meshes.length;o++){r=s.meshes[o];let a="Geometry"===t[r].type?(new THREE.BufferGeometry).fromGeometry(t[r]):t[r];bones.length>0&&(a.bones=bones),t[r].isPoints&&!0===t[r].isPoints?i.add(new THREE.Points(a,new THREE.PointsMaterial({size:.02,color:n[e.meshes[r].materialindex].color}))):t[r].isLines&&!0===t[r].isLines?i.add(new THREE.LineSegments(a,new THREE.LineBasicMaterial({color:n[e.meshes[r].materialindex].color,linewidth:.5}))):i.add(new THREE.Mesh(a,n[e.meshes[r].materialindex]))}for(o=0;s.children&&o<s.children.length;o++)i.add(this.parseObject(e,s.children[o],t,n));return i.has_points_or_lines=has_points_or_lines,i}};