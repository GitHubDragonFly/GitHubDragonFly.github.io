var scope,root,bone_id,blobs=null,bones=[],has_bones=!1,has_points_or_lines=!1,isPoints=!1,isLines=!1;THREE.AssimpJSONLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.AssimpJSONLoader.prototype={constructor:THREE.AssimpJSONLoader,texturePath:"",load:function(e,t,s,n,r){scope=this,r&&"string"==typeof r?r.includes(",")?blobs=r.split(","):this.texturePath=r:this.texturePath=this.extractUrlBase(e);var o=new THREE.FileLoader(this.manager);o.setCrossOrigin(this.crossOrigin),o.load(e,(function(e){try{var s,r,o=JSON.parse(e)}catch(e){return void n(e)}if(o&&void 0===o.meshes)n("Unsupported file");else{if(void 0!==(r=o.__metadata__)){if("assimp2json"!==r.format)return void n("Not an assimp2json scene");if(r.version<100&&r.version>=200)return void n("Unsupported assimp2json file format version")}(s=scope.parse(o)).has_bones=has_bones,o.animations&&!0===has_bones&&(s.animations=o.animations),t(s)}}),s,n)},setCrossOrigin:function(e){this.crossOrigin=e},extractUrlBase:function(e){let t=e.split("/");return t.pop(),(t.length<1?".":t.join("/"))+"/"},parse:function(e){let t=this.parseMeshList(e,this.parseMesh),s=this.parseMaterialList(e,this.parseMaterial);return this.parseObject(e,e.rootnode,t,s)},parseMeshList:function(e,t){let s=new Array(e.meshes.length);for(let n=0;n<e.meshes.length;n++)s[n]=t.call(this,e.meshes[n],e);return s},parseMaterialList:function(e,t){let s=new Array(e.materials.length);for(let n=0;n<e.materials.length;n++)s[n]=t.call(this,e.materials[n],e.textures);return s},parseMesh:function(e,t){var s,n,r,o,i,a,l,c,h,u;for(s=new THREE.Geometry,1===e.primitivetypes?(isPoints=!0,has_points_or_lines=!0,s.isPoints=!0):2===e.primitivetypes&&(isLines=!0,has_points_or_lines=!0,s.isLines=!0),n=0,o=e.vertices.length;n<o;n+=3)s.vertices.push(new THREE.Vector3(e.vertices[n],e.vertices[n+1],e.vertices[n+2]));for(n=0,o=e.faces.length;n<o;n++)a=new THREE.Face3,l=e.faces[n],a.a=l[0],a.b=!0===isPoints?l[0]:l[1],a.c=!0===isPoints?l[0]:!0===isLines?l[1]:l[2],a.materialIndex=0,s.faces.push(a);for(e.texturecoords=e.texturecoords||[],void 0===s.faceVertexUvs&&(s.faceVertexUvs={}),n=0,o=e.texturecoords.length;n<o;n++){function f(e,t,s){for(r=0,i=t.length;r<i;r++)a=t[r],c=2*a.a,h=2*a.b,u=2*a.c,s.push([new THREE.Vector2(e[c],e[c+1]),new THREE.Vector2(e[h],e[h+1]),new THREE.Vector2(e[u],e[u+1])])}void 0===s.faceVertexUvs[n]&&(s.faceVertexUvs[n]=[]),f(e.texturecoords[n],s.faces,s.faceVertexUvs[n])}if(e.normals){!function(e,t){for(n=0,o=t.length;n<o;n++)a=t[n],c=3*a.a,h=3*a.b,u=3*a.c,a.vertexNormals=[new THREE.Vector3(e[c],e[c+1],e[c+2]),new THREE.Vector3(e[h],e[h+1],e[h+2]),new THREE.Vector3(e[u],e[u+1],e[u+2])]}(e.normals,s.faces)}if(e.colors&&e.colors[0]){!function(e,t){function s(t){let s=new THREE.Color;return s.setRGB(e[t],e[t+1],e[t+2]),s}for(n=0,o=t.length;n<o;n++)a=t[n],c=4*a.a,h=4*a.b,u=4*a.c,a.vertexColors=[s(c),s(h),s(u)]}(e.colors[0],s.faces)}return e.bones&&(this.parseBones(t.rootnode,e.bones),s.bones=bones,has_bones=!0),s.computeFaceNormals(),s.computeVertexNormals(),s.computeBoundingBox(),s.computeBoundingSphere(),isPoints=!1,isLines=!1,s},parseMaterial:function(t,s){let n,r,o=null,i=this,a=[],l={color:16777215,flatShading:!1};function c(e){let t=new THREE.Color;return t.setRGB(e[0],e[1],e[2]),t}function h(){const e=new Uint8Array(65536),t=new THREE.Color(16777215),s=Math.floor(255*t.r),n=Math.floor(255*t.g),r=Math.floor(255*t.b);for(let t=0;t<16384;t++){const o=4*t;e[o+0]=s,e[o+1]=n,e[o+2]=r,e[o+3]=255}return new THREE.DataTexture(e,128,128)}for(n in t.properties){if(r=t.properties[n],"$tex.file"===r.key?1!==r.semantic&&2!==r.semantic&&4!==r.semantic&&5!==r.semantic&&6!==r.semantic||function(e){var t,n=new THREE.TextureLoader(i.manager);let l;1===e?t="map":2===e?t="specularMap":4===e?t="emissiveMap":5===e?t="bumpMap":6===e&&(t="normalMap"),a.push(t);let c=r.value;if(!0===r.value.includes("/")?c=c.substring(c.lastIndexOf("/")+1):!0===c.includes("\\")&&(c=c.substring(c.lastIndexOf("\\")+1)),!0===c.includes("*"))try{let e=parseInt(c.substring(c.lastIndexOf("*")+1));s&&s[e]&&s[e].data&&(l="data:image/"+s[e].formathint+";base64,"+s[e].data)}catch(e){}else c.toLowerCase().endsWith(".dds")?THREE.DDSLoader&&(n=new THREE.DDSLoader(i.manager)):c.toLowerCase().endsWith(".tga")&&THREE.TGALoader&&(n=new THREE.TGALoader(i.manager));if(n.setCrossOrigin(this.crossOrigin),null!==blobs)for(j=0,ee=blobs.length;j<ee;j+=2)blobs[j]===c&&(l=blobs[j+1]);else void 0===l&&(l=i.texturePath+"/"+c);void 0===l||(l=l.replace(/\\/g,"/"),n.load(l,(function(e){e&&(e.wrapS=e.wrapT=THREE.RepeatWrapping,o[t]=e,o.needsUpdate=!0)})))}(r.semantic):"?mat.name"===r.key?l.name=r.value:"$clr.diffuse"===r.key?l.color=c(r.value):"$clr.specular"===r.key?l.specular=c(r.value):"$clr.emissive"===r.key?l.emissive=c(r.value):"$mat.shadingm"===r.key?r.value>=1&&(l.flatShading=!0):"$mat.shininess"===r.key&&(l.shininess=r.value),a.length)for(n=0,e=a.length;n<e;n++)l[a[n]]=h();o=new THREE.MeshPhongMaterial(l)}return o},parseBones:function(e,t){if(t)for(bones.length=0,i=0,il=e.children.length;i<il;i++){root=new THREE.Object3D;let s=new THREE.Vector3,n=new THREE.Quaternion,r=new THREE.Vector3;(new THREE.Matrix4).fromArray(e.children[i].transformation).transpose().decompose(s,n,r),root.position.x=s.x,root.position.y=s.y,root.position.z=s.z,root.quaternion.x=n.x,root.quaternion.y=n.y,root.quaternion.z=n.z,root.quaternion.w=n.w,root.scale.x=r.x,root.scale.y=r.y,root.scale.z=r.z,bone_id=0;let o=-1;this.traverse(e.children[i].children,o,t)}},traverse:function(e,t,s){for(let n=0,r=e.length;n<r;n++){let r=new THREE.Vector3,o=new THREE.Quaternion,i=new THREE.Vector3,a=new THREE.Bone;a.name=e[n].name,a.transformation=e[n].transformation;let l=(new THREE.Matrix4).fromArray(e[n].transformation);l.getInverse(l);s.every((t=>{if(t.name===e[n].name){a.offsetMatrix=t.offsetmatrix,a.weights=t.weights;let e=(new THREE.Matrix4).fromArray(t.offsetmatrix);e.getInverse(e);return l.multiply(e).transpose().decompose(r,o,i),a.position.x=r.x,a.position.y=r.y,a.position.z=r.z,a.quaternion.x=o.x,a.quaternion.y=o.y,a.quaternion.z=o.z,a.quaternion.w=o.w,a.scale.x=i.x,a.scale.y=i.y,a.scale.z=i.z,!1}return!0})),bones.push(a),-1===t?root.add(a):bones[bone_id-t-1].add(a),bone_id+=1,t+=1,e[n].children&&e[n].children.length>0&&this.traverse(e[n].children,n,s)}},parseObject:function(e,t,s,n){let r,o,i=new THREE.Object3D;for(i.name=t.name||"",i.matrix=(new THREE.Matrix4).fromArray(t.transformation).transpose(),i.matrix.decompose(i.position,i.quaternion,i.scale),r=0;t.meshes&&r<t.meshes.length;r++){o=t.meshes[r];let a="Geometry"===s[o].type?(new THREE.BufferGeometry).fromGeometry(s[o]):s[o];bones.length>0&&(a.bones=bones),s[o].isPoints&&!0===s[o].isPoints?i.add(new THREE.Points(a,new THREE.PointsMaterial({size:.02,color:n[e.meshes[o].materialindex].color}))):s[o].isLines&&!0===s[o].isLines?i.add(new THREE.LineSegments(a,new THREE.LineBasicMaterial({color:n[e.meshes[o].materialindex].color,linewidth:.5}))):i.add(new THREE.Mesh(a,n[e.meshes[o].materialindex]))}for(r=0;t.children&&r<t.children.length;r++)i.add(this.parseObject(e,t.children[r],s,n));return i.has_points_or_lines=has_points_or_lines,i}};