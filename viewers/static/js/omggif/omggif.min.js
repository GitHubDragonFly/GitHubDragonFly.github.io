"use strict";function GifWriter(buf,width,height,gopts){var p=0,gopts,loop_count=void 0===(gopts=void 0===gopts?{}:gopts).loop?null:gopts.loop,global_palette=void 0===gopts.palette?null:gopts.palette;if(width<=0||height<=0||width>65535||height>65535)throw new Error("Width/Height invalid.");function check_palette_and_num_colors(palette){var num_colors=palette.length;if(num_colors<2||num_colors>256||num_colors&num_colors-1)throw new Error("Invalid code/color length, must be power of 2 and 2 .. 256.");return num_colors}buf[p++]=71,buf[p++]=73,buf[p++]=70,buf[p++]=56,buf[p++]=57,buf[p++]=97;var gp_num_colors_pow2=0,background=0;if(null!==global_palette){for(var gp_num_colors=check_palette_and_num_colors(global_palette);gp_num_colors>>=1;)++gp_num_colors_pow2;if(gp_num_colors=1<<gp_num_colors_pow2,--gp_num_colors_pow2,void 0!==gopts.background){if((background=gopts.background)>=gp_num_colors)throw new Error("Background index out of range.");if(0===background)throw new Error("Background index explicitly passed as 0.")}}if(buf[p++]=255&width,buf[p++]=width>>8&255,buf[p++]=255&height,buf[p++]=height>>8&255,buf[p++]=(null!==global_palette?128:0)|gp_num_colors_pow2,buf[p++]=background,buf[p++]=0,null!==global_palette)for(var i=0,il=global_palette.length;i<il;++i){var rgb=global_palette[i];buf[p++]=rgb>>16&255,buf[p++]=rgb>>8&255,buf[p++]=255&rgb}if(null!==loop_count){if(loop_count<0||loop_count>65535)throw new Error("Loop count invalid.");buf[p++]=33,buf[p++]=255,buf[p++]=11,buf[p++]=78,buf[p++]=69,buf[p++]=84,buf[p++]=83,buf[p++]=67,buf[p++]=65,buf[p++]=80,buf[p++]=69,buf[p++]=50,buf[p++]=46,buf[p++]=48,buf[p++]=3,buf[p++]=1,buf[p++]=255&loop_count,buf[p++]=loop_count>>8&255,buf[p++]=0}var ended=!1;this.addFrame=function(x,y,w,h,indexed_pixels,opts){if(!0===ended&&(--p,ended=!1),opts=void 0===opts?{}:opts,x<0||y<0||x>65535||y>65535)throw new Error("x/y invalid.");if(w<=0||h<=0||w>65535||h>65535)throw new Error("Width/Height invalid.");if(indexed_pixels.length<w*h)throw new Error("Not enough pixels for the frame size.");var using_local_palette=!0,palette=opts.palette;if(null==palette&&(using_local_palette=!1,palette=global_palette),null==palette)throw new Error("Must supply either a local or global palette.");for(var num_colors=check_palette_and_num_colors(palette),min_code_size=0;num_colors>>=1;)++min_code_size;num_colors=1<<min_code_size;var delay=void 0===opts.delay?0:opts.delay,disposal=void 0===opts.disposal?0:opts.disposal;if(disposal<0||disposal>3)throw new Error("Disposal out of range.");var use_transparency=!1,transparent_index=0;if(void 0!==opts.transparent&&null!==opts.transparent&&(use_transparency=!0,(transparent_index=opts.transparent)<0||transparent_index>=num_colors))throw new Error("Transparent color index.");if((0!==disposal||use_transparency||0!==delay)&&(buf[p++]=33,buf[p++]=249,buf[p++]=4,buf[p++]=disposal<<2|(!0===use_transparency?1:0),buf[p++]=255&delay,buf[p++]=delay>>8&255,buf[p++]=transparent_index,buf[p++]=0),buf[p++]=44,buf[p++]=255&x,buf[p++]=x>>8&255,buf[p++]=255&y,buf[p++]=y>>8&255,buf[p++]=255&w,buf[p++]=w>>8&255,buf[p++]=255&h,buf[p++]=h>>8&255,buf[p++]=!0===using_local_palette?128|min_code_size-1:0,!0===using_local_palette)for(var i=0,il=palette.length;i<il;++i){var rgb=palette[i];buf[p++]=rgb>>16&255,buf[p++]=rgb>>8&255,buf[p++]=255&rgb}return p=GifWriterOutputLZWCodeStream(buf,p,min_code_size<2?2:min_code_size,indexed_pixels)},this.end=function(){return!1===ended&&(buf[p++]=59,ended=!0),p},this.getOutputBuffer=function(){return buf},this.setOutputBuffer=function(v){buf=v},this.getOutputBufferPosition=function(){return p},this.setOutputBufferPosition=function(v){p=v}}function GifWriterOutputLZWCodeStream(buf,p,min_code_size,index_stream){buf[p++]=min_code_size;var cur_subblock=p++,clear_code=1<<min_code_size,code_mask=clear_code-1,eoi_code=clear_code+1,next_code=eoi_code+1,cur_code_size=min_code_size+1,cur_shift=0,cur=0;function emit_bytes_to_buffer(bit_block_size){for(;cur_shift>=bit_block_size;)buf[p++]=255&cur,cur>>=8,cur_shift-=8,p===cur_subblock+256&&(buf[cur_subblock]=255,cur_subblock=p++)}function emit_code(c){cur|=c<<cur_shift,cur_shift+=cur_code_size,emit_bytes_to_buffer(8)}var ib_code=index_stream[0]&code_mask,code_table={};emit_code(clear_code);for(var i=1,il=index_stream.length;i<il;++i){var k=index_stream[i]&code_mask,cur_key=ib_code<<8|k,cur_code=code_table[cur_key];if(void 0===cur_code){for(cur|=ib_code<<cur_shift,cur_shift+=cur_code_size;cur_shift>=8;)buf[p++]=255&cur,cur>>=8,cur_shift-=8,p===cur_subblock+256&&(buf[cur_subblock]=255,cur_subblock=p++);4096===next_code?(emit_code(clear_code),next_code=eoi_code+1,cur_code_size=min_code_size+1,code_table={}):(next_code>=1<<cur_code_size&&++cur_code_size,code_table[cur_key]=next_code++),ib_code=k}else ib_code=cur_code}return emit_code(ib_code),emit_code(eoi_code),emit_bytes_to_buffer(1),cur_subblock+1===p?buf[cur_subblock]=0:(buf[cur_subblock]=p-cur_subblock-1,buf[p++]=0),p}function GifReader(buf){var p=0;if(71!==buf[p++]||73!==buf[p++]||70!==buf[p++]||56!==buf[p++]||56!=(buf[p++]+1&253)||97!==buf[p++])throw new Error("Invalid GIF 87a/89a header.");var width=buf[p++]|buf[p++]<<8,height=buf[p++]|buf[p++]<<8,pf0=buf[p++],global_palette_flag=pf0>>7,num_global_colors_pow2,num_global_colors=1<<(7&pf0)+1,background=buf[p++];buf[p++];var global_palette_offset=null,global_palette_size=null;global_palette_flag&&(global_palette_offset=p,global_palette_size=num_global_colors,p+=3*num_global_colors);var no_eof=!0,frames=[],delay=0,transparent_index=null,disposal=0,loop_count=null;for(this.width=width,this.height=height;no_eof&&p<buf.length;)switch(buf[p++]){case 33:switch(buf[p++]){case 255:if(11!==buf[p]||78==buf[p+1]&&69==buf[p+2]&&84==buf[p+3]&&83==buf[p+4]&&67==buf[p+5]&&65==buf[p+6]&&80==buf[p+7]&&69==buf[p+8]&&50==buf[p+9]&&46==buf[p+10]&&48==buf[p+11]&&3==buf[p+12]&&1==buf[p+13]&&0==buf[p+16])p+=14,loop_count=buf[p++]|buf[p++]<<8,p++;else for(p+=12;;){var block_size;if(!((block_size=buf[p++])>=0))throw Error("Invalid block size");if(0===block_size)break;p+=block_size}break;case 249:if(4!==buf[p++]||0!==buf[p+4])throw new Error("Invalid graphics extension block.");var pf1=buf[p++];delay=buf[p++]|buf[p++]<<8,transparent_index=buf[p++],0==(1&pf1)&&(transparent_index=null),disposal=pf1>>2&7,p++;break;case 1:case 254:for(;;){var block_size;if(!((block_size=buf[p++])>=0))throw Error("Invalid block size");if(0===block_size)break;p+=block_size}break;default:throw new Error("Unknown graphic control label: 0x"+buf[p-1].toString(16))}break;case 44:var x=buf[p++]|buf[p++]<<8,y=buf[p++]|buf[p++]<<8,w=buf[p++]|buf[p++]<<8,h=buf[p++]|buf[p++]<<8,pf2=buf[p++],local_palette_flag,interlace_flag=pf2>>6&1,num_local_colors_pow2,num_local_colors=1<<(7&pf2)+1,palette_offset=global_palette_offset,palette_size=global_palette_size,has_local_palette=!1;if(pf2>>7){var has_local_palette=!0;palette_offset=p,palette_size=num_local_colors,p+=3*num_local_colors}var data_offset=p;for(p++;;){var block_size;if(!((block_size=buf[p++])>=0))throw Error("Invalid block size");if(0===block_size)break;p+=block_size}frames.push({x:x,y:y,width:w,height:h,has_local_palette:has_local_palette,palette_offset:palette_offset,palette_size:palette_size,data_offset:data_offset,data_length:p-data_offset,transparent_index:transparent_index,interlaced:!!interlace_flag,delay:delay,disposal:disposal});break;case 59:no_eof=!1;break;default:throw new Error("Unknown gif block: 0x"+buf[p-1].toString(16))}this.numFrames=function(){return frames.length},this.loopCount=function(){return loop_count},this.frameInfo=function(frame_num){if(frame_num<0||frame_num>=frames.length)throw new Error("Frame index out of range.");return frames[frame_num]},this.decodeAndBlitFrameBGRA=function(frame_num,pixels){var frame=this.frameInfo(frame_num),num_pixels=frame.width*frame.height,index_stream=new Uint8Array(num_pixels);GifReaderLZWOutputIndexStream(buf,frame.data_offset,index_stream,num_pixels);var palette_offset=frame.palette_offset,trans=frame.transparent_index;null===trans&&(trans=256);var framewidth=frame.width,framestride=width-framewidth,xleft=framewidth,opbeg=4*(frame.y*width+frame.x),opend=4*((frame.y+frame.height)*width+frame.x),op=opbeg,scanstride=4*framestride;!0===frame.interlaced&&(scanstride+=4*width*7);for(var interlaceskip=8,i=0,il=index_stream.length;i<il;++i){var index=index_stream[i];if(0===xleft&&(xleft=framewidth,(op+=scanstride)>=opend&&(scanstride=4*framestride+4*width*(interlaceskip-1),op=opbeg+(framewidth+framestride)*(interlaceskip<<1),interlaceskip>>=1)),index===trans)op+=4;else{var r=buf[palette_offset+3*index],g=buf[palette_offset+3*index+1],b=buf[palette_offset+3*index+2];pixels[op++]=b,pixels[op++]=g,pixels[op++]=r,pixels[op++]=255}--xleft}},this.decodeAndBlitFrameRGBA=function(frame_num,pixels){var frame=this.frameInfo(frame_num),num_pixels=frame.width*frame.height,index_stream=new Uint8Array(num_pixels);GifReaderLZWOutputIndexStream(buf,frame.data_offset,index_stream,num_pixels);var palette_offset=frame.palette_offset,trans=frame.transparent_index;null===trans&&(trans=256);var framewidth=frame.width,framestride=width-framewidth,xleft=framewidth,opbeg=4*(frame.y*width+frame.x),opend=4*((frame.y+frame.height)*width+frame.x),op=opbeg,scanstride=4*framestride;!0===frame.interlaced&&(scanstride+=4*width*7);for(var interlaceskip=8,i=0,il=index_stream.length;i<il;++i){var index=index_stream[i];if(0===xleft&&(xleft=framewidth,(op+=scanstride)>=opend&&(scanstride=4*framestride+4*width*(interlaceskip-1),op=opbeg+(framewidth+framestride)*(interlaceskip<<1),interlaceskip>>=1)),index===trans)op+=4;else{var r=buf[palette_offset+3*index],g=buf[palette_offset+3*index+1],b=buf[palette_offset+3*index+2];pixels[op++]=r,pixels[op++]=g,pixels[op++]=b,pixels[op++]=255}--xleft}}}function GifReaderLZWOutputIndexStream(code_stream,p,output,output_length){for(var min_code_size=code_stream[p++],clear_code=1<<min_code_size,eoi_code=clear_code+1,next_code=eoi_code+1,cur_code_size=min_code_size+1,code_mask=(1<<cur_code_size)-1,cur_shift=0,cur=0,op=0,subblock_size=code_stream[p++],code_table=new Int32Array(4096),prev_code=null;;){for(;cur_shift<16&&0!==subblock_size;)cur|=code_stream[p++]<<cur_shift,cur_shift+=8,1===subblock_size?subblock_size=code_stream[p++]:--subblock_size;if(cur_shift<cur_code_size)break;var code=cur&code_mask;if(cur>>=cur_code_size,cur_shift-=cur_code_size,code!==clear_code){if(code===eoi_code)break;for(var chase_code=code<next_code?code:prev_code,chase_length=0,chase=chase_code;chase>clear_code;)chase=code_table[chase]>>8,++chase_length;var k=chase,op_end;if(op+chase_length+(chase_code!==code?1:0)>output_length)return void console.log("Warning, gif stream longer than expected.");output[op++]=k;var b=op+=chase_length;for(chase_code!==code&&(output[op++]=k),chase=chase_code;chase_length--;)chase=code_table[chase],output[--b]=255&chase,chase>>=8;null!==prev_code&&next_code<4096&&(code_table[next_code++]=prev_code<<8|k,next_code>=code_mask+1&&cur_code_size<12&&(++cur_code_size,code_mask=code_mask<<1|1)),prev_code=code}else next_code=eoi_code+1,code_mask=(1<<(cur_code_size=min_code_size+1))-1,prev_code=null}return op!==output_length&&console.log("Warning, gif stream shorter than expected."),output}try{exports.GifWriter=GifWriter,exports.GifReader=GifReader}catch(e){}