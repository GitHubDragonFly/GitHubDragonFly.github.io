const scale=new THREE.Vector3(1,1,1),mesh_id_keys={};function dotbim_CreateMeshes(dotbim){if(void 0===dotbim)return void console.log("No BIM model provided!");if("string"!=typeof dotbim)return console.log("Unknown file format!"),[];dotbim=JSON.parse(dotbim);const{schema_version:schema_version,meshes:meshes,elements:elements,info:info}=dotbim;if(!meshes||!elements)return console.log("No meshes or elements found!"),[];info.Instanced&&elements.forEach(element=>{mesh_id_keys[element.mesh_id]?mesh_id_keys[element.mesh_id].instance_count++:mesh_id_keys[element.mesh_id]={mesh_id:element.mesh_id,instance_count:1,current_instance:0,mesh:null}});let geometrys=dotbim_Meshes2Geometrys(meshes);const bim_meshes=new THREE.Group,bim_edges=new THREE.Group;return dotbim_Elemments2Meshes(elements,geometrys).forEach(bim_mesh=>{bim_mesh.geometry.computeBoundingBox(),bim_mesh.geometry.computeBoundingSphere(),bim_mesh.name="mesh_"+bim_mesh.id,bim_meshes.add(bim_mesh),bim_mesh.edges&&bim_edges.add(bim_mesh.edges)}),bim_meshes.children.length>1&&bim_meshes.rotateX(-Math.PI/2),bim_edges.children.length>0&&(bim_meshes.userData.edges=bim_edges),bim_meshes}function dotbim_Elemments2Meshes(elements,geometrys){return elements.map(element=>dotbim_Elemment2Mesh(element,geometrys))}function dotbim_Elemment2Mesh(element,geometrys){let{mesh_id:mesh_id,vector:vector,rotation:rotation,guid:guid,type:type,color:color,face_colors:face_colors,info:info}=element,geometry=geometrys[mesh_id].clone();geometry.computeVertexNormals();let material=new THREE.MeshPhongMaterial({side:THREE.DoubleSide,flatShading:!1,transparent:!0,color:13421772}),mesh;if(color&&0===color.r&&0===color.g&&0===color.b&&0===color.a&&(color=null),face_colors){let colors=createFaceColors(face_colors);geometry.setAttribute("color",new THREE.Float32BufferAttribute(colors,4))}else color&&(geometry.deleteAttribute("color"),material.color=convertTHREEColorRGB(color.r,color.g,color.b),material.opacity=convertColorAlpha(color.a),material.transparent=material.opacity<1,material.needsUpdate=!0);if(geometry.getAttribute("color")&&(material.color=void 0,material.opacity=1,material.transparent=!0,material.vertexColors=!0),vector||(vector={x:0,y:0,z:0}),rotation||(rotation={qx:0,qy:0,qz:0,qw:1}),mesh_id_keys[mesh_id]&&mesh_id_keys[mesh_id].instance_count>1){null===mesh_id_keys[mesh_id].mesh&&(mesh_id_keys[mesh_id].mesh=new THREE.InstancedMesh(geometry,material,mesh_id_keys[mesh_id].instance_count));let pos=new THREE.Vector3(vector.x,vector.y,vector.z),rotq=new THREE.Quaternion(rotation.qx,rotation.qy,rotation.qz,rotation.qw),matrix=(new THREE.Matrix4).compose(pos,rotq,scale);return mesh_id_keys[mesh_id].mesh.setMatrixAt(mesh_id_keys[mesh_id].current_instance,matrix),mesh_id_keys[mesh_id].mesh.instanceMatrix.needsUpdate=!0,material.color&&(mesh_id_keys[mesh_id].mesh.setColorAt(mesh_id_keys[mesh_id].current_instance,material.color),mesh_id_keys[mesh_id].mesh.instanceColor.needsUpdate=!0),mesh_id_keys[mesh_id].current_instance++,mesh_id_keys[mesh_id].mesh}{mesh=new THREE.Mesh(geometry,material),mesh.position.set(vector.x,vector.y,vector.z),mesh.quaternion.set(rotation.qx,rotation.qy,rotation.qz,rotation.qw);let innerGeometry=new THREE.BufferGeometry;innerGeometry.setAttribute("position",mesh.geometry.attributes.position);let innerEdgesGeometry=new THREE.EdgesGeometry(innerGeometry,30),outline_material=new THREE.LineBasicMaterial({color:16711680}),edges=new THREE.LineSegments(innerEdgesGeometry,outline_material);return edges.position.set(vector.x,vector.y,vector.z),edges.quaternion.set(rotation.qx,rotation.qy,rotation.qz,rotation.qw),mesh.edges=edges,mesh}}function dotbim_Meshes2Geometrys(meshes){return meshes.map(mesh=>dotbim_Mesh2GeometryColor(mesh))}function dotbim_Mesh2GeometryColor(mesh){const{mesh_id:mesh_id,coordinates:coordinates,indices:indices,colors:colors}=mesh;let geometry=new THREE.BufferGeometry;return geometry.setIndex(indices),geometry.setAttribute("position",new THREE.Float32BufferAttribute(coordinates,3)),geometry=geometry.toNonIndexed(),colors&&(buffer_colors=createFaceColors(colors,3,4*indices.length),geometry.setAttribute("color",new THREE.Float32BufferAttribute(buffer_colors,4))),geometry.computeVertexNormals(),geometry}function createFaceColors(color4arrary,repeat=3,max=0){let colors=[];for(let index=0;index<color4arrary.length;index+=4){let c1=color4arrary[index+0],c2=color4arrary[index+1],c3=color4arrary[index+2],c4=convertColorAlpha(color4arrary[index+3]);var color=convertTHREEColorRGB(c1,c2,c3);for(let i=0;i<repeat;i++)colors.push(color.r,color.g,color.b,c4)}for(;colors.length<max;)for(let i=0;i<repeat;i++)colors.push(colors[0],colors[1],colors[2],colors[3]);return colors}function convertTHREEColorRGB(r,g,b){return new THREE.Color(r/255,g/255,b/255)}function convertColorAlpha(alpha){return alpha/255}