import{BufferGeometry,Color,DoubleSide,FileLoader,Float32BufferAttribute,Group,InstancedMesh,Loader,Matrix4,MeshStandardMaterial,Quaternion,Vector3}from"three";import{mergeVertices}from"https://cdn.jsdelivr.net/npm/three@0.163.0/examples/jsm/utils/BufferGeometryUtils.min.js";class BIMLoader extends Loader{constructor(e){super(e)}load(e,t,r,o){const n=this,s=new FileLoader(n.manager);s.setPath(n.path),s.setResponseType("text"),s.setRequestHeader(n.requestHeader),s.setWithCredentials(n.withCredentials),s.load(e,(function(r){try{t(n.parse(r))}catch(t){o&&o(t),n.manager.itemError(e)}}),r,o)}parse(e){const t={},r=new Group,o=new Vector3(1,1,1);function n(e,r){return e.map((e=>function(e,r){let n,{mesh_id:s,vector:c,rotation:i,guid:l,type:u,color:d,face_colors:f,info:m}=e;if(r[s])n=r[s].clone();else{for(const e of r)if(e.userData.mesh_id===s){n=e.clone();break}if(!n)throw new Error("THREE.BIMLoader: Geometry not found!")}let h=m&&m.Name?m.Name:"";n.computeVertexNormals();let _,p=new MeshStandardMaterial({name:m&&m.Material?m.Material:"__DEFAULT",side:DoubleSide,flatShading:!1,transparent:!0,metalness:.4,roughness:.6,color:16777215});d&&0===d.r&&0===d.g&&0===d.b&&0===d.a&&(d=null);if(f&&f.length>0){n.index&&(n=n.toNonIndexed()),n.hasAttribute("color")&&n.deleteAttribute("color");const e=a(f,3,4*n.attributes.position.count);n.setAttribute("color",new Float32BufferAttribute(e,4)),p.color.setRGB(1,1,1),p.opacity=1,p.transparent=!0,p.vertexColors=!0}else d&&(p.color=new Color(d.r/255,d.g/255,d.b/255),p.opacity=d.a/255,p.transparent=p.opacity<1);c||(c={x:0,y:0,z:0});i||(i={qx:0,qy:0,qz:0,qw:1});if(f&&t[s].face_colors_group[f]){let e=t[s].face_colors_group[f];null===e.mesh&&(e.mesh=new InstancedMesh(n,p,e.instance_count)),_=e.mesh;let r=new Vector3(c.x,c.y,c.z),a=new Quaternion(i.qx,i.qy,i.qz,i.qw),d=(new Matrix4).compose(r,a,o);_.setMatrixAt(e.current_instance,d),_.instanceMatrix.needsUpdate=!0,""===h&&(h="mesh_"+s+"_"+_.id+"_"+e.current_instance),_.userData[e.current_instance]={name:h,guid:l,type:u,info:m||{}},e.current_instance++}else{if(!d)return;let e=[d.r,d.g,d.b,d.a],r=t[s].color_group[e];null===r.mesh&&(r.mesh=new InstancedMesh(n,p,r.instance_count)),_=r.mesh;let a=new Vector3(c.x,c.y,c.z),f=new Quaternion(i.qx,i.qy,i.qz,i.qw),w=(new Matrix4).compose(a,f,o);_.setMatrixAt(r.current_instance,w),_.instanceMatrix.needsUpdate=!0,_.setColorAt(r.current_instance,p.color),_.instanceColor.needsUpdate=!0,""===h&&(h="mesh_"+s+"_"+_.id+"_"+r.current_instance),_.userData[r.current_instance]={name:h,guid:l,type:u,info:m||{}},r.current_instance++}return _}(e,r)))}function s(e){return e.map((e=>function(e){const{mesh_id:t,coordinates:r,indices:o,colors:n}=e;let s=new BufferGeometry;if(s.setAttribute("position",new Float32BufferAttribute(r,3)),s.computeVertexNormals(),n&&n.length>0){const e=a(n,3,4*s.attributes.position.count);s.setAttribute("color",new Float32BufferAttribute(e,4))}else o?s.setIndex(o):s=mergeVertices(s);return s.userData.mesh_id=t,s}(e)))}function a(e,t=3,r=0){let o=[];for(let r=0,n=e.length;r<n;r+=4){let n=e[r+0]/255,s=e[r+1]/255,a=e[r+2]/255,c=e[r+3]/255;for(let e=0;e<t;e++)o.push(n,s,a,c)}for(;o.length<r;)for(let e=0;e<t;e++)o.push(o[0],o[1],o[2],o[3]);return o}return function(e){if("string"!=typeof e)throw new Error("THREE.BIMLoader: Unknown format!");e=JSON.parse(e);const{schema_version:o,meshes:a,elements:c,info:i}=e;if(r.userData.schema_version=o||{},r.userData.info=i||{},i.Name&&""!==i.Name&&(r.name=i.Name),!a||!c)throw new Error("THREE.BIMLoader: No meshes or elements found!");for(const e of c)if(t[e.mesh_id]||(t[e.mesh_id]={face_colors_group:{},color_group:{}}),e.face_colors){let r=t[e.mesh_id].face_colors_group[e.face_colors];r?r.instance_count++:t[e.mesh_id].face_colors_group[e.face_colors]={instance_count:1,current_instance:0,mesh:null}}else{if(!e.color)continue;let r=[e.color.r,e.color.g,e.color.b,e.color.a],o=t[e.mesh_id].color_group[r];o?o.instance_count++:t[e.mesh_id].color_group[r]={instance_count:1,current_instance:0,mesh:null}}if(n(c,s(a)).forEach((e=>{e&&r.add(e)})),0===r.children.length)throw new Error("THREE.BIMLoader: No meshes found!");return r.children.length>1&&r.rotateX(-Math.PI/2),r}(e)}}export{BIMLoader};